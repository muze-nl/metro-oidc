{
  "version": 3,
  "sources": ["../node_modules/@muze-nl/metro/src/metro.mjs", "../node_modules/@muze-nl/metro/src/mw/json.mjs", "../node_modules/@muze-nl/metro/src/mw/thrower.mjs", "../node_modules/@muze-nl/metro/src/everything.mjs", "../node_modules/@muze-nl/assert/src/assert.mjs", "../src/oidc.util.mjs", "../src/oidc.discovery.mjs", "../src/oidc.register.mjs", "../node_modules/@muze-nl/metro-oauth2/node_modules/@muze-nl/assert/src/assert.mjs", "../node_modules/@muze-nl/metro-oauth2/src/tokenstore.mjs", "../node_modules/@muze-nl/metro-oauth2/src/oauth2.mjs", "../src/oidc.store.mjs", "../src/oidcmw.mjs", "../src/browser.mjs"],
  "sourcesContent": ["/**\n * base URL used to link to more information about an error message\n */\nconst metroURL = 'https://metro.muze.nl/details/'\n\n/**\n * Symbols:\n * - isProxy: used to test if an object is a metro Proxy to another object\n * - source: used to return the actual source (target) of a metro Proxy\n */\nif (!Symbol.metroProxy) {\n\tSymbol.metroProxy = Symbol('isProxy')\n}\nif (!Symbol.metroSource) {\n\tSymbol.metroSource = Symbol('source')\n}\n\n/**\n * Metro HTTP Client with middleware support\n * @method get\n * @method post\n * @method put\n * @method delete\n * @method patch\n * @method head\n * @method options\n * @method query\n */\nclass Client\n{\n\t#options = {\n\t\turl: typeof window != 'undefined' ? window.location : 'https://localhost'\n\t}\n\t#verbs = ['get','post','put','delete','patch','head','options','query']\n\n\tstatic tracers = {}\n\n\t/**\n\t * @typedef {Object} ClientOptions\n\t * @property {Array} middlewares - list of middleware functions\n\t * @property {string|URL} url - default url of the client\n\t * @property {[string]} verbs - a list of verb methods to expose, e.g. ['get','post']\n\t * \n\t * Constructs a new metro client. Can have any number of params.\n\t * @params {ClientOptions|URL|Function|Client}\n\t * @returns {Client} - A metro client object with given or default verb methods\n\t */\n\tconstructor(...options)\n\t{\n\t\tfor (let option of options) {\n\t\t\tif (typeof option == 'string' || option instanceof String) {\n\t\t\t\tthis.#options.url = ''+option\n\t\t\t} else if (option instanceof Client) {\n\t\t\t\tObject.assign(this.#options, option.#options)\n\t\t\t} else if (option instanceof Function) {\n\t\t\t\tthis.#addMiddlewares([option])\n\t\t\t} else if (option && typeof option == 'object') {\n\t\t\t\tfor (let param in option) {\n\t\t\t\t\tif (param == 'middlewares') {\n\t\t\t\t\t\tthis.#addMiddlewares(option[param])\n\t\t\t\t\t} else if (typeof option[param] == 'function') {\n\t\t\t\t\t\tthis.#options[param] = option[param](this.#options[param], this.#options)\n\t\t\t\t\t} else {\n\t\t\t\t\t\tthis.#options[param] = option[param]\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tif (this.#options.verbs) {\n\t\t\tthis.#verbs = this.#options.verbs\n\t\t\tdelete this.#options.verbs\n\t\t}\n\n\t\tfor (const verb of this.#verbs) {\n\t\t\tthis[verb] = async function(...options) {\n\t\t\t\treturn this.fetch(request(\n\t\t\t\t\tthis.#options,\n\t\t\t\t\t...options,\n\t\t\t\t\t{method: verb.toUpperCase()}\n\t\t\t\t))\n\t\t\t}\n\t\t}\n\t\tObject.freeze(this)\n\t}\n\n\t#addMiddlewares(middlewares)\n\t{\n\t\tif (typeof middlewares == 'function') {\n\t\t\tmiddlewares = [ middlewares ]\n\t\t}\n\t\tlet index = middlewares.findIndex(m => typeof m != 'function')\n\t\tif (index>=0) {\n\t\t\tthrow metroError('metro.client: middlewares must be a function or an array of functions '\n\t\t\t\t+metroURL+'client/invalid-middlewares-value/', middlewares[index])\n\t\t}\n\t\tif (!Array.isArray(this.#options.middlewares)) {\n\t\t\tthis.#options.middlewares = []\n\t\t}\n\t\tthis.#options.middlewares = this.#options.middlewares.concat(middlewares)\n\t}\n\n\t/**\n\t * Mimics the standard browser fetch method, but uses any middleware installed through\n\t * the constructor.\n\t * @param {Request|string|Object} - Required. The URL or Request object, accepts all types that are accepted by metro.request\n\t * @param {Object} - Optional. Any object that is accepted by metro.request\n\t * @return {Promise<Response|*>} - The metro.response to this request, or any other result as changed by any included middleware.\n\t */\n\tfetch(req, options)\n\t{\n\t\treq = request(req, options)\n\t\tif (!req.url) {\n\t\t\tthrow metroError('metro.client.'+req.method.toLowerCase()+': Missing url parameter '+metroURL+'client/missing-url-param/', req)\n\t\t}\n\t\tif (!options) {\n\t\t\toptions = {}\n\t\t}\n\t\tif (!(typeof options === 'object') \n\t\t\t|| Array.isArray(options)\n\t\t\t|| options instanceof String) \n\t\t{\n\t\t\tthrow metroError('metro.client.fetch: Options is not an object')\n\t\t}\n\n\t\tconst metrofetch = async function browserFetch(req)\n\t\t{\n\t\t\tif (req[Symbol.metroProxy]) {\n\t\t\t\t// even though a Proxy is supposed to be 'invisible'\n\t\t\t\t// fetch() doesn't work with the proxy (in Firefox), \n\t\t\t\t// you need the actual Request object here\n\t\t\t\t// and the actual body if you use e.g. FormData\n\t\t\t\tif (req.body && req.body[Symbol.metroSource]) {\n\t\t\t\t\tlet body = req.body[Symbol.metroSource]\n\t\t\t\t\treq = new Request(req[Symbol.metroSource], { body })\n\t\t\t\t} else {\n\t\t\t\t\treq = req[Symbol.metroSource]\n\t\t\t\t}\n\t\t\t}\n\t\t\tconst res = await fetch(req)\n\t\t\treturn response(res)\n\t\t}\n\t\t\n\t\tlet middlewares = [metrofetch].concat(this.#options?.middlewares?.slice() || [])\n\t\toptions = Object.assign({}, this.#options, options)\n\t\t//@TODO: do this once in constructor?\n\t\tlet next\n\t\tfor (let middleware of middlewares) {\n\t\t\tnext = (function(next, middleware) {\n\t\t\t\treturn async function(req) {\n\t\t\t\t\tlet res\n\t\t\t\t\tlet tracers = Object.values(Client.tracers)\n\t\t\t\t\tfor(let tracer of tracers) {\n\t\t\t\t\t\tif (tracer.request) {\n\t\t\t\t\t\t\ttracer.request.call(tracer, req, middleware)\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tres = await middleware(req, next)\n\t\t\t\t\tfor(let tracer of tracers) {\n\t\t\t\t\t\tif (tracer.response) {\n\t\t\t\t\t\t\ttracer.response.call(tracer, res, middleware)\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\treturn res\n\t\t\t\t}\t\t\t\t\t\t\t\t\n\t\t\t})(next, middleware)\n\t\t}\n\t\treturn next(req)\n\t}\n\n\twith(...options) {\n\t\treturn new Client(this, ...options)\n\t}\n}\n\n/**\n * Returns a new metro Client object.\n * @param {...ClientOptions|string|URL}\n * @return Client\n */\nexport function client(...options)\n{\n\treturn new Client(...options)\n}\n\nfunction appendHeaders(r, headers)\n{\n\tif (!Array.isArray(headers)) {\n\t\theaders = [headers]\n\t}\n\theaders.forEach((header) => {\n\t\tif (typeof header == 'function') {\n\t\t\tlet result = header(r.headers, r)\n\t\t\tif (result) {\n\t\t\t\tif (!Array.isArray(result)) {\n\t\t\t\t\tresult = [result]\n\t\t\t\t}\n\t\t\t\theaders = headers.concat(result)\n\t\t\t}\n\t\t}\n\t})\n\theaders.forEach((header) => {\n\t\tObject.entries(header).forEach(([name,value]) => {\t\t\t\n\t\t\tr.headers.append(name, value)\n\t\t})\n\t})\n}\n\nfunction bodyProxy(body, r)\n{\n\tlet source = r.body\n\tif (!source) {\n\t\t//Firefox does not allow access to Request.body (undefined)\n\t\t//Chrome and Nodejs do, so mimic the correct (documented)\n\t\t//result here\n\t\tif (body === null) {\n\t\t\tsource = new ReadableStream()\n\t\t} else if (body instanceof ReadableStream) {\n\t\t\tsource = body\n\t\t} else if (body instanceof Blob) {\n\t\t\tsource = body.stream()\n\t\t} else {\n\t\t\tsource = new ReadableStream({\n\t\t\t\tstart(controller) {\n\t\t\t\t\tlet chunk\n\t\t\t\t\tswitch(typeof body) {\n\t\t\t\t\t\tcase 'object':\n\t\t\t\t\t\t\tif (typeof body.toString == 'function') {\n\t\t\t\t\t\t\t\t// also catches URLSearchParams\n\t\t\t\t\t\t\t\tchunk = body.toString()\n\t\t\t\t\t\t\t} else if (body instanceof FormData) {\n\t\t\t\t\t\t\t\tchunk = new URLSearchParams(body).toString()\n\t\t\t\t\t\t\t} else if (body instanceof ArrayBuffer\n\t\t\t\t\t\t\t\t|| ArrayBuffer.isView(body)\n\t\t\t\t\t\t\t) {\n\t\t\t\t\t\t\t\t// catchs TypedArrays - e.g. Uint16Array\n\t\t\t\t\t\t\t\tchunk = body\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tthrow metroError('Cannot convert body to ReadableStream', body)\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\tbreak\n\t\t\t\t\t\tcase 'string':\n\t\t\t\t\t\tcase 'number':\n\t\t\t\t\t\tcase 'boolean':\n\t\t\t\t\t\t\tchunk = body\n\t\t\t\t\t\tbreak\n\t\t\t\t\t\tdefault:\n\t\t\t\t\t\t\tthrow metroError('Cannot convert body to ReadableStream', body)\n\t\t\t\t\t\tbreak\n\t\t\t\t\t}\n\t\t\t\t\tcontroller.enqueue(chunk)\n\t\t\t\t\tcontroller.close()\n\t\t\t\t}\n\t\t\t})\n\t\t}\n\t}\n\treturn new Proxy(source, {\n\t\tget(target, prop, receiver) {\n\t\t\tswitch (prop) {\n\t\t\t\tcase Symbol.metroProxy:\n\t\t\t\t\treturn true\n\t\t\t\tbreak\n\t\t\t\tcase Symbol.metroSource:\n\t\t\t\t\treturn body\n\t\t\t\tbreak\n\t\t\t\tcase 'toString':\n\t\t\t\t\treturn function() {\n\t\t\t\t\t\treturn ''+body\n\t\t\t\t\t}\n\t\t\t\tbreak\n\t\t\t}\n\t\t\tif (body && typeof body == 'object') {\n\t\t\t\tif (prop in body) {\n\t\t\t\t\tif (typeof body[prop] == 'function') {\n\t\t\t\t\t\treturn function(...args) {\n\t\t\t\t\t\t\treturn body[prop].apply(body, args)\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\treturn body[prop]\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (prop in target && prop != 'toString') {\n\t\t\t\t// skipped toString, since it has no usable output\n\t\t\t\t// and body may have its own toString\n\t\t\t\tif (typeof target[prop] == 'function') {\n\t\t\t\t\treturn function(...args) {\n\t\t\t\t\t\treturn target[prop].apply(target, args)\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\treturn target[prop]\n\t\t\t}\n\t\t},\n\t\thas(target, prop) {\n\t\t\tif (body && typeof body == 'object') {\n\t\t\t\treturn prop in body\n\t\t\t} else {\n\t\t\t\treturn prop in target\n\t\t\t}\n\t\t},\n\t\townKeys(target) {\n\t\t\tif (body && typeof body == 'object') {\n\t\t\t\treturn Reflect.ownKeys(body)\n\t\t\t} else {\n\t\t\t\treturn Reflect.ownKeys(target)\n\t\t\t}\n\t\t},\n\t\tgetOwnPropertyDescriptor(target, prop) {\n\t\t\tif (body && typeof body == 'object') {\n\t\t\t\treturn Object.getOwnPropertyDescriptor(body,prop)\n\t\t\t} else {\n\t\t\t\treturn Object.getOwnPropertyDescriptor(target,prop)\n\t\t\t}\n\t\t}\n\t})\n}\n\nfunction getRequestParams(req, current)\n{\n\tlet params = current || {}\n\tif (!params.url && current.url) {\n\t\tparams.url = current.url\n\t}\n\t// function to fetch all relevant properties of a Request\n\tfor(let prop of ['method','headers','body','mode','credentials','cache','redirect',\n\t\t'referrer','referrerPolicy','integrity','keepalive','signal',\n\t\t'priority','url']) {\n\t\tif (typeof req[prop] == 'function') {\n\t\t\treq[prop](params[prop], params)\n\t\t} else if (typeof req[prop] != 'undefined') {\n\t\t\tif (prop == 'url') {\n\t\t\t\tparams.url = url(params.url, req.url)\n\t\t\t} else if (prop == 'headers') {\n\t\t\t\tparams.headers = new Headers(current.headers)\n\t\t\t\tif (!(req.headers instanceof Headers)) {\n\t\t\t\t\treq.headers = new Headers(req.headers)\n\t\t\t\t}\n\t\t\t\tfor (let [key, value] of req.headers.entries()) {\n\t\t\t\t\tparams.headers.set(key, value)\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tparams[prop] = req[prop]\n\t\t\t}\n\t\t}\n\t}\n\treturn params\n}\n\n/**\n * @typedef {Request} MetroRequest\n * @property {Symbol(source)} - returns the target Request of this Proxy\n * @property {Symbol(isProxy)} - returns true\n * @method with - returns a new MetroRequest, with the given options added\n * @param {<RequestOptions|Request|string|URL|URLSearchParams|FormData|ReadableStream|\n *   Blob|ArrayBuffer|DataView|TypedArray>} ...options - request options, handled in order\n * \n * Returns a new metro Request object\n * @param {<RequestOptions|Request|string|URL|URLSearchParams|FormData|ReadableStream|\n *   Blob|ArrayBuffer|DataView|TypedArray>} ...options - request options, handled in order\n * @return {MetroRequest} - a new metro Request object\n */\nexport function request(...options)\n{\n\t// the standard Request constructor is a minefield\n\t// so first gather all the options together into a single\n\t// javascript object, then set it in one go\n\tlet requestParams = {\n\t\turl: typeof window != 'undefined' ? window.location : 'https://localhost/',\n\t\tduplex: 'half' // required when setting body to ReadableStream, just set it here by default already\n\t}\n\tfor (let option of options) {\n\t\tif (typeof option == 'string'\n\t\t\t|| option instanceof URL\n\t\t\t|| option instanceof URLSearchParams\n\t\t) {\n\t\t\trequestParams.url = url(requestParams.url, option)\n\t\t} else if (option && (\n\t\t\toption instanceof FormData\n\t\t\t|| option instanceof ReadableStream\n\t\t\t|| option instanceof Blob\n\t\t\t|| option instanceof ArrayBuffer\n\t\t\t|| option instanceof DataView\n\t\t)) {\n\t\t\trequestParams.body = option\n\t\t} else if (option && typeof option == 'object') {\n\t\t\tObject.assign(requestParams, getRequestParams(option, requestParams))\n\t\t}\n\t}\n\tlet body = requestParams.body\n\tif (body) {\n\t\tif (typeof body == 'object'\n\t\t\t&& !(body instanceof String)\n\t\t\t&& !(body instanceof ReadableStream)\n\t\t\t&& !(body instanceof Blob)\n\t\t\t&& !(body instanceof ArrayBuffer)\n\t\t\t&& !(body instanceof DataView)\n\t\t\t&& !(body instanceof FormData)\n\t\t\t&& !(body instanceof URLSearchParams)\n\t\t\t&& (typeof TypedArray=='undefined' || !(body instanceof TypedArray))\n\t\t) {\n\t\t\trequestParams.body = JSON.stringify(body)\n\t\t}\n\t}\n\tlet r = new Request(requestParams.url, requestParams)\n\tObject.freeze(r)\n\treturn new Proxy(r, {\n\t\tget(target, prop, receiver) {\n\t\t\tswitch(prop) {\n\t\t\t\tcase Symbol.metroSource:\n\t\t\t\t\treturn target\n\t\t\t\tbreak\n\t\t\t\tcase Symbol.metroProxy:\n\t\t\t\t\treturn true\n\t\t\t\tbreak\n\t\t\t\tcase 'with':\n\t\t\t\t\treturn function(...options) {\n\t\t\t\t\t\tif (body) { // body is kept in a seperate value, if it set earlier\n\t\t\t\t\t\t\toptions.unshift({ body }) // unshifted so it can be overridden by options\n\t\t\t\t\t\t}\n\t\t\t\t\t\treturn request(target, ...options)\n\t\t\t\t\t}\n\t\t\t\tbreak\n\t\t\t\tcase 'body':\n\t\t\t\t\t// Request.body is always a ReadableStream\n\t\t\t\t\t// which is a horrible API, if you want to\n\t\t\t\t\t// allow middleware to alter the body\n\t\t\t\t\t// so we keep the original body, wrap a Proxy\n\t\t\t\t\t// around it to keep the ReadableStream api\n\t\t\t\t\t// accessible, but allow access to the original\n\t\t\t\t\t// body value as well\n\t\t\t\t\tif (!body) {\n\t\t\t\t\t\tbody = target.body\n\t\t\t\t\t}\n\t\t\t\t\tif (body) {\n\t\t\t\t\t\tif (body[Symbol.metroProxy]) {\n\t\t\t\t\t\t\treturn body\n\t\t\t\t\t\t}\n\t\t\t\t\t\treturn bodyProxy(body, target)\n\t\t\t\t\t}\n\t\t\t\tbreak\n\t\t\t}\n\t\t\tif (target[prop] instanceof Function) {\n\t\t\t\treturn target[prop].bind(target)\n\t\t\t}\n\t\t\treturn target[prop]\n\t\t}\n\t})\n}\n\nfunction getResponseParams(res, current)\n{\n\t// function to fetch all relevant properties of a Response\n\tlet params = current || {}\n\tif (!params.url && current.url) {\n\t\tparams.url = current.url\n\t}\n\tfor(let prop of ['status','statusText','headers','body','url','type','redirected']) {\n\t\tif (typeof res[prop] == 'function') {\n\t\t\tres[prop](params[prop], params)\n\t\t} else if (typeof res[prop] != 'undefined') {\n\t\t\tif (prop == 'url') {\n\t\t\t\tparams.url = new URL(res.url, params.url || 'https://localhost/')\n\t\t\t} else {\n\t\t\t\tparams[prop] = res[prop]\n\t\t\t}\n\t\t}\n\t}\n\treturn params\n}\n\n/**\n * @typedef {Response} MetroResponse\n * @property {Symbol(source)} - returns the target Response of this Proxy\n * @property {Symbol(isProxy)} - returns true\n * @method with - returns a new MetroResponse, with the given options added\n * @param {<ResponseOptions|Response|string|URLSearchParams|FormData|ReadableStream|\n *   Blob|ArrayBuffer|DataView|TypedArray>} ...options - respomse options, handled in order\n * \n * Returns a new metro Response object\n * @param {<ResponseOptions|Response|string|URLSearchParams|FormData|ReadableStream|\n *   Blob|ArrayBuffer|DataView|TypedArray>} ...options - request options, handled in order\n * @return {MetroResponse} - a new metro Response object\n */\nexport function response(...options)\n{\n\tlet responseParams = {}\n\tfor (let option of options) {\n\t\tif (typeof option == 'string') {\n\t\t\tresponseParams.body = option\n\t\t} else if (option instanceof Response) {\n\t\t\tObject.assign(responseParams, getResponseParams(option, responseParams))\n\t\t} else if (option && typeof option == 'object') {\n\t\t\tif (option instanceof FormData\n\t\t\t\t|| option instanceof Blob\n\t\t\t\t|| option instanceof ArrayBuffer\n\t\t\t\t|| option instanceof DataView\n\t\t\t\t|| option instanceof ReadableStream\n\t\t\t\t|| option instanceof URLSearchParams\n\t\t\t\t|| option instanceof String\n\t\t\t\t|| (typeof TypedArray != 'undefined' && option instanceof TypedArray)\n\t\t\t) {\n\t\t\t\tresponseParams.body = option\n\t\t\t} else {\n\t\t\t\tObject.assign(responseParams, getResponseParams(option, responseParams))\n\t\t\t}\n\t\t}\n\t}\n\tlet r = new Response(responseParams.body, responseParams)\t\n\tObject.freeze(r)\n\treturn new Proxy(r, {\n\t\tget(target, prop, receiver) {\n\t\t\tswitch(prop) {\n\t\t\t\tcase Symbol.metroProxy:\n\t\t\t\t\treturn true\n\t\t\t\tbreak\n\t\t\t\tcase Symbol.metroSource:\n\t\t\t\t\treturn target\n\t\t\t\tbreak\n\t\t\t\tcase 'with':\n\t\t\t\t\treturn function(...options) {\n\t\t\t\t\t\treturn response(target, ...options)\n\t\t\t\t\t}\n\t\t\t\tbreak\n\t\t\t\tcase 'body':\n\t\t\t\t\tif (responseParams.body) {\n\t\t\t\t\t\tif (responseParams.body[Symbol.metroProxy]) {\n\t\t\t\t\t\t\treturn responseParams.body\n\t\t\t\t\t\t}\n\t\t\t\t\t\treturn bodyProxy(responseParams.body, target)\n\t\t\t\t\t} else {\n\t\t\t\t\t\treturn bodyProxy('',target)\n\t\t\t\t\t}\n\t\t\t\tbreak\n\t\t\t\tcase 'ok':\n\t\t\t\t\treturn (target.status>=200) && (target.status<400)\n\t\t\t\tbreak\n\t\t\t\tcase 'headers':\n\t\t\t\t\treturn target.headers\n\t\t\t\tbreak\n\t\t\t\tdefault:\n\t\t\t\t\tif (prop in responseParams && prop != 'toString') {\n\t\t\t\t\t\treturn responseParams[prop]\n\t\t\t\t\t}\n\t\t\t\t\tif (prop in target && prop != 'toString') {\n\t\t\t\t\t\t// skipped toString, since it has no usable output\n\t\t\t\t\t\t// and body may have its own toString\n\t\t\t\t\t\tif (typeof target[prop] == 'function') {\n\t\t\t\t\t\t\treturn function(...args) {\n\t\t\t\t\t\t\t\treturn target[prop].apply(target, args)\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t\treturn target[prop]\n\t\t\t\t\t}\n\t\t\t\tbreak\n\t\t\t}\n\t\t\treturn undefined\n\t\t}\n\t})\n}\n\nfunction appendSearchParams(url, params) {\n\tif (typeof params == 'function') {\n\t\t params(url.searchParams, url)\n\t} else {\n\t\tparams = new URLSearchParams(params)\n\t\tparams.forEach((value,key) => {\n\t\t\turl.searchParams.append(key, value)\n\t\t})\n\t}\n}\n\n/**\n * @typedef {URL} MetroURL\n * @property {Symbol(source)} - returns the target Request of this Proxy\n * @property {Symbol(isProxy)} - returns true\n * @method with - returns a new MetroRequest, with the given options added\n * @param {<URL|URLSearchParams|string|Object|Function>} ...options - url options, handled in order\n * \n * Returns a new metro URL object\n * @param {<URL|URLSearchParams|string|Object|Function>} ...options - url options, handled in order\n * @return {MetroURL} - a new metro URL object\n */\nexport function url(...options)\n{\n\tlet validParams = ['hash','host','hostname','href',\n\t\t\t'password','pathname','port','protocol','username','search','searchParams']\n\tlet u = new URL('https://localhost/')\n\tfor (let option of options) {\n\t\tif (typeof option == 'string' || option instanceof String) {\n\t\t\t// option is a relative or absolute url\n\t\t\tu = new URL(option, u)\n\t\t} else if (option instanceof URL \n\t\t\t|| (typeof Location != 'undefined' \n\t\t\t\t&& option instanceof Location)\n\t\t) {\n\t\t\tu = new URL(option)\n\t\t} else if (option instanceof URLSearchParams) {\n\t\t\tappendSearchParams(u, option)\n\t\t} else if (option && typeof option == 'object') {\n\t\t\tfor (let param in option) {\n\t\t\t\tif (param=='search') {\n\t\t\t\t\tif (typeof option.search == 'function') {\n\t\t\t\t\t\toption.search(u.search, u)\n\t\t\t\t\t} else {\n\t\t\t\t\t\tu.search = new URLSearchParams(option.search)\n\t\t\t\t\t}\n\t\t\t\t} else if (param=='searchParams') {\n\t\t\t\t\tappendSearchParams(u, option.searchParams)\n\t\t\t\t} else {\n\t\t\t\t\tif (!validParams.includes(param)) {\n\t\t\t\t\t\tthrow metroError('metro.url: unknown url parameter '+metroURL+'url/unknown-param-name/', param)\n\t\t\t\t\t}\n\t\t\t\t\tif (typeof option[param] == 'function') {\n\t\t\t\t\t\toption[param](u[param], u)\n\t\t\t\t\t} else if (\n\t\t\t\t\t\ttypeof option[param] == 'string' || option[param] instanceof String \n\t\t\t\t\t\t|| typeof option[param] == 'number' || option[param] instanceof Number\n\t\t\t\t\t\t|| typeof option[param] == 'boolean' || option[param] instanceof Boolean\n\t\t\t\t\t) {\n\t\t\t\t\t\tu[param] = ''+option[param]\n\t\t\t\t\t} else if (typeof option[param] == 'object' && option[param].toString) {\n\t\t\t\t\t\tu[param] = option[param].toString()\n\t\t\t\t\t} else {\n\t\t\t\t\t\tthrow metroError('metro.url: unsupported value for '+param+' '+metroURL+'url/unsupported-param-value/', options[param])\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t} else {\n\t\t\tthrow metroError('metro.url: unsupported option value '+metroURL+'url/unsupported-option-value/', option)\n\t\t}\n\t}\n\tObject.freeze(u)\n\treturn new Proxy(u, {\n\t\tget(target, prop, receiver) {\n\t\t\tswitch(prop) {\n\t\t\t\tcase Symbol.metroProxy:\n\t\t\t\t\treturn true\n\t\t\t\tbreak\n\t\t\t\tcase Symbol.metroSource:\n\t\t\t\t\treturn target\n\t\t\t\tbreak\n\t\t\t\tcase 'with':\n\t\t\t\t\treturn function(...options) {\n\t\t\t\t\t\treturn url(target, ...options)\n\t\t\t\t\t}\n\t\t\t\tbreak\n\t\t\t}\n\t\t\tif (target[prop] instanceof Function) {\n\t\t\t\treturn target[prop].bind(target)\n\t\t\t}\n\t\t\treturn target[prop]\n\t\t}\n\t})\n}\n\n/**\n * @typedef {FormData} MetroFormData\n * @property {Symbol(source)} - returns the target Request of this Proxy\n * @property {Symbol(isProxy)} - returns true\n * @method with - returns a new MetroRequest, with the given options added\n * @param {<FormData|Object>} ...options - url options, handled in order\n * \n * Returns a new metro FormData object\n * @param {<FormData|Object>} ...options - formdata options, handled in order\n * @return {MetroURL} - a new metro FormData object\n */\nexport function formdata(...options)\n{\n\tvar params = new FormData()\n\tfor (let option of options) {\n\t\tif (option instanceof FormData) {\n\t\t\tfor (let entry of option.entries()) {\n\t\t\t\tparams.append(entry[0],entry[1])\n\t\t\t}\n\t\t} else if (option && typeof option == 'object') {\n\t\t\tfor (let entry of Object.entries(option)) {\n\t\t\t\tif (Array.isArray(entry[1])) {\n\t\t\t\t\tfor (let value of entry[1]) {\n\t\t\t\t\t\tparams.append(entry[0], value)\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tparams.append(entry[0],entry[1])\n\t\t\t\t}\n\t\t\t}\n\t\t} else {\n\t\t\tthrow new metroError('metro.formdata: unknown option type, only FormData or Object supported',option)\n\t\t}\n\t}\n\tObject.freeze(params)\n\treturn new Proxy(params, {\n\t\tget: (target,prop,receiver) => {\n\t\t\tswitch(prop) {\n\t\t\t\tcase Symbol.metroProxy:\n\t\t\t\t\treturn true\n\t\t\t\tbreak\n\t\t\t\tcase Symbol.metroSource:\n\t\t\t\t\treturn target\n\t\t\t\tbreak\n\t\t\t\tcase 'with':\n\t\t\t\t\treturn function(...options) {\n\t\t\t\t\t\treturn formdata(target, ...options)\n\t\t\t\t\t}\n\t\t\t\tbreak\n\t\t\t}\n\t\t\tif (target[prop] instanceof Function) {\n\t\t\t\treturn target[prop].bind(target)\n\t\t\t}\n\t\t\treturn target[prop]\n\t\t}\n\t})\n}\n\nconst metroConsole = {\n\terror: (message, ...details) => {\n\t\tconsole.error('\u24C2\uFE0F  ',message, ...details)\n\t},\n\tinfo: (message, ...details) => {\n\t\tconsole.info('\u24C2\uFE0F  ',message, ...details)\n\t},\n\tgroup: (name) => {\n\t\tconsole.group('\u24C2\uFE0F  '+name)\n\t},\n\tgroupEnd: (name) => {\n\t\tconsole.groupEnd('\u24C2\uFE0F  '+name)\n\t}\n}\n\n\n/**\n * Custom Metro Error function that outputs to the console then throws an error\n */\nexport function metroError(message, ...details) {\n\tmetroConsole.error(message, ...details)\n\treturn new Error(message, ...details)\n}\n\n/**\n * Set of debugging tools to trace the request - response flow\n * Tracer are run on all metro fetch calls\n */\nexport const trace = {\n\t/**\n\t * Adds a named tracer function\n\t * @param {string} name - the name of the tracer\n\t * @param {Function} tracer - the tracer function to call\n\t */\n\tadd(name, tracer) {\n\t\tClient.tracers[name] = tracer\n\t},\n\t/**\n\t * Removes a named tracer function\n\t * @param {string} name\n\t */\n\tdelete(name) {\n\t\tdelete Client.tracers[name]\n\t},\n\t/**\n\t * Removes all tracer functions\n\t */\n\tclear() {\n\t\tClient.tracers = {}\n\t},\n\t/**\n\t * Returns a set of request and response tracer functions that use the\n\t * console.group feature to shows nested request/response pairs, with\n\t * most commonly needed information for debugging\n\t */\n\tgroup() {\n\t\tlet group = 0;\n\t\treturn {\n\t\t\trequest: (req, middleware) => {\n\t\t\t\tgroup++\n\t\t\t\tmetroConsole.group(group)\n\t\t\t\tmetroConsole.info(req?.url, req, middleware)\n\t\t\t},\n\t\t\tresponse: (res, middleware) => {\n\t\t\t\tmetroConsole.info(res?.body ? res.body[Symbol.metroSource]: null, res, middleware)\n\t\t\t\tmetroConsole.groupEnd(group)\n\t\t\t\tgroup--\n\t\t\t}\n\t\t}\n\t}\n}\n", "import * as metro from '../metro.mjs'\n\nexport default function jsonmw(options) {\n\toptions = Object.assign({\n\t\treviver: null,\n\t\treplacer: null,\n\t\tspace: ''\n\t}, options)\n\n\treturn async (req, next) => {\n\t\tif (['POST','PUT','PATCH','QUERY'].includes(req.method)) {\n\t\t\treq = req.with({\n\t\t\t\theaders: {\n\t\t\t\t\t'Content-Type':'application/json',\n\t                'Accept':'application/json'\n\t\t\t\t}\n\t\t\t})\n\t\t\tif (req.body && typeof req.body[Symbol.metroSource] == 'object') {\n\t\t\t\treq = req.with({\n\t\t\t\t\tbody: JSON.stringify(req.body[Symbol.metroSource], options.replacer, options.space)\n\t\t\t\t})\n\t\t\t}\n\t\t} else {\n\t\t\treq = req.with({\n\t\t\t\theaders: {\n\t\t\t        'Accept':'application/json'\n\t\t\t\t}\n\t\t\t})\n\t\t}\n\t\tlet res = await next(req)\n\t\tlet body = await res.text()\n\t\tlet json = JSON.parse(body, options.reviver)\n\t\treturn res.with({\n\t\t\tbody: json\n\t\t})\n\t}\n}", "import * as metro from '../metro.mjs'\n\nexport default function thrower(options) {\n\n\treturn async (req, next) => {\n\t\tlet res = await next(req)\n\t\tif (!res.ok) {\n\t\t\tif (options && typeof options[res.status] == 'function') {\n\t\t\t\tres = options[res.status].apply(res, req)\n\t\t\t} else {\n\t\t\t\tthrow new Error(res.status+': '+res.statusText, {\n\t\t\t\t\tcause: res\n\t\t\t\t})\n\t\t\t}\n\t\t}\n\t\treturn res\n\t}\n\n}", "import * as m from './metro.mjs'\nimport jsonmw from './mw/json.mjs'\nimport thrower from './mw/thrower.mjs'\n\nconst metro = Object.assign({}, m, {\n\tmw: {\n\t\tjsonmw,\n\t\tthrower\n\t}\n})\n\nwindow.metro = metro\n\nexport default metro", "/*\nTODO: add assertExplain global flag, so that if assert() fails, you can call explain() with\n  the same pattern and it will return text explanation of why it failed, each assertion function must \n  then check assertExplain, and return a text explanation of what fails or succeeds\n  top level can then filter to show only the failures\n  (so that not(x) can show the succeeds message of x)\n*/\n\n/**\n * assertEnabled (Boolean) used to toggle whether the assert()\n * method should test assertions or not.\n */\nglobalThis.assertEnabled = false\n\n/**\n * Enables assertion testing with assert()\n */\nexport function enable() {\n\tglobalThis.assertEnabled = true\n}\n\n/**\n * Disables assertion testing with assert()\n */\nexport function disable() {\n\tglobalThis.assertEnabled = false\n}\n\n/**\n * This function will check the source for the assertions in test, if\n * assertion checking is enabled globally.\n * If it is, and any assertion fails, it will throw an assertError\n * with a list of problems and other details.\n */\nexport function assert(source, test) {\n\tif (globalThis.assertEnabled) {\n\t\tlet problems = fails(source,test)\n\t\tif (problems) {\n\t\t\tconsole.error('\uD83C\uDD70\uFE0F  Assertions failed because of:', problems, 'in this source:', source)\n\t\t\tthrow new Error('Assertions failed', {\n\t\t\t\tcause: { problems, source } \n\t\t\t})\n\t\t}\n\t}\n}\n\n/**\n * Tests a given value against a pattern, only if the value is not null or undefined\n */\nexport function Optional(pattern) {\n\treturn function _Optional(data, root, path) {\n\t\tif (typeof data != 'undefined' && data!=null && typeof pattern != 'undefined' ) {\n\t\t\treturn fails(data, pattern, root, path)\n\t\t}\n\t}\n}\n\n/**\n * Tests a given value against a pattern, always.\n */\nexport function Required(pattern) {\n\treturn function _Required(data, root, path) {\n\t\tif (data==null || typeof data == 'undefined') {\n\t\t\treturn error('data is required', data, pattern || 'any value', path)\n\t\t} else if (typeof pattern != 'undefined') {\n\t\t\treturn fails(data, pattern, root, path)\n\t\t} else {\n\t\t\treturn false\n\t\t}\n\t}\n}\n\n/**\n * Tests a given value against a pattern, only if the value is not null or undefined\n * If null or undefined, it does print a warning to the console.\n */\nexport function Recommended(pattern) {\n\treturn function _Recommended(data, root, path) {\n\t\tif (data==null || typeof data == 'undefined') {\n\t\t\tconsole.warn('data does not contain recommended value', data, pattern, path)\n\t\t\treturn false\n\t\t} else {\n\t\t\treturn fails(data, pattern, root, path)\n\t\t}\n\t}\n}\n\n/**\n * Tests a given value against a set of patterns, untill one succeeds\n * Returns an error if none succeed\n */\nexport function oneOf(...patterns) { \n\treturn function _oneOf(data, root, path) {\n\t\tfor(let pattern of patterns) {\n\t\t\tif (!fails(data, pattern, root, path)) {\n\t\t\t\treturn false\n\t\t\t}\n\t\t}\n\t\treturn error('data does not match oneOf patterns', data, patterns, path)\n\t}\n}\n\n/**\n * Tests a given array of values against a set of patterns\n * If any value does not match one of the patterns, it will return an error\n * If not given an array to test, it will return an error\n */\nexport function anyOf(...patterns) {\n\treturn function _anyOf(data, root, path) {\n\t\tif (!Array.isArray(data)) {\n\t\t\treturn error('data is not an array',data,'anyOf',path)\n\t\t}\n\t\tfor (let value of data) {\n\t\t\tif (oneOf(...patterns)(value)) {\n\t\t\t\treturn error('data does not match anyOf patterns',value,patterns,path)\n\t\t\t}\n\t\t}\n\t\treturn false\n\t}\n}\n\nexport function allOf(...patterns) {\n\treturn function _allOf(data, root, path) {\n\t\tlet problems = []\n\t\tfor (let pattern of patterns) {\n\t\t\tproblems = problems.concat(fails(data, pattern, root, path))\n\t\t}\n\t\tproblems = problems.filter(Boolean)\n\t\tif (problems.length) {\n\t\t\treturn error('data does not match all given patterns', data, patterns, path, problems)\n\t\t}\n\t}\n}\n\n/**\n * Tests a given value to see if it is a valid (and absolute) URL, by\n * parsing it with the URL() constructor, and then testing the href\n * value to be equal to the initial value.\n */\nexport function validURL(data, root, path) {\n\ttry {\n\t\tif (data instanceof URL) {\n\t\t\tdata = data.href\n\t\t}\n\t\tlet url = new URL(data)\n\t\tif (url.href!=data) {\n\t\t\tif (!(url.href+'/'==data || url.href==data+'/')) {\n\t\t\t\t// new URL() always adds a / as path\n\t\t\t\treturn error('data is not a valid url',data,'validURL',path)\n\t\t\t}\n\t\t}\n\t} catch(e) {\n\t\treturn error('data is not a valid url',data,'validURL',path)\n\t}\n}\n\n/**\n * Tests a given value to see if it looks like a valid email address, by\n * testing it against a regular expression. So there are no guarantees that\n * it is an actual working email address, just that it looks like one.\n */\nexport function validEmail(data, root, path) {\n\tif (!/^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/.test(data)) {\n\t\treturn error('data is not a valid email',data,'validEmail',path)\n\t}\n}\n\n/**\n * Tests a given value to see if it is an object which is an instance of the given\n * constructor\n */\nexport function instanceOf(constructor) {\n\treturn function _instanceOf(data, root, path) {\n\t\tif (!(data instanceof constructor)) {\n\t\t\treturn error('data is not an instanceof pattern',data,constructor,path)\n\t\t}\n\t}\n}\n\n/**\n * Runs the given test pattern on a value, if the test succeeds, it fails\n * the not() test.\n */\nexport function not(pattern) {\n\treturn function _not(data, root, path) {\n\t\tif (!fails(data, pattern, root, path)) {\n\t\t\treturn error('data matches pattern, when required not to', data, pattern, path)\n\t\t}\n\t}\n}\n\n/**\n * returns an array of problems if the data fails to satisfy \n * the assertions in the given pattern, false otherwise\n * @param {any} data    The data to match\n * @param {any} pattern The pattern to match\n * @param {any} root    Root object for assertions, set to data by default\n * @return {Array|false} Array with problems if the pattern fails, false otherwise\n */\nexport function fails(data, pattern, root, path='') {\n\tif (!root) {\n\t\troot = data\n\t}\n\tlet problems = []\n\tif (pattern === Boolean) {\n\t\tif (typeof data != 'boolean' && !(data instanceof Boolean)) {\n\t\t\tproblems.push(error('data is not a boolean', data, pattern, path))\n\t\t}\t\t\n\t} else if (pattern === Number) {\n\t\tif (typeof data != 'number' && !(data instanceof Number)) {\n\t\t\tproblems.push(error('data is not a number', data, pattern, path))\n\t\t}\n\t} else if (pattern === String) {\n\t\tif (typeof data != 'string' && !(data instanceof String)) {\n\t\t\tproblems.push(error('data is not a string', data, pattern, path))\n\t\t}\n\t\tif (data == \"\") {\n\t\t\tproblems.push(error('data is an empty string, which is not allowed', data, pattern, path))\n\t\t}\n\t} else if (pattern instanceof RegExp) {\n    \tif (Array.isArray(data)) {\n\t\t\tlet index = data.findIndex((element,index) => fails(element,pattern,root,path+'['+index+']'))\n            if (index>-1) {\n            \tproblems.push(error('data['+index+'] does not match pattern', data[index], pattern, path+'['+index+']'))\n            }\n        } else if (typeof data == 'undefined') {\n        \tproblems.push(error('data is undefined, should match pattern', data, pattern, path))\n    \t} else if (!pattern.test(data)) {\n        \tproblems.push(error('data does not match pattern', data, pattern, path))\n        }\n    } else if (pattern instanceof Function) {\n        let problem = pattern(data, root, path)\n        if (problem) {\n        \tif (Array.isArray(problem)) {\n        \t\tproblems = problems.concat(problem)\n        \t} else {\n\t        \tproblems.push(problem)\n\t        }\n        }\n    } else if (Array.isArray(pattern)) {\n\t\tif (!Array.isArray(data)) {\n\t\t\tproblems.push(error('data is not an array',data,[],path))\n\t\t}\n\t\tfor (let p of pattern) {\n\t\t\tfor (let index of data.keys()) {\n\t\t\t\tlet problem = fails(data[index], p, root, path+'['+index+']')\n\t\t\t\tif (Array.isArray(problem)) {\n\t\t\t\t\tproblems = problems.concat(problem)\n\t\t\t\t} else if (problem) {\n\t\t\t\t\tproblems.push(problem)\n\t\t\t\t}\n\t\t\t}\n    \t}\n    } else if (pattern && typeof pattern == 'object') {\n        if (Array.isArray(data)) {\n            let index = data.findIndex((element,index) => fails(element,pattern,root,path+'['+index+']'))\n            if (index>-1) {\n            \tproblems.push(error('data['+index+'] does not match pattern', data[index], pattern, path+'['+index+']'))\n            }\n        } else if (!data || typeof data != 'object') {\n        \tproblems.push(error('data is not an object, pattern is', data, pattern, path))\n        } else {\n        \tif (data instanceof URLSearchParams) {\n        \t\tdata = Object.fromEntries(data)\n        \t}\n        \tif (pattern instanceof Function) {\n        \t\tlet result = fails(data, pattern, root, path)\n\t            if (result) {\n\t            \tproblems = problems.concat(result)\n\t            }\n        \t} else {\n\t\t        for (const [wKey, wVal] of Object.entries(pattern)) {\n\t\t            let result = fails(data[wKey], wVal, root, path+'.'+wKey)\n\t\t            if (result) {\n\t\t            \tproblems = problems.concat(result)\n\t\t            }\n\t\t        }\n\t\t    }\n\t    }\n    } else {\n    \tif (pattern!=data) {\n    \t\tproblems.push(error('data and pattern are not equal', data, pattern, path))\n    \t}\n    }\n    if (problems.length) {\n    \treturn problems\n    }\n    return false\n}\n\n/**\n * Returns an object with message, found and expected properties\n */ \nexport function error(message, found, expected, path, problems) {\n\tlet result = {\n\t\tmessage,\n\t\tfound,\n\t\texpected,\n\t\tpath\n\t}\n\tif (problems) {\n\t\tresult.problems = problems\n\t}\n\treturn result\n}\n", "import { error } from '@muze-nl/assert'\n\nexport const MustHave = (...options) => \n\t(value, root) => {\n\t\tif (options.filter(o => root.hasOwnKey(o)).length > 0) {\n\t\t\treturn false\n\t\t}\n\t\treturn error('root data must have all of', root, options)\n\t}\n\nexport const MustInclude = (...options) =>\n\t(value) => {\n\t\tif (Array.isArray(value) && options.filter(o => !value.includes(o)).length == 0) {\n\t\t\treturn false\n\t\t} else {\n\t\t\treturn error('data must be an array which includes',value,options)\n\t\t}\n\t}\n\n//TODO: add link to spec\nexport const validJWK = [\n\t'HS256','HS384','HS512','RS256','RS384','RS512','ES256','ES384','ES512'\n]\n\n//TODO: add link to spec\n// FIXME: enter correct values\nexport const validJWA = [\n\t'HS256','HS384','HS512','RS256','RS384','RS512','ES256','ES384','ES512'\n]\n\n//TODO: add link to spec\nexport const validAuthMethods = [\n\t'client_secret_post', 'client_secret_basic','client_secret_jwt','private_key_jwt'\n]\n", "/**\n * This module adheres to OpenID Connect Discovery 1.0 incorporating errata set 2 - december 15, 2023\n * https://openid.net/specs/openid-connect-discovery-1_0.html\n */\nimport metro from '@muze-nl/metro'\nimport jsonmw from '@muze-nl/metro/src/mw/json.mjs'\nimport throwermw from '@muze-nl/metro/src/mw/thrower.mjs'\nimport { validJWA, MustInclude, validAuthMethods } from './oidc.util.mjs'\nimport { assert, fails, Required, Recommended, Optional, oneOf, anyOf, allOf, validURL, instanceOf, not, error } from '@muze-nl/assert'\n\n/**\n * Given options.issuer will get the .well-known/openid-configuration information\n * parse it, assert if follows the specification and return it as a javascript object\n * @param options.issuer Required: URL with the root of the oidc issuer\n * @param options.client Optional: metro client to use in the request\n * @returns object with openid-configuration\n * @throws Error when a network error occurs while fetching openid-configuration\n * @throws assertError when either the options or the openid-configuration fail assertions (and assertion testing is enabled)\n */\nexport default async function oidcDiscovery(options={}) {\n\tassert(options, {\n\t\tclient: Optional(instanceOf(metro.client().constructor)),\n\t\tissuer: Required(validURL)\n\t})\n\n\tconst defaultOptions = {\n\t\tclient: metro.client().with(throwermw()).with(jsonmw()),\n\t\trequireDynamicRegistration: false\n\t}\n\n\toptions = Object.assign({},defaultOptions,options)\n\n\tconst TestSucceeded = false\n\tfunction MustUseHTTPS(url) {\n\t\treturn TestSucceeded // FIXME todo\n\t}\n\n\t// https://openid.net/specs/openid-connect-discovery-1_0.html#ProviderMetadata\n\t// @TODO: this is a first approximation of the specced requirements, needs to implement\n\t// all MUST/MUST NOT etc. notes in the specification.\n\tconst openid_provider_metadata = {\n\t\tissuer: Required(allOf(options.issuer, MustUseHTTPS)),\n\t\tauthorization_endpoint: Required(validURL),\n\t\ttoken_endpoint: Required(validURL),\n\t\tuserinfo_endpoint: Recommended(validURL), // todo: test for https protocol\n\t\tjwks_uri: Required(validURL),\n\t\tregistration_endpoint: options.requireDynamicRegistration \n\t\t\t? Required(validURL) \n\t\t\t: Recommended(validURL),\n\t\tscopes_supported: Recommended(MustInclude('openid')),\n\t\tresponse_types_supported: options.requireDynamicRegistration\n\t\t\t? Required(MustInclude('code','id_token','id_token token')) \n\t\t\t: Required([]),\n\t\tresponse_modes_supported: Optional([]),\n\t\tgrant_types_supported: options.requireDynamicRegistration\n\t\t\t? Optional(MustInclude('authorization_code')) // implicit is required according to the spec, but not used in web apps\n\t\t\t: Optional([]),\n\t\tacr_values_supported: Optional([]),\n\t\tsubject_types_supported: Required([]),\n\t\tid_token_signing_alg_values_supported: Required(MustInclude('RS256')),\n\t\tid_token_encryption_alg_values_supported: Optional([]),\n\t\tid_token_encryption_enc_values_supported: Optional([]),\n\t\tuserinfo_signing_alg_values_supported: Optional([]),\n\t\tuserinfo_encryption_alg_values_supported: Optional([]),\n\t\tuserinfo_encryption_enc_values_supported: Optional([]),\n\t\trequest_object_signing_alg_values_supported: Optional(MustInclude('RS256')), // not testing for 'none'\n\t\trequest_object_encryption_alg_values_supported: Optional([]),\n\t\trequest_object_encryption_enc_values_supported: Optional([]),\n\t\ttoken_endpoint_auth_methods_supported: Optional(anyOf(...validAuthMethods)),\n\t\ttoken_endpoint_auth_signing_alg_values_supported: Optional(MustInclude('RS256'), not(MustInclude('none'))),\n\t\tdisplay_values_supported: Optional(anyOf('page','popup','touch','wap')),\n\t\tclaim_types_supported: Optional(anyOf('normal','aggregated','distributed')),\n\t\tclaims_supported: Recommended([]),\n\t\tservice_documentation: Optional(validURL),\n\t\tclaims_locales_supported: Optional([]),\n\t\tui_locales_supported: Optional([]),\n\t\tclaims_parameter_supported: Optional(Boolean),\n\t\trequest_parameter_supported: Optional(Boolean),\n\t\trequest_uri_parameter_supported: Optional(Boolean),\n\t\top_policy_uri: Optional(validURL),\n\t\top_tos_uri: Optional(validURL)\t\n\t}\n\n\t// fetch openid configuration from wellknown and return the json\n\tconst configURL = metro.url(options.issuer, '.well-known/openid-configuration')\n\n\tconst response = await options.client.get(\n\t\t// https://openid.net/specs/openid-connect-discovery-1_0.html#ProviderConfigurationRequest\n\t\t// note: this allows path components in the options.issuer url\n\t\tconfigURL\n\t)\n\tconst openid_config = response.body[Symbol.metroSource]\n\tassert(openid_config, openid_provider_metadata)\n\n\t// https://openid.net/specs/openid-connect-discovery-1_0.html#ProviderConfigurationValidation\n\tassert(openid_config.issuer, options.issuer)\n\treturn openid_config\n}", "/**\n * This module adheres to OpenID Connect Dynamic Client Registration 1.0 \n * incorporating errata set 2 - december 15, 2023\n * https://openid.net/specs/openid-connect-registration-1_0.html\n */\nimport metro from '@muze-nl/metro'\nimport jsonmw from '@muze-nl/metro/src/mw/json.mjs'\nimport throwermw from '@muze-nl/metro/src/mw/thrower.mjs'\nimport { validJWA, validAuthMethods, MustHave } from './oidc.util.mjs'\nimport { assert, Required, Optional, oneOf, anyOf, validURL, validEmail, not, instanceOf } from '@muze-nl/assert'\n\nexport default async function register(options)\n{\n\n    // https://openid.net/specs/openid-connect-registration-1_0.html#ClientMetadata\n\tconst openid_client_metadata = {\n\t\tredirect_uris: Required([validURL]),\n\t\tresponse_types: Optional([]),\n\t\tgrant_types: Optional(anyOf('authorization_code','refresh_token')), //TODO: match response_types with grant_types\n\t\tapplication_type: Optional(oneOf('native','web')),\n\t\tcontacts: Optional([validEmail]),\n\t\tclient_name: Optional(String),\n\t\tlogo_uri: Optional(validURL),\n\t\tclient_uri: Optional(validURL),\n\t\tpolicy_uri: Optional(validURL),\n\t\ttos_uri: Optional(validURL),\n\t\tjwks_uri: Optional(validURL, not(MustHave('jwks'))),\n\t\tjwks: Optional(validURL, not(MustHave('jwks_uri'))),\n\t\tsector_identifier_uri: Optional(validURL),\n\t\tsubject_type: Optional(String),\n\t\tid_token_signed_response_alg: Optional(oneOf(...validJWA)),\n\t\tid_token_encrypted_response_alg: Optional(oneOf(...validJWA)),\n\t\tid_token_encrypted_response_enc: Optional(oneOf(...validJWA), MustHave('id_token_encrypted_response_alg')),\n\t\tuserinfo_signed_response_alg: Optional(oneOf(...validJWA)),\n\t\tuserinfo_encrypted_response_alg: Optional(oneOf(...validJWA)),\n\t\tuserinfo_encrypted_response_enc: Optional(oneOf(...validJWA), MustHave('userinfo_encrypted_response_alg')),\n\t\trequest_object_signing_alg: Optional(oneOf(...validJWA)),\n\t\trequest_object_encryption_alg: Optional(oneOf(...validJWA)),\n\t\trequest_object_encryption_enc: Optional(oneOf(...validJWA)),\n\t\ttoken_endpoint_auth_method: Optional(oneOf(...validAuthMethods)),\n\t\ttoken_endpoint_auth_signing_alg: Optional(oneOf(...validJWA)),\n\t\tdefault_max_age: Optional(Number),\n\t\trequire_auth_time: Optional(Boolean),\n\t\tdefault_acr_values: Optional([String]),\n\t\tinitiate_login_uri: Optional([validURL]),\n\t\trequest_uris: Optional([validURL])\n\t}\n\n\tassert(options, {\n\t\tclient: Optional(instanceOf(metro.client().constructor)),\n\t\tregistration_endpoint: validURL, \n\t\tclient_info: openid_client_metadata\n\t})\n\n\tconst defaultOptions = {\n\t\tclient: metro.client().with(throwermw()).with(jsonmw())\n\t}\n\n\toptions = Object.assign({}, defaultOptions, options)\n\n\n\tlet response = await options.client\n\t\t.post(options.registration_endpoint, {\n\t\t\tbody: options.client_info\n\t\t})\n\tlet info = response.body\n\tif (!info.client_id || !info.client_secret) {\n\t\tthrow metro.metroError('metro.oidc: Error: dynamic registration of client failed, no client_id or client_secret returned', response)\n\t}\n\toptions.client_info = Object.assign(options.client_info, info)\n\treturn options.client_info\n}", "/**\n * assertEnabled (Boolean) used to toggle whether the assert()\n * method should test assertions or not.\n */\nglobalThis.assertEnabled = false\n\n/**\n * Enables assertion testing with assert()\n */\nexport function enable() {\n\tglobalThis.assertEnabled = true\n}\n\n/**\n * Disables assertion testing with assert()\n */\nexport function disable() {\n\tglobalThis.assertEnabled = false\n}\n\n/**\n * This function will check the source for the assertions in test, if\n * assertion checking is enabled globally.\n * If it is, and any assertion fails, it will throw an assertError\n * with a list of problems and other details.\n */\nexport const assert = (source, test) => {\n\tif (globalThis.assertEnabled) {\n\t\tlet problems = fails(source,test)\n\t\tif (problems) {\n\t\t\tthrow new assertError('Assertions failed', problems, source)\n\t\t}\n\t}\n}\n\n/**\n * Tests a given value against a pattern, only if the value is not null or undefined\n */\nexport const Optional = (pattern) => \n\t(data) => (data==null || typeof data == 'undefined') ? false : fails(data, pattern)\n\n/**\n * Tests a given value against a pattern, always.\n */\nexport const Required = (pattern) =>\n\t(data) => fails(data, pattern)\n\n/**\n * Tests a given value against a pattern, only if the value is not null or undefined\n * If null or undefined, it does print a warning to the console.\n */\nexport const Recommended = (pattern) =>\n\t(data) => (data==null || typeof data == 'undefined') ? (() => {\n\t\tconsole.warning('data does not contain recommended value', data, pattern)\n\t\treturn false\n\t})() : fails(data, pattern)\n\n/**\n * Tests a given value against a set of patterns, untill one succeeds\n * Returns an error if none succeed\n */\nexport const oneOf = (...patterns) => \n\t(data) => {\n\t\tfor(let pattern of patterns) {\n\t\t\tif (!fails(data, pattern)) {\n\t\t\t\treturn false\n\t\t\t}\n\t\t}\n\t\treturn error('data does not match oneOf patterns',data,patterns)\n\t}\n\n/**\n * Tests a given array of values against a set of patterns\n * If any value does not match one of the patterns, it will return an error\n * If not given an array to test, it will return an error\n */\nexport const anyOf = (...patterns) =>\n\t(data) => {\n\t\tif (!Array.isArray(data)) {\n\t\t\treturn error('data is not an array',data,'anyOf')\n\t\t}\n\t\tfor (let value of data) {\n\t\t\tif (oneOf(...patterns)(value)) {\n\t\t\t\treturn error('data does not match anyOf patterns',value,patterns)\n\t\t\t}\n\t\t}\n\t\treturn false\n\t}\n\n/**\n * Tests a given value to see if it is a valid (and absolute) URL, by\n * parsing it with the URL() constructor, and then testing the href\n * value to be equal to the initial value.\n */\nexport function validURL(data) {\n\ttry {\n\t\tif (data instanceof URL) {\n\t\t\tdata = data.href\n\t\t}\n\t\tlet url = new URL(data)\n\t\tif (url.href!=data) {\n\t\t\treturn error('data is not a valid url',data,'validURL')\n\t\t}\n\t} catch(e) {\n\t\treturn error('data is not a valid url',data,'validURL')\n\t}\n\treturn false\n}\n\n/**\n * Tests a given value to see if it looks like a valid email address, by\n * testing it against a regular expression. So there are no guarantees that\n * it is an actual working email address, just that it looks like one.\n */\nexport function validEmail(data) {\n\tif (/^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/.test(data)) {\n\t\treturn false // data matches email regex\n\t}\n\treturn error('data is not a valid email',data,'validEmail')\n}\n\n/**\n * Tests a given value to see if it is an object which is an instance of the given\n * constructor\n */\nexport const instanceOf = (constructor) =>\n\t(data) => !(data instanceof constructor) \n\t\t? error('data is not an instanceof pattern',data,constructor)\n\t\t: false\n\n/**\n * Runs the given test pattern on a value, if the test succeeds, it fails\n * the not() test.\n */\nexport const not = (pattern) =>\n\t(data) => fails(data, pattern) \n\t\t? false \n\t\t: error('data matches pattern, when required not to', data, pattern)\n\n/**\n * returns an array of problems if the data fails to satisfy \n * the assertions in the given pattern, false otherwise\n * @param {any} data    The data to match\n * @param {any} pattern The pattern to match\n * @param {any} root    Root object for assertions, set to data by default\n * @return {Array|false} Array with problems if the pattern fails, false otherwise\n */\nexport function fails(data, pattern, root) {\n\tif (!root) {\n\t\troot = data\n\t}\n\tlet problems = []\n\tif (pattern === Boolean) {\n\t\tif (typeof data != 'boolean') {\n\t\t\tproblems.push(error('data is not a boolean', data, pattern))\n\t\t}\t\t\n\t} else if (pattern === Number) {\n\t\tif (typeof data != 'number') {\n\t\t\tproblems.push(error('data is not a number', data, pattern))\n\t\t}\n\t} else if (pattern instanceof RegExp) {\n    \tif (Array.isArray(data)) {\n\t\t\tlet index = data.findIndex(element => fails(element,pattern,root))\n            if (index>-1) {\n            \tproblems.push(error('data['+index+'] does not match pattern', data[index], pattern))\n            }\n    \t} else if (!pattern.test(data)) {\n        \tproblems.push(error('data does not match pattern', data, pattern))\n        }\n    } else if (pattern instanceof Function) {\n        if (pattern(data, root)) {\n        \tproblems.push(error('data does not match function', data, pattern))\n        }\n    } else if (Array.isArray(pattern)) {\n\t\tif (!Array.isArray(data)) {\n\t\t\tproblems.push(error('data is not an array',data,[]))\n\t\t}\n\t\tfor (p of pattern) {\n\t\t\tlet problem = fails(data, p, root)\n\t\t\tif (Array.isArray(problem)) {\n\t\t\t\tproblems.concat(problem)\n\t\t\t} else if (problem) {\n\t\t\t\tproblems.push(problem)\n\t\t\t}\n    \t}\n    } else if (pattern && typeof pattern == 'object') {\n        if (Array.isArray(data)) {\n            let index = data.findIndex(element => fails(element,pattern,root))\n            if (index>-1) {\n            \tproblems.push(error('data['+index+'] does not match pattern', data[index], pattern))\n            }\n        } else if (!data || typeof data != 'object') {\n        \tproblems.push(error('data is not an object, pattern is', data, pattern))\n        } else {\n        \tif (data instanceof URLSearchParams) {\n        \t\tdata = Object.fromEntries(data)\n        \t}\n\t        let p = problems[problems.length-1]\n\t        for (const [wKey, wVal] of Object.entries(pattern)) {\n\t            let result = fails(data[wKey], wVal, root)\n\t            if (result) {\n\t            \tif (!p || typeof p == 'string') {\n\t            \t\tp = {}\n\t            \t\tproblems.push(error(p, data[wKey], wVal))\n\t            \t}\n\t            \tp[wKey] = result.problems\n\t            }\n\t        }\n\t    }\n    } else {\n    \tif (pattern!=data) {\n    \t\tproblems.push(error('data and pattern are not equal', data, pattern))\n    \t}\n    }\n    if (problems.length) {\n    \treturn problems\n    }\n    return false\n}\n\n\n/**\n * Class used in assert() to add problems found and details to the error object\n */\nclass assertError extends Error {\n\tconstructor(message, problems, ...details) {\n\t\tsuper(message)\n\t\tthis.problems = problems\n\t\tthis.details = details\n\t}\n}\n\n/**\n * Returns an object with message, found and expected properties\n */ \nexport function error(message, found, expected) {\n\treturn {\n\t\tmessage,\n\t\tfound,\n\t\texpected\n\t}\n}\n", "export function tokenStore(site) {\n\tlet localState, localTokens\n\tif (typeof localStorage !== 'undefined') {\n\t\tlocalState = {\n\t\t\tget: ()      => localStorage.getItem('metro/state:'+site),\n\t\t\tset: (value) => localStorage.setItem('metro/state:'+site, value),\n\t\t\thas: ()      => localStorage.getItem('metro/state:'+site)!==null\n\t\t}\n\t\tlocalTokens = {\n\t\t\tget: (name)        => JSON.parse(localStorage.getItem(site+':'+name)),\n\t\t\tset: (name, value) => localStorage.setItem(site+':'+name, JSON.stringify(value)),\n\t\t\thas: (name)        => localStorage.getItem(site+':'+name)!==null\n\t\t}\n\t} else {\n\t\tlet stateMap = new Map()\n\t\tlocalState = {\n\t\t\tget: ()      => stateMap.get('metro/state:'+site),\n\t\t\tset: (value) => stateMap.set('metro/state:'+site, value),\n\t\t\thas: ()      => stateMap.has('metro/state:'+site)\n\t\t}\n\t\tlocalTokens = new Map()\n\t}\n\treturn {\n\t\tstate: localState,\n\t\ttokens: localTokens\n\t}\n}", "import metro from '@muze-nl/metro'\nimport { assert, Required, validURL } from '@muze-nl/assert'\nimport {tokenStore} from './tokenstore.mjs'\n\n/**\n * oauth2mw returns a middleware for @muze-nl/metro that\n * implements oauth2 authentication in the metro client.\n * it supports the authorization_code, refresh_token and\n * client_credentials grant_type.\n * Since implicit flow is deemed insecure, it is not supported\n * This library follows the OAuth2.1 RFC - https://datatracker.ietf.org/doc/html/draft-ietf-oauth-v2-1-11)\n * Referenced as Oauth2.1 RFC from here on\n */\nexport default function mwOAuth2(options)\n{\n\n\tconst defaultOptions = {\n\t\tclient: metro.client(),\n\t\tforce_authorization: false,\n\t\tsite: 'default',\n\t\toauth2_configuration: {\n\t\t\tauthorization_endpoint: '/authorize',\n\t\t\ttoken_endpoint: '/token',\n\t\t\tredirect_uri: globalThis.document?.location.href,\n\t\t\tgrant_type: 'authorization_code',\n\t\t\tcode_verifier: security.generateCodeVerifier(64)\n\t\t},\n\t\tcallbacks: {\n\t\t\tauthorize: async url => {\n\t\t\t\tif (window.location.href != url.href) {\n\t\t\t\t\twindow.location.replace(url.href)\n\t\t\t\t}\n\t\t\t\treturn false\n\t\t\t}\n\t\t}\n\t}\n\n\tassert(options, {})\t\n\n\tconst oauth2 = Object.assign({}, defaultOptions.oauth2_configuration, options?.oauth2_configuration)\n\toptions = Object.assign({}, defaultOptions, options)\n\toptions.oauth2_configuration = oauth2\n\n\tconst store = tokenStore(options.site)\n\tif (!options.tokens) {\n\t\toptions.tokens = store.tokens\n\t}\n\tif (!options.state) {\n\t\toptions.state = store.state\n\t}\n\n\tassert(options, {\n\t\toauth2_configuration: {\n\t\t\tclient_id: Required(/.+/),\n\t\t\tgrant_type: 'authorization_code',\n\t\t\tauthorization_endpoint: Required(validURL),\n\t\t\ttoken_endpoint: Required(validURL),\n\t\t\tredirect_uri: Required(validURL)\n\t\t}\n\t})\n\n\tfor (let option in oauth2) {\n\t\tswitch(option) {\n\t\t\tcase 'access_token':\n\t\t\tcase 'authorization_code':\n\t\t\tcase 'refresh_token':\n\t\t\t\toptions.tokens.set(option, oauth2[option])\n\t\t\tbreak\n\t\t}\n\t}\n\n\t/**\n\t * This is the middleware function. It will intercept a request, and if needed\n\t * go through the OAuth2 authorization flow first.\n\t */\n\treturn async function(req, next) {\n\t\tif (options.force_authorization) {\n\t\t\treturn oauth2authorized(req, next)\n\t\t}\n\t\tlet res\n\t\ttry {\n\t\t\tres = await next(req)\n\t\t\tif (res.ok) {\n\t\t\t\treturn res\n\t\t\t}\n\t\t} catch(err) {\n\t\t\tswitch(res.status) { \n\t\t\t\tcase 400: // Oauth2.1 RFC 3.2.4\n\t\t\t\tcase 401: // in case of incorrect authentication method\n\t\t\t\t\t//FIXME: check payload of response as well? yes - may be able to recover\n\t\t\t\t\treturn oauth2authorized(req, next)\n\t\t\t\tbreak\n\t\t\t}\n\t\t\tthrow err\n\t\t}\n\t\treturn res\n\t}\n\n\t/**\n\t * Implements the OAuth2 authorization flow for a request\n\t */\n\tasync function oauth2authorized(req, next)\n\t{\n\t\tgetTokensFromLocation()\n\t\tif (!options.tokens.has('access_token')) {\n\t\t\ttry {\n\t\t\t\tlet token = await fetchAccessToken()\n\t\t\t\tif (!token) {\n\t\t\t\t\treturn metro.response('false')\n\t\t\t\t}\n\t\t\t} catch(e){\n\t\t\t\tconsole.log('caught',e)\n\t\t\t\tthrow(e)\n\t\t\t}\n\t\t\treturn oauth2authorized(req, next)\n\t\t} else if (isExpired(req)) {\n\t\t\tlet token = await fetchRefreshToken()\n\t\t\tif (!token) {\n\t\t\t\treturn metro.response('false')\n\t\t\t}\n\t\t\treturn oauth2authorized(req, next)\n\t\t} else {\n\t\t\tlet accessToken = options.tokens.get('access_token')\n\t\t\treq = metro.request(req, {\n\t\t\t\theaders: {\n\t\t\t\t\tAuthorization: accessToken.type+' '+accessToken.value\n\t\t\t\t}\n\t\t\t})\n\t\t\treturn next(req)\n\t\t}\n\t}\n\n\t/**\n\t * Fetches and stores the authorization_code from a redirected URI\n\t * Then removes the authorization_code from the browser URL\n\t * OAuth2 RFC 4.1.2\n\t */\n\tfunction getTokensFromLocation()\n\t{\n\t\tif (typeof window !== 'undefined' && window?.location) {\n\t\t\tlet url = metro.url(window.location)\n\t\t\tlet code, state, params\n\t\t\tif (url.searchParams.has('code')) {\n\t\t\t\tparams = url.searchParams\n\t\t\t\turl = url.with({ search:'' })\n\t\t\t\thistory.pushState({},'',url.href)\n\t\t\t} else if (url.hash) {\n\t\t\t\tlet query = url.hash.substr(1)\n\t\t\t\tparams = new URLSearchParams('?'+query)\n\t\t\t\turl = url.with({ hash:'' })\n\t\t\t\thistory.pushState({},'',url.href)\n\t\t\t}\n\t\t\tif (params) {\n\t\t\t\tcode = params.get('code')\n\t\t\t\tstate = params.get('state')\n\t\t\t\tlet storedState = options.state.get('metro/state')\n\t\t\t\tif (!state || state!==storedState) {\n\t\t\t\t\treturn\n\t\t\t\t}\n\t\t\t\tif (code) {\n\t\t\t\t\toptions.tokens.set('authorization_code', code)\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Fetches the access_token. If the authorization_code hasn't been retrieved yet,\n\t * it will first try to get that, using the options.callbacks.authorize function.\n\t * If a refresh_token is also returned, it will store that in the options.tokens storage.\n\t */\n\tasync function fetchAccessToken()\n\t{\n\t\tif (oauth2.grant_type === 'authorization_code' && !options.tokens.has('authorization_code')) {\n\t\t\tlet authReqURL = getAuthorizationCodeURL()\n\t\t\tif (!options.callbacks.authorize || typeof options.callbacks.authorize !== 'function') {\n\t\t\t\tthrow metro.metroError('oauth2mw: oauth2 with grant_type:authorization_code requires a callback function in client options.options.callbacks.authorize')\n\t\t\t}\n\t\t\t//FIXME: authorize can do a redirect, so allow for that\n\t\t\tlet token = await options.callbacks.authorize(authReqURL)\n\t\t\tif (token) {\n\t\t\t\toptions.tokens.set('authorization_code', token)\n\t\t\t} else {\n\t\t\t\treturn false\n\t\t\t}\n\t\t}\n\t\tlet tokenReq = getAccessTokenRequest()\n\t\tlet response = await options.client.post(tokenReq) //OAuth2.1 RFC 3.2\n\t\tif (!response.ok) {\n\t\t\tthrow metro.metroError('OAuth2mw: fetch access_token: '+response.status+': '+response.statusText, {cause: tokenReq} )\n\t\t}\n\t\tlet data = await response.json()\n\t\t// OAuth2.1 RFC 3.2.3\n\t\toptions.tokens.set('access_token', {\n\t\t\tvalue: data.access_token,\n\t\t\texpires: getExpires(data.expires_in),\n\t\t\ttype: data.token_type,\n\t\t\tscope: data.scope\n\t\t})\n\t\tif (data.refresh_token) {\n\t\t\tlet token = {\n\t\t\t\tvalue: data.refresh_token\n\t\t\t}\n\t\t\toptions.tokens.set('refresh_token', token)\n\t\t}\n\t\treturn data\n\t}\n\n\t/**\n\t * Fetches a new access_token using a stored refresh_token\n\t * If a new refresh_token is also returned, it will update the stored refresh_token\n\t * OAuth2.1 RFC 4.3\n\t */\n\tasync function fetchRefreshToken()\n\t{\n\t\tlet refreshTokenReq = getAccessTokenRequest('refresh_token')\n\t\tlet response = await options.client.post(refreshTokenReq)\n\t\tif (!response.ok) {\n\t\t\tthrow metro.metroError('OAuth2mw: refresh access_token: '+response.status+': '+response.statusText, {cause: refreshTokenReq} )\n\t\t}\n\t\tlet data = await response.json()\n\t\toptions.tokens.set('access_token', {\n\t\t\tvalue:   data.access_token,\n\t\t\texpires: getExpires(data.expires_in),\n\t\t\ttype:    data.token_type,\n\t\t\tscope:   data.scope\n\t\t})\n\t\tif (data.refresh_token) {\n\t\t\tlet token = {\n\t\t\t\tvalue: data.refresh_token\n\t\t\t}\n\t\t\toptions.tokens.set('refresh_token', token)\n\t\t} else {\n\t\t\treturn false\n\t\t}\n\t\treturn data\n\t}\n\n\t/**\n\t * Returns the URL to use to get a authorization_code\n\t */\n\tfunction getAuthorizationCodeURL()\n\t{\n\t\tif (!oauth2.authorization_endpoint) {\n\t\t\tthrow metro.metroError('oauth2mw: Missing options.oauth2_configuration.authorization_endpoint')\n\t\t}\n\t\tlet url = metro.url(oauth2.authorization_endpoint, {hash: ''}) // OAuth2.1 RFC 3.1\n\t\tassert(oauth2, {\n\t\t\tclient_id: /.+/,\n\t\t\tredirect_uri: /.+/,\n\t\t\tscope: /.*/\n\t\t})\n\t\tlet search = {\n\t\t\tresponse_type: 'code', // implicit flow uses 'token' here, but is not considered safe, so not supported\n\t\t\tclient_id:     oauth2.client_id,\n\t\t\tclient_secret: oauth2.client_secret,\n\t\t\tredirect_uri:  oauth2.redirect_uri,\n\t\t\tstate:         oauth2.state || security.createState(40) // OAuth2.1 RFC says optional, but its a good idea to always add/check it\n\t\t}\n\t\toptions.state.set(search.state)\n\t\tif (oauth2.code_verifier) { //PKCE\n\t\t\tdelete search.client_secret\n\t\t\tsearch.code_challenge = security.generateCodeChallenge(oauth2.code_verifier)\n\t\t\tsearch.code_challenge_method = 'S256'\n\t\t}\n\t\tif (oauth2.scope) {\n\t\t\tsearch.scope = oauth2.scope\n\t\t}\n\t\treturn metro.url(url, { search })\n\t}\n\n\n\t/**\n\t * Returns a token endpoint request with all the correct parameters, given the\n\t * grant_type. This can then be used in a metro.post.\n\t */\n\tfunction getAccessTokenRequest(grant_type=null)\n\t{\n\t\tassert(oauth2, {\n\t\t\tclient_id: /.+/,\n\t\t\tredirect_uri: /.+/\n\t\t})\n\t\tif (!oauth2.token_endpoint) {\n\t\t\tthrow metro.metroError('oauth2mw: Missing options.endpoints.token url')\n\t\t}\n\t\tlet url = metro.url(oauth2.token_endpoint, {hash: ''}) // OAuth2.1 RFC 3.2\n\t\tlet params = {\n\t\t\tgrant_type: grant_type || oauth2.grant_type,\n\t\t\tclient_id:  oauth2.client_id\n\t\t}\n\t\tif (oauth2.code_verifier) { //PKCE\n\t\t\tparams.code_verifier = oauth2.code_verifier\n\t\t} else {\n\t\t\tparams.client_secret = oauth2.client_secret\n\t\t}\n\t\tif (oauth2.scope) {\n\t\t\tparams.scope = oauth2.scope\n\t\t}\n\t\tswitch(oauth2.grant_type) {\n\t\t\tcase 'authorization_code':\n\t\t\t\tparams.redirect_uri = oauth2.redirect_uri\n\t\t\t\tparams.code = options.tokens.get('authorization_code')\n\t\t\tbreak\n\t\t\tcase 'client_credentials':\n\t\t\t\t// nothing to add\n\t\t\tbreak\n\t\t\tcase 'refresh_token':\n\t\t\t\tparams.refresh_token = oauth2.refresh_token\n\t\t\tbreak\n\t\t\tdefault:\n\t\t\t\tthrow new Error('Unknown grant_type: '.oauth2.grant_type)\n\t\t\tbreak\n\t\t}\n\t\treturn metro.request(url, {method: 'POST', body: new URLSearchParams(params) })\n\t}\n\n\t/**\n\t * Returns true if the access token in a request is expired. False otherwise.\n\t */\n\tfunction isExpired(req)\n\t{\n\t\tif (req.oauth2 && req.options.tokens && req.options.tokens.has('access_token')) {\n\t\t\tlet now = new Date();\n\t\t\tlet token = req.options.tokens.get('access_token')\n\t\t\treturn now.getTime() > token.expires.getTime();\n\t\t}\n\t\treturn false;\n\t}\n\n\t/**\n\t * Returns a new Date based on a duration, which can either be a date\n\t * or a number of seconds from now.\n\t */\n\tfunction getExpires(duration)\n\t{\n\t\tif (duration instanceof Date) {\n\t\t\treturn new Date(duration.getTime()); // return a copy\n\t\t}\n\t\tif (typeof duration === 'number') {\n\t\t\tlet date = new Date();\n\t\t\tdate.setSeconds(date.getSeconds() + duration);\n\t\t\treturn date;\n\t\t}\n\t\tthrow new TypeError('Unknown expires type '+duration);\n\t}\n\n\n}\n\nexport const security = {\t\n\t/**\n\t * returns a PKCE code_verifier, as a hex encoded string\n\t */\n\tgenerateCodeVerifier: function(size=64)\n\t{\n\t\tconst code_verifier = new Uint8Array(size)\n\t\tglobalThis.crypto.getRandomValues(code_verifier)\n\t\treturn code_verifier.toString('hex')\n\t},\n\n\t/**\n\t * Returns a PKCE code_challenge derived from a code_verifier\n\t */\n\tgenerateCodeChallenge: async function(code_verifier)\n\t{\n\t\tconst b64encoded = security.base64url_encode(code_verifier)\n\t\tconst encoder = new TextEncoder()\n\t\tconst data = encoder.encode(b64encoded)\n\t\treturn await globalThis.crypto.subtle.digest('SHA-256', data)\n\t},\n\n\t/**\n\t * Base64url encoding, which handles UTF-8 input strings correctly.\n\t */\n\tbase64url_encode: function(buffer)\n\t{\n\t\tconst byteString = Array.from(new Uint8Array(buffer), b => String.fromCharCode(b)).join('')\n\t    return btoa(byteString)\n\t        .replace(/\\+/g, '-')\n\t        .replace(/\\//g, '_')\n\t        .replace(/=+$/, '');\n\t},\n\n\t/**\n\t * Creates and stores a random state to use in the authorization code URL\n\t */\n\tcreateState: function(length)\n\t{\n\t\tconst validChars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789'\n\t\tlet randomState = ''\n\t\tlet counter = 0\n\t    while (counter < length) {\n\t        randomState += validChars.charAt(Math.floor(Math.random() * validChars.length))\n\t        counter++\n\t    }\n\t\treturn randomState\n\t}\n}\n\nexport function isRedirected() {\n\tlet url = new URL(document.location.href)\n\tif (!url.searchParams.has('code')) {\n\t\tif (url.hash) {\n\t\t\tlet query = url.hash.substr(1)\n\t\t\tparams = new URLSearchParams('?'+query)\n\t\t\tif (params.has('code')) {\n\t\t\t\treturn true\n\t\t\t}\n\t\t}\n\t\treturn false\n\t}\n\treturn true\n}", "export default function oidcStore(site) {\n\tlet store\n\tif (typeof localStorage !== 'undefined') {\n\t\tstore = {\n\t\t\tget: (name)        => JSON.parse(localStorage.getItem('metro/oidc:'+site+':'+name)),\n\t\t\tset: (name, value) => localStorage.setItem('metro/oidc:'+site+':'+name, JSON.stringify(value)),\n\t\t\thas: (name)        => localStorage.getItem('metro/oidc:'+site+':'+name)!==null\n\t\t}\n\t} else {\n\t\tlet storeMap = new Map()\n\t\tstore = {\n\t\t\tget: (name)        => JSON.parse(storeMap.get('metro/oidc:'+site+':'+name)||null),\n\t\t\tset: (name, value) => storeMap.set('metro/oidc:'+site+':'+name, JSON.stringify(value)),\n\t\t\thas: (name)        => storeMap.has('metro/oidc:'+site+':'+name)\n\t\t}\n\t}\n\treturn store\n}", "import metro from '@muze-nl/metro'\nimport oauth2mw, { isRedirected as oauth2isRedirected } from '@muze-nl/metro-oauth2'\nimport { assert, Required, Optional, validURL, instanceOf } from '@muze-nl/assert'\nimport discover from './oidc.discovery.mjs'\nimport register from './oidc.register.mjs'\nimport oidcStore from './oidc.store.mjs'\n\nexport default function oidcmw(options={}) {\n\n\tconst defaultOptions = {\n\t\tclient: metro.client(),\n\t\tforce_authorization: false\n\t}\n\n\toptions = Object.assign({}, defaultOptions, options)\n\n\tassert(options, {\n\t\tclient: Required(instanceOf(metro.client().constructor)), // required because it is set in defaultOptions\n\t\tclient_info: Required(),\n\t\tissuer: Required(validURL),\n\t\toauth2: Optional({}),\n\t\topenid_configuration: Optional()\n\t})\n\n\tif (!options.store) {\n\t\toptions.store = oidcStore(options.issuer)\n\t}\n\tif (!options.openid_configuration && options.store.has('openid_configuration')) {\n\t\toptions.openid_configuration = options.store.get('openid_configuration')\n\t}\n\tif (!options.client_info.client_id && options.store.has('client_info')) {\n\t\toptions.client_info = options.store.get('client_info')\n\t}\n\n\treturn async (req, next) => {\n\t\tlet res\n\t\tif (!options.force_authorization) {\n\t\t\ttry {\n\t\t\t\tres = await next(req)\n\t\t\t} catch(err) {\n\t\t\t\tif (res.status!=401 && res.status!=403) {\n\t\t\t\t\tthrow err\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (res.ok || (res.status!=401 && res.status!=403)) {\n\t\t\t\treturn res\n\t\t\t}\n\t\t}\n\t\tif (!options.openid_configuration) {\n\t\t\toptions.openid_configuration = await discover({\n\t\t\t\tissuer: options.issuer\n\t\t\t})\n\t\t\toptions.store.set('openid_configuration', options.openid_configuration)\n\t\t}\n\n\t\tif (!options.client_info?.client_id) {\n\t\t\tassert(options.client_info?.client_name, Required())\n\t\t\tif (!options.openid_configuration.registration_endpoint) {\n\t\t\t\tthrow metro.metroError('metro.oidcmw: Error: issuer '+options.issuer+' does not support dynamic client registration, but you haven\\'t specified a client_id')\n\t\t\t}\n\t\t\toptions.client_info = await register({\n\t\t\t\tregistration_endpoint: options.openid_configuration.registration_endpoint,\n\t\t\t\tclient_info: options.client_info\n\t\t\t})\n\t\t\toptions.store.set('client_info', options.client_info)\n\t\t}\n\n\t\t// now initialize an oauth2 client stack, using options.client as default\n\t\t// with forceAuthentication: true\n\t\tconst oauth2Options = Object.assign(\n\t\t\t{\n\t\t\t\tsite: options.issuer,\n\t\t\t\tclient: options.client,\n\t\t\t\tforce_authorization: true,\n\t\t\t\toauth2_configuration: {\n\t\t\t\t\tclient_id: options.client_info.client_id,\n\t\t\t\t\tclient_secret: options.client_info.client_secret,\n\t\t\t\t\tcode_verifier: false, //disable pkce\n\t\t\t\t\tgrant_type: 'authorization_code',\n\t\t\t\t\tauthorization_endpoint: options.openid_configuration.authorization_endpoint,\n\t\t\t\t\ttoken_endpoint: options.openid_configuration.token_endpoint,\n\t\t\t\t\tscope: options.openid_configuration.scope || 'openid',\n\t\t\t\t\tredirect_uri: options.client_info.redirect_uris[0] //FIXME: find the best match?\n\t\t\t\t}\n\t\t\t}\n\t\t\t//...\n\t\t)\n\t\tconst oauth2client = options.client.with(options.issuer)\n\t\t// optional: add oauth2dpop mw\n\t\t.with(oauth2mw(oauth2Options))\n\n\t\tres = await oauth2client.fetch(req)\n\t\t// ...\n\n\t\treturn res\n\t}\n\n}\n\nexport function isRedirected() {\n\treturn oauth2isRedirected()\n}", "import oidcDiscover from './oidc.discovery.mjs'\nimport oidcRegister from './oidc.register.mjs'\nimport oidcmw, {isRedirected} from './oidcmw.mjs'\n\nexport const oidc = {\n\tdiscover: oidcDiscover,\n\tregister: oidcRegister,\n\toidcmw,\n\tisRedirected\n}\n\nglobalThis.oidc = oidc"],
  "mappings": "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",
  "names": ["metro_exports", "__export", "client", "formdata", "metroError", "request", "response", "trace", "url", "metroURL", "Client", "_Client", "#options", "#verbs", "options", "option", "#addMiddlewares", "param", "verb", "middlewares", "index", "m", "req", "body", "res", "next", "middleware", "tracers", "tracer", "bodyProxy", "body", "r", "source", "controller", "chunk", "metroError", "target", "prop", "receiver", "args", "getRequestParams", "req", "current", "params", "url", "key", "value", "request", "options", "requestParams", "option", "getResponseParams", "res", "response", "responseParams", "appendSearchParams", "validParams", "u", "param", "metroURL", "formdata", "entry", "metroConsole", "message", "details", "name", "trace", "tracer", "Client", "group", "middleware", "jsonmw", "options", "req", "next", "res", "body", "json", "thrower", "options", "req", "next", "res", "metro", "metro_exports", "jsonmw", "thrower", "everything_default", "assert", "source", "test", "problems", "fails", "Optional", "pattern", "data", "root", "path", "Required", "error", "Recommended", "oneOf", "patterns", "anyOf", "value", "allOf", "validURL", "url", "validEmail", "instanceOf", "constructor", "not", "index", "element", "problem", "p", "result", "wKey", "wVal", "message", "found", "expected", "MustHave", "options", "value", "root", "o", "error", "MustInclude", "validJWA", "validAuthMethods", "oidcDiscovery", "options", "assert", "Optional", "instanceOf", "everything_default", "Required", "validURL", "defaultOptions", "thrower", "jsonmw", "TestSucceeded", "MustUseHTTPS", "url", "openid_provider_metadata", "allOf", "Recommended", "MustInclude", "anyOf", "validAuthMethods", "not", "configURL", "openid_config", "register", "options", "openid_client_metadata", "Required", "validURL", "Optional", "anyOf", "oneOf", "validEmail", "not", "MustHave", "validJWA", "validAuthMethods", "assert", "instanceOf", "everything_default", "defaultOptions", "thrower", "jsonmw", "response", "info", "assert", "source", "test", "problems", "fails", "assertError", "Required", "pattern", "data", "fails", "validURL", "data", "error", "fails", "data", "pattern", "root", "problems", "error", "index", "element", "problem", "p", "wKey", "wVal", "result", "assertError", "message", "details", "found", "expected", "tokenStore", "site", "localState", "localTokens", "value", "name", "stateMap", "mwOAuth2", "options", "defaultOptions", "everything_default", "security", "url", "assert", "oauth2", "store", "tokenStore", "Required", "validURL", "option", "req", "next", "oauth2authorized", "res", "err", "getTokensFromLocation", "isExpired", "fetchRefreshToken", "accessToken", "fetchAccessToken", "e", "code", "state", "params", "query", "storedState", "authReqURL", "getAuthorizationCodeURL", "token", "tokenReq", "getAccessTokenRequest", "response", "data", "getExpires", "refreshTokenReq", "search", "grant_type", "now", "duration", "date", "size", "code_verifier", "b64encoded", "buffer", "byteString", "b", "length", "validChars", "randomState", "counter", "isRedirected", "oidcStore", "site", "store", "name", "value", "storeMap", "oidcmw", "options", "defaultOptions", "everything_default", "assert", "Required", "instanceOf", "validURL", "Optional", "oidcStore", "req", "next", "res", "err", "oidcDiscovery", "register", "oauth2Options", "mwOAuth2", "isRedirected", "oidc", "oidcDiscovery", "register", "oidcmw", "isRedirected"]
}
