(()=>{var We=Object.defineProperty;var X=(e,r)=>{for(var t in r)We(e,t,{get:r[t],enumerable:!0})};var fe={};X(fe,{client:()=>$e,formdata:()=>xe,metroError:()=>j,request:()=>q,response:()=>le,trace:()=>Ye,url:()=>ee});var B="https://metro.muze.nl/details/";Symbol.metroProxy||(Symbol.metroProxy=Symbol("isProxy"));Symbol.metroSource||(Symbol.metroSource=Symbol("source"));var K=class e{#e={url:typeof window<"u"?window.location:"https://localhost"};#t=["get","post","put","delete","patch","head","options","query"];static tracers={};constructor(...r){for(let t of r)if(typeof t=="string"||t instanceof String)this.#e.url=""+t;else if(t instanceof e)Object.assign(this.#e,t.#e);else if(t instanceof Function)this.#r([t]);else if(t&&typeof t=="object")for(let n in t)n=="middlewares"?this.#r(t[n]):typeof t[n]=="function"?this.#e[n]=t[n](this.#e[n],this.#e):this.#e[n]=t[n];this.#e.verbs&&(this.#t=this.#e.verbs,delete this.#e.verbs);for(let t of this.#t)this[t]=async function(...n){return this.fetch(q(this.#e,...n,{method:t.toUpperCase()}))};Object.freeze(this)}#r(r){typeof r=="function"&&(r=[r]);let t=r.findIndex(n=>typeof n!="function");if(t>=0)throw j("metro.client: middlewares must be a function or an array of functions "+B+"client/invalid-middlewares-value/",r[t]);Array.isArray(this.#e.middlewares)||(this.#e.middlewares=[]),this.#e.middlewares=this.#e.middlewares.concat(r)}fetch(r,t){if(r=q(r,t),!r.url)throw j("metro.client."+r.method.toLowerCase()+": Missing url parameter "+B+"client/missing-url-param/",r);if(t||(t={}),typeof t!="object"||Array.isArray(t)||t instanceof String)throw j("metro.client.fetch: Options is not an object");let o=[async function(a){if(a[Symbol.metroProxy])if(a.body&&a.body[Symbol.metroSource]){let g=a.body[Symbol.metroSource];a=new Request(a[Symbol.metroSource],{body:g})}else a=a[Symbol.metroSource];let y=await fetch(a);return le(y)}].concat(this.#e?.middlewares?.slice()||[]);t=Object.assign({},this.#e,t);let i;for(let c of o)i=function(a,y){return async function(g){let u,d=Object.values(e.tracers);for(let l of d)l.request&&l.request.call(l,g,y);u=await y(g,a);for(let l of d)l.response&&l.response.call(l,u,y);return u}}(i,c);return i(r)}with(...r){return new e(this,...r)}};function $e(...e){return new K(...e)}function ue(e,r){let t=r.body;return t||(e===null?t=new ReadableStream:e instanceof ReadableStream?t=e:e instanceof Blob?t=e.stream():t=new ReadableStream({start(n){let o;switch(typeof e){case"object":if(typeof e.toString=="function")o=e.toString();else if(e instanceof FormData)o=new URLSearchParams(e).toString();else if(e instanceof ArrayBuffer||ArrayBuffer.isView(e))o=e;else throw j("Cannot convert body to ReadableStream",e);break;case"string":case"number":case"boolean":o=e;break;default:throw j("Cannot convert body to ReadableStream",e)}n.enqueue(o),n.close()}})),new Proxy(t,{get(n,o,i){switch(o){case Symbol.metroProxy:return!0;case Symbol.metroSource:return e;case"toString":return function(){return""+e}}if(e&&typeof e=="object"&&o in e)return typeof e[o]=="function"?function(...c){return e[o].apply(e,c)}:e[o];if(o in n&&o!="toString")return typeof n[o]=="function"?function(...c){return n[o].apply(n,c)}:n[o]},has(n,o){return e&&typeof e=="object"?o in e:o in n},ownKeys(n){return Reflect.ownKeys(e&&typeof e=="object"?e:n)},getOwnPropertyDescriptor(n,o){return Object.getOwnPropertyDescriptor(e&&typeof e=="object"?e:n,o)}})}function Qe(e,r){let t=r||{};!t.url&&r.url&&(t.url=r.url);for(let n of["method","headers","body","mode","credentials","cache","redirect","referrer","referrerPolicy","integrity","keepalive","signal","priority","url"]){let o=e[n];if(!(typeof o>"u"||o==null))if(o?.[Symbol.metroProxy]&&(o=o[Symbol.metroSource]),typeof o=="function")o(t[n],t);else if(n=="url")t.url=ee(t.url,o);else if(n=="headers"){t.headers=new Headers(r.headers),o instanceof Headers||(o=new Headers(e.headers));for(let[i,c]of o.entries())t.headers.set(i,c)}else t[n]=o}return t}function q(...e){let r={url:typeof window<"u"?window.location:"https://localhost/",duplex:"half"};for(let o of e)typeof o=="string"||o instanceof URL||o instanceof URLSearchParams?r.url=ee(r.url,o):o&&(o instanceof FormData||o instanceof ReadableStream||o instanceof Blob||o instanceof ArrayBuffer||o instanceof DataView)?r.body=o:o&&typeof o=="object"&&Object.assign(r,Qe(o,r));let t=r.body;t&&typeof t=="object"&&!(t instanceof String)&&!(t instanceof ReadableStream)&&!(t instanceof Blob)&&!(t instanceof ArrayBuffer)&&!(t instanceof DataView)&&!(t instanceof FormData)&&!(t instanceof URLSearchParams)&&(typeof TypedArray>"u"||!(t instanceof TypedArray))&&(r.body=JSON.stringify(t));let n=new Request(r.url,r);return Object.freeze(n),new Proxy(n,{get(o,i,c){switch(i){case Symbol.metroSource:return o;case Symbol.metroProxy:return!0;case"with":return function(...a){return t&&a.unshift({body:t}),q(o,...a)};case"body":if(t||(t=o.body),t)return t[Symbol.metroProxy]?t:ue(t,o);break}return o[i]instanceof Function?o[i].bind(o):o[i]}})}function Se(e,r){let t=r||{};!t.url&&r.url&&(t.url=r.url);for(let n of["status","statusText","headers","body","url","type","redirected"]){let o=e[n];typeof o>"u"||o==null||(o?.[Symbol.metroProxy]&&(o=o[Symbol.metroSource]),typeof o=="function"?o(t[n],t):n=="url"?t.url=new URL(o,t.url||"https://localhost/"):t[n]=o)}return t}function le(...e){let r={};for(let n of e)typeof n=="string"?r.body=n:n instanceof Response?Object.assign(r,Se(n,r)):n&&typeof n=="object"&&(n instanceof FormData||n instanceof Blob||n instanceof ArrayBuffer||n instanceof DataView||n instanceof ReadableStream||n instanceof URLSearchParams||n instanceof String||typeof TypedArray<"u"&&n instanceof TypedArray?r.body=n:Object.assign(r,Se(n,r)));let t=new Response(r.body,r);return Object.freeze(t),new Proxy(t,{get(n,o,i){switch(o){case Symbol.metroProxy:return!0;case Symbol.metroSource:return n;case"with":return function(...c){return le(n,...c)};case"body":return r.body?r.body[Symbol.metroProxy]?r.body:ue(r.body,n):ue("",n);case"ok":return n.status>=200&&n.status<400;case"headers":return n.headers;default:if(o in r&&o!="toString")return r[o];if(o in n&&o!="toString")return typeof n[o]=="function"?function(...c){return n[o].apply(n,c)}:n[o];break}}})}function ke(e,r){typeof r=="function"?r(e.searchParams,e):(r=new URLSearchParams(r),r.forEach((t,n)=>{e.searchParams.append(n,t)}))}function ee(...e){let r=["hash","host","hostname","href","password","pathname","port","protocol","username","search","searchParams"],t=new URL("https://localhost/");for(let n of e)if(typeof n=="string"||n instanceof String)t=new URL(n,t);else if(n instanceof URL||typeof Location<"u"&&n instanceof Location)t=new URL(n);else if(n instanceof URLSearchParams)ke(t,n);else if(n&&typeof n=="object")for(let o in n)if(o=="search")typeof n.search=="function"?n.search(t.search,t):t.search=new URLSearchParams(n.search);else if(o=="searchParams")ke(t,n.searchParams);else{if(!r.includes(o))throw j("metro.url: unknown url parameter "+B+"url/unknown-param-name/",o);if(typeof n[o]=="function")n[o](t[o],t);else if(typeof n[o]=="string"||n[o]instanceof String||typeof n[o]=="number"||n[o]instanceof Number||typeof n[o]=="boolean"||n[o]instanceof Boolean)t[o]=""+n[o];else if(typeof n[o]=="object"&&n[o].toString)t[o]=n[o].toString();else throw j("metro.url: unsupported value for "+o+" "+B+"url/unsupported-param-value/",e[o])}else throw j("metro.url: unsupported option value "+B+"url/unsupported-option-value/",n);return Object.freeze(t),new Proxy(t,{get(n,o,i){switch(o){case Symbol.metroProxy:return!0;case Symbol.metroSource:return n;case"with":return function(...c){return ee(n,...c)}}return n[o]instanceof Function?n[o].bind(n):n[o]}})}function xe(...e){var r=new FormData;for(let t of e)if(t instanceof FormData)for(let n of t.entries())r.append(n[0],n[1]);else if(t&&typeof t=="object")for(let n of Object.entries(t))if(Array.isArray(n[1]))for(let o of n[1])r.append(n[0],o);else r.append(n[0],n[1]);else throw new j("metro.formdata: unknown option type, only FormData or Object supported",t);return Object.freeze(r),new Proxy(r,{get:(t,n,o)=>{switch(n){case Symbol.metroProxy:return!0;case Symbol.metroSource:return t;case"with":return function(...i){return xe(t,...i)}}return t[n]instanceof Function?t[n].bind(t):t[n]}})}var N={error:(e,...r)=>{console.error("\u24C2\uFE0F  ",e,...r)},info:(e,...r)=>{console.info("\u24C2\uFE0F  ",e,...r)},group:e=>{console.group("\u24C2\uFE0F  "+e)},groupEnd:e=>{console.groupEnd("\u24C2\uFE0F  "+e)}};function j(e,...r){return N.error(e,...r),new Error(e,...r)}var Ye={add(e,r){K.tracers[e]=r},delete(e){delete K.tracers[e]},clear(){K.tracers={}},group(){let e=0;return{request:(r,t)=>{e++,N.group(e),N.info(r?.url,r,t)},response:(r,t)=>{N.info(r?.body?r.body[Symbol.metroSource]:null,r,t),N.groupEnd(e),e--}}}};function C(e){return e=Object.assign({reviver:null,replacer:null,space:""},e),async(r,t)=>{["POST","PUT","PATCH","QUERY"].includes(r.method)?(r=r.with({headers:{"Content-Type":"application/json",Accept:"application/json"}}),r.body&&typeof r.body[Symbol.metroSource]=="object"&&(r=r.with({body:JSON.stringify(r.body[Symbol.metroSource],e.replacer,e.space)}))):r=r.with({headers:{Accept:"application/json"}});let n=await t(r),o=await n.text(),i=JSON.parse(o,e.reviver);return n.with({body:i})}}function D(e){return async(r,t)=>{let n=await t(r);if(!n.ok)if(e&&typeof e[n.status]=="function")n=e[n.status].apply(n,r);else throw new Error(n.status+": "+n.statusText,{cause:n});return n}}var ve=Object.assign({},fe,{mw:{jsonmw:C,thrower:D}});globalThis.metro=ve;var f=ve;globalThis.assertEnabled=!1;function E(e,r){if(globalThis.assertEnabled){let t=A(e,r);if(t)throw console.error("\u{1F170}\uFE0F  Assertions failed because of:",t,"in this source:",e),new Error("Assertions failed",{cause:{problems:t,source:e}})}}function s(e){return function(t,n,o){if(typeof t<"u"&&t!=null&&typeof e<"u")return A(t,e,n,o)}}function S(e){return function(t,n,o){return t==null||typeof t>"u"?_("data is required",t,e||"any value",o):typeof e<"u"?A(t,e,n,o):!1}}function J(e){return function(t,n,o){return t==null||typeof t>"u"?(console.warn("data does not contain recommended value",t,e,o),!1):A(t,e,n,o)}}function v(...e){return function(t,n,o){for(let i of e)if(!A(t,i,n,o))return!1;return _("data does not match oneOf patterns",t,e,o)}}function H(...e){return function(t,n,o){if(!Array.isArray(t))return _("data is not an array",t,"anyOf",o);for(let i of t)if(v(...e)(i))return _("data does not match anyOf patterns",i,e,o);return!1}}function Re(...e){return function(t,n,o){let i=[];for(let c of e)i=i.concat(A(t,c,n,o));if(i=i.filter(Boolean),i.length)return _("data does not match all given patterns",t,e,o,i)}}function m(e,r,t){try{e instanceof URL&&(e=e.href);let n=new URL(e);if(n.href!=e&&!(n.href+"/"==e||n.href==e+"/"))return _("data is not a valid url",e,"validURL",t)}catch{return _("data is not a valid url",e,"validURL",t)}}function Ae(e,r,t){if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e))return _("data is not a valid email",e,"validEmail",t)}function I(e){return function(t,n,o){if(!(t instanceof e))return _("data is not an instanceof pattern",t,e,o)}}function M(e){return function(t,n,o){if(!A(t,e,n,o))return _("data matches pattern, when required not to",t,e,o)}}function A(e,r,t,n=""){t||(t=e);let o=[];if(r===Boolean)typeof e!="boolean"&&!(e instanceof Boolean)&&o.push(_("data is not a boolean",e,r,n));else if(r===Number)typeof e!="number"&&!(e instanceof Number)&&o.push(_("data is not a number",e,r,n));else if(r===String)typeof e!="string"&&!(e instanceof String)&&o.push(_("data is not a string",e,r,n)),e==""&&o.push(_("data is an empty string, which is not allowed",e,r,n));else if(r instanceof RegExp)if(Array.isArray(e)){let i=e.findIndex((c,a)=>A(c,r,t,n+"["+a+"]"));i>-1&&o.push(_("data["+i+"] does not match pattern",e[i],r,n+"["+i+"]"))}else typeof e>"u"?o.push(_("data is undefined, should match pattern",e,r,n)):r.test(e)||o.push(_("data does not match pattern",e,r,n));else if(r instanceof Function){let i=r(e,t,n);i&&(Array.isArray(i)?o=o.concat(i):o.push(i))}else if(Array.isArray(r)){Array.isArray(e)||o.push(_("data is not an array",e,[],n));for(let i of r)for(let c of e.keys()){let a=A(e[c],i,t,n+"["+c+"]");Array.isArray(a)?o=o.concat(a):a&&o.push(a)}}else if(r&&typeof r=="object")if(Array.isArray(e)){let i=e.findIndex((c,a)=>A(c,r,t,n+"["+a+"]"));i>-1&&o.push(_("data["+i+"] does not match pattern",e[i],r,n+"["+i+"]"))}else if(!e||typeof e!="object")o.push(_("data is not an object, pattern is",e,r,n));else if(e instanceof URLSearchParams&&(e=Object.fromEntries(e)),r instanceof Function){let i=A(e,r,t,n);i&&(o=o.concat(i))}else for(let[i,c]of Object.entries(r)){let a=A(e[i],c,t,n+"."+i);a&&(o=o.concat(a))}else r!=e&&o.push(_("data and pattern are not equal",e,r,n));return o.length?o:!1}function _(e,r,t,n,o){let i={message:e,found:r,expected:t,path:n};return o&&(i.problems=o),i}var F=(...e)=>(r,t)=>e.filter(n=>t.hasOwnKey(n)).length>0?!1:_("root data must have all of",t,e),T=(...e)=>r=>Array.isArray(r)&&e.filter(t=>!r.includes(t)).length==0?!1:_("data must be an array which includes",r,e);var P=["HS256","HS384","HS512","RS256","RS384","RS512","ES256","ES384","ES512"],te=["client_secret_post","client_secret_basic","client_secret_jwt","private_key_jwt"];async function V(e={}){E(e,{client:s(I(f.client().constructor)),issuer:S(m)});let r={client:f.client().with(D()).with(C()),requireDynamicRegistration:!1};e=Object.assign({},r,e);let t=!1;function n(y){return t}let o={issuer:S(Re(e.issuer,n)),authorization_endpoint:S(m),token_endpoint:S(m),userinfo_endpoint:J(m),jwks_uri:S(m),registration_endpoint:e.requireDynamicRegistration?S(m):J(m),scopes_supported:J(T("openid")),response_types_supported:e.requireDynamicRegistration?S(T("code","id_token","id_token token")):S([]),response_modes_supported:s([]),grant_types_supported:e.requireDynamicRegistration?s(T("authorization_code")):s([]),acr_values_supported:s([]),subject_types_supported:S([]),id_token_signing_alg_values_supported:S(T("RS256")),id_token_encryption_alg_values_supported:s([]),id_token_encryption_enc_values_supported:s([]),userinfo_signing_alg_values_supported:s([]),userinfo_encryption_alg_values_supported:s([]),userinfo_encryption_enc_values_supported:s([]),request_object_signing_alg_values_supported:s(T("RS256")),request_object_encryption_alg_values_supported:s([]),request_object_encryption_enc_values_supported:s([]),token_endpoint_auth_methods_supported:s(H(...te)),token_endpoint_auth_signing_alg_values_supported:s(T("RS256"),M(T("none"))),display_values_supported:s(H("page","popup","touch","wap")),claim_types_supported:s(H("normal","aggregated","distributed")),claims_supported:J([]),service_documentation:s(m),claims_locales_supported:s([]),ui_locales_supported:s([]),claims_parameter_supported:s(Boolean),request_parameter_supported:s(Boolean),request_uri_parameter_supported:s(Boolean),op_policy_uri:s(m),op_tos_uri:s(m)},i=f.url(e.issuer,".well-known/openid-configuration"),a=(await e.client.get(i)).body[Symbol.metroSource];return E(a,o),E(a.issuer,e.issuer),a}async function W(e){let r={redirect_uris:S([m]),response_types:s([]),grant_types:s(H("authorization_code","refresh_token")),application_type:s(v("native","web")),contacts:s([Ae]),client_name:s(String),logo_uri:s(m),client_uri:s(m),policy_uri:s(m),tos_uri:s(m),jwks_uri:s(m,M(F("jwks"))),jwks:s(m,M(F("jwks_uri"))),sector_identifier_uri:s(m),subject_type:s(String),id_token_signed_response_alg:s(v(...P)),id_token_encrypted_response_alg:s(v(...P)),id_token_encrypted_response_enc:s(v(...P),F("id_token_encrypted_response_alg")),userinfo_signed_response_alg:s(v(...P)),userinfo_encrypted_response_alg:s(v(...P)),userinfo_encrypted_response_enc:s(v(...P),F("userinfo_encrypted_response_alg")),request_object_signing_alg:s(v(...P)),request_object_encryption_alg:s(v(...P)),request_object_encryption_enc:s(v(...P)),token_endpoint_auth_method:s(v(...te)),token_endpoint_auth_signing_alg:s(v(...P)),default_max_age:s(Number),require_auth_time:s(Boolean),default_acr_values:s([String]),initiate_login_uri:s([m]),request_uris:s([m])};E(e,{client:s(I(f.client().constructor)),registration_endpoint:m,client_info:r});let t={client:f.client().with(D()).with(C())};e=Object.assign({},t,e);let n=await e.client.post(e.registration_endpoint,{body:e.client_info}),o=n.body;if(!o.client_id||!o.client_secret)throw f.metroError("metro.oidc: Error: dynamic registration of client failed, no client_id or client_secret returned",n);return e.client_info=Object.assign(e.client_info,o),e.client_info}var he={};X(he,{base64url_encode:()=>ne,createState:()=>ze,default:()=>oe,generateCodeChallenge:()=>Te,generateCodeVerifier:()=>Ee,getExpires:()=>pe,isExpired:()=>je,isRedirected:()=>Ge});globalThis.assertEnabled=!1;var O=(e,r)=>{if(globalThis.assertEnabled){let t=R(e,r);if(t)throw new de("Assertions failed",t,e)}},b=e=>r=>r==null||typeof r>"u"?!1:R(r,e),x=e=>r=>R(r,e),Pe=e=>r=>r==null||typeof r>"u"?(console.warning("data does not contain recommended value",r,e),!1):R(r,e),$=(...e)=>r=>{for(let t of e)if(!R(r,t))return!1;return k("data does not match oneOf patterns",r,e)},Oe=(...e)=>r=>{if(!Array.isArray(r))return k("data is not an array",r,"anyOf");for(let t of r)if($(...e)(t))return k("data does not match anyOf patterns",t,e);return!1};function w(e){try{if(e instanceof URL&&(e=e.href),new URL(e).href!=e)return k("data is not a valid url",e,"validURL")}catch{return k("data is not a valid url",e,"validURL")}return!1}function R(e,r,t){t||(t=e);let n=[];if(r===Boolean)typeof e!="boolean"&&n.push(k("data is not a boolean",e,r));else if(r===Number)typeof e!="number"&&n.push(k("data is not a number",e,r));else if(r instanceof RegExp)if(Array.isArray(e)){let o=e.findIndex(i=>R(i,r,t));o>-1&&n.push(k("data["+o+"] does not match pattern",e[o],r))}else r.test(e)||n.push(k("data does not match pattern",e,r));else if(r instanceof Function)r(e,t)&&n.push(k("data does not match function",e,r));else if(Array.isArray(r)){Array.isArray(e)||n.push(k("data is not an array",e,[]));for(p of r){let o=R(e,p,t);Array.isArray(o)?n.concat(o):o&&n.push(o)}}else if(r&&typeof r=="object")if(Array.isArray(e)){let o=e.findIndex(i=>R(i,r,t));o>-1&&n.push(k("data["+o+"] does not match pattern",e[o],r))}else if(!e||typeof e!="object")n.push(k("data is not an object, pattern is",e,r));else{e instanceof URLSearchParams&&(e=Object.fromEntries(e));let o=n[n.length-1];for(let[i,c]of Object.entries(r)){let a=R(e[i],c,t);a&&((!o||typeof o=="string")&&(o={},n.push(k(o,e[i],c))),o[i]=a.problems)}}else r!=e&&n.push(k("data and pattern are not equal",e,r));return n.length?n:!1}var de=class extends Error{constructor(r,t,...n){super(r),this.problems=t,this.details=n}};function k(e,r,t){return{message:e,found:r,expected:t}}function re(e){let r,t;if(typeof localStorage<"u")r={get:()=>localStorage.getItem("metro/state:"+e),set:n=>localStorage.setItem("metro/state:"+e,n),has:()=>localStorage.getItem("metro/state:"+e)!==null},t={get:n=>JSON.parse(localStorage.getItem(e+":"+n)),set:(n,o)=>localStorage.setItem(e+":"+n,JSON.stringify(o)),has:n=>localStorage.getItem(e+":"+n)!==null};else{let n=new Map;r={get:()=>n.get("metro/state:"+e),set:o=>n.set("metro/state:"+e,o),has:()=>n.has("metro/state:"+e)},t=new Map}return{state:r,tokens:t}}function oe(e){let r={client:f.client(),force_authorization:!1,site:"default",oauth2_configuration:{authorization_endpoint:"/authorize",token_endpoint:"/token",redirect_uri:globalThis.document?.location.href,grant_type:"authorization_code",code_verifier:Ee(64)},callbacks:{authorize:async u=>(window.location.href!=u.href&&window.location.replace(u.href),!1)}};O(e,{});let t=Object.assign({},r.oauth2_configuration,e?.oauth2_configuration);e=Object.assign({},r,e),e.oauth2_configuration=t;let n=re(e.site);e.tokens||(e.tokens=n.tokens),e.state||(e.state=n.state),O(e,{oauth2_configuration:{client_id:x(/.+/),grant_type:"authorization_code",authorization_endpoint:x(w),token_endpoint:x(w),redirect_uri:x(w)}});for(let u in t)switch(u){case"access_token":case"authorization_code":case"refresh_token":e.tokens.set(u,t[u]);break}return async function(u,d){if(e.force_authorization)return o(u,d);let l;try{if(l=await d(u),l.ok)return l}catch(h){switch(l.status){case 400:case 401:return o(u,d)}throw h}if(!l.ok)switch(l.status){case 400:case 401:return o(u,d)}return l};async function o(u,d){i();let l=e.tokens.get("access_token");if(l)if(je(l)){try{if(!await a())return f.response("false")}catch(h){throw h}return o(u,d)}else return u=f.request(u,{headers:{Authorization:l.type+" "+l.value}}),d(u);else{try{if(!await c())return f.response("false")}catch(h){throw h}return o(u,d)}}function i(){if(typeof window<"u"&&window?.location){let u=f.url(window.location),d,l,h;if(u.searchParams.has("code"))h=u.searchParams,u=u.with({search:""}),history.pushState({},"",u.href);else if(u.hash){let U=u.hash.substr(1);h=new URLSearchParams("?"+U),u=u.with({hash:""}),history.pushState({},"",u.href)}if(h){d=h.get("code"),l=h.get("state");let U=e.state.get("metro/state");if(!l||l!==U)return;d&&e.tokens.set("authorization_code",d)}}}async function c(){if(t.grant_type==="authorization_code"&&!e.tokens.has("authorization_code")){let h=await y();if(!e.callbacks.authorize||typeof e.callbacks.authorize!="function")throw f.metroError("oauth2mw: oauth2 with grant_type:authorization_code requires a callback function in client options.options.callbacks.authorize");let U=await e.callbacks.authorize(h);if(U)e.tokens.set("authorization_code",U);else return!1}let u=g(),d=await e.client.post(u);if(!d.ok){let h=await d.text();throw f.metroError("OAuth2mw: fetch access_token: "+d.status+": "+d.statusText,{cause:u})}let l=await d.json();if(e.tokens.set("access_token",{value:l.access_token,expires:pe(l.expires_in),type:l.token_type,scope:l.scope}),l.refresh_token){let h={value:l.refresh_token};e.tokens.set("refresh_token",h)}return l}async function a(){let u=g("refresh_token"),d=await e.client.post(u);if(!d.ok)throw f.metroError("OAuth2mw: refresh access_token: "+d.status+": "+d.statusText,{cause:u});let l=await d.json();if(e.tokens.set("access_token",{value:l.access_token,expires:pe(l.expires_in),type:l.token_type,scope:l.scope}),l.refresh_token){let h={value:l.refresh_token};e.tokens.set("refresh_token",h)}else return!1;return l}async function y(){if(!t.authorization_endpoint)throw f.metroError("oauth2mw: Missing options.oauth2_configuration.authorization_endpoint");let u=f.url(t.authorization_endpoint,{hash:""});O(t,{client_id:/.+/,redirect_uri:/.+/,scope:/.*/});let d={response_type:"code",client_id:t.client_id,redirect_uri:t.redirect_uri,state:t.state||ze(40)};return t.response_type&&(d.response_type=t.response_type),t.response_mode&&(d.response_mode=t.response_mode),e.state.set(d.state),t.client_secret&&(d.client_secret=t.client_secret),t.code_verifier&&(d.code_challenge=ne(await Te(t.code_verifier)),d.code_challenge_method="S256"),t.scope&&(d.scope=t.scope),t.prompt&&(d.prompt=t.prompt),f.url(u,{search:d})}function g(u=null){if(O(t,{client_id:/.+/,redirect_uri:/.+/}),!t.token_endpoint)throw f.metroError("oauth2mw: Missing options.endpoints.token url");let d=f.url(t.token_endpoint,{hash:""}),l={grant_type:u||t.grant_type,client_id:t.client_id};switch(t.code_verifier&&(l.code_verifier=ne(t.code_verifier)),t.client_secret&&(l.client_secret=t.client_secret),t.scope&&(l.scope=t.scope),t.grant_type){case"authorization_code":if(l.redirect_uri=t.redirect_uri,l.code=e.tokens.get("authorization_code"),e.dpop){let h=e.tokens.get("keyPair");l.dpop_jkt=h.publicKey}break;case"client_credentials":break;case"refresh_token":l.refresh_token=t.refresh_token;break;default:throw new Error("Unknown grant_type: ".oauth2.grant_type)}return f.request(d,{method:"POST",body:new URLSearchParams(l)})}}function je(e){if(!e)return!0;let r=new Date(e.expires);return new Date().getTime()>r.getTime()}function pe(e){if(e instanceof Date)return new Date(e.getTime());if(typeof e=="number"){let r=new Date;return r.setSeconds(r.getSeconds()+e),r}throw new TypeError("Unknown expires type "+e)}function Ee(e=64){let r=new Uint8Array(e);return globalThis.crypto.getRandomValues(r),r}async function Te(e){let r=ne(e),n=new TextEncoder().encode(r);return await globalThis.crypto.subtle.digest("SHA-256",n)}function ne(e){let r=Array.from(new Uint8Array(e),t=>String.fromCharCode(t)).join("");return btoa(r).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}function ze(e){let r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",t="",n=0;for(;n<e;)t+=r.charAt(Math.floor(Math.random()*r.length)),n++;return t}function Ge(){let e=new URL(document.location.href);if(!e.searchParams.has("code")){if(e.hash){let r=e.hash.substr(1);if(params=new URLSearchParams("?"+r),params.has("code"))return!0}return!1}return!0}var me={};X(me,{default:()=>Ue});var ie={status:200,statusText:"OK",headers:{"Content-Type":"application/json"}},Q=e=>({status:400,statusText:"Bad Request",headers:{"Content-Type":"application/json"},body:JSON.stringify({error:"invalid_request",error_description:e})}),z,Le={};function Ue(e={}){return e=Object.assign({},{PKCE:!1,DPoP:!1},e),async(t,n)=>{let o=f.url(t.url);switch(o.pathname){case"/authorize/":if(z=R(o.searchParams,{response_type:"code",client_id:"mockClientId",state:b(/.*/)}))return f.response(Q(z));if(o.searchParams.has("code_challenge")){if(!o.searchParams.has("code_challenge_method"))return f.response(Q("missing code_challenge_method"));Le.code_challenge=o.searchParams.get("code_challenge"),Le.code_challenge_method=o.searchParams.get("code_challenge_method")}return f.response(ie,{body:JSON.stringify({code:"mockAuthorizeToken",state:o.searchParams.get("state")})});case"/token/":if(t.body[Symbol.metroSource]instanceof URLSearchParams){let y={};t.body.forEach((g,u)=>y[u]=g),t=t.with({body:y})}if(z=R(t,{method:"POST",body:{grant_type:$("refresh_token","authorization_code")}}))return f.response(Q(z));switch(t.body.grant_type){case"refresh_token":if(z=R(t.body,$({refresh_token:"mockRefreshToken",client_id:"mockClientId",client_secret:"mockClientSecret"},{refresh_token:"mockRefreshToken",client_id:"mockClientId",code_verifier:/.+/})))return f.response(Q(z));break;case"access_token":if(z=R(t.body,$({client_id:"mockClientId",client_secret:"mockClientSecret"},{client_id:"mockClientId",code_challenge:/.*/,code_challenge_method:"S256"})))return f.response(Q(z));break}return f.response(ie,{body:JSON.stringify({access_token:"mockAccessToken",token_type:"mockExample",expires_in:3600,refresh_token:"mockRefreshToken",example_parameter:"mockExampleValue"})});case"/protected/":let i=t.headers.get("Authorization"),[c,a]=i?i.split(" "):[];return!a||a!=="mockAccessToken"?f.response({status:401,statusText:"Forbidden",body:"401 Forbidden"}):f.response(ie,{body:JSON.stringify({result:"Success"})});case"/public/":return f.response(ie,{body:JSON.stringify({result:"Success"})});default:return f.response({status:404,statusText:"not found",body:"404 Not Found "+o})}}}var _e={};X(_e,{default:()=>Ke});var Ce=["HS256","HS384","HS512","RS256","RS384","RS512","ES256","ES384","ES512"],De=["client_secret_post","client_secret_base","client_secret_jwt","private_key_jwt"],Xe={issuer:x(w),authorization_endpoint:x(w),token_endpoint:x(w),jwks_uri:b(w),registration_endpoint:b(w),scopes_supported:Pe([]),response_types_supported:x(Oe("code","token")),response_modes_supported:b([]),grant_types_supported:b([]),token_endpoint_auth_methods_supported:b([]),token_endpoint_auth_signing_alg_values_supported:b([]),service_documentation:b(w),ui_locales_supported:b([]),op_policy_uri:b(w),op_tos_uri:b(w),revocation_endpoint:b(w),revocation_endpoint_auth_methods_supported:b(De),revocation_endpoint_auth_signing_alg_values_supported:b(Ce),introspection_endpoint:b(w),introspection_endpoint_auth_methods_supported:b(De),introspection_endpoint_auth_signing_alg_values_supported:b(Ce),code_challendge_methods_supported:b([])};function Ke(e={}){let r={client:f.client()};e=Object.assign({},r,e),O(e,{issuer:x(w)});let t=qe(e.issuer),n=e.client.with(e.issuer)}async function qe(e,r){let t=r.get(f.url(e,".wellknown/oauth_authorization_server"));if(t.ok){O(t.headers.get("Content-Type"),/application\/json.*/);let n=await t.json();return O(n,Xe),n}throw f.metroError("metro.oidcmw: Error while fetching "+e+".wellknown/oauth_authorization_server",t)}function Y(){return new Promise((e,r)=>{let t=globalThis.indexedDB.open("metro",1);t.onupgradeneeded=()=>t.result.createObjectStore("keyPairs",{keyPath:"domain"}),t.onerror=n=>{r(n)},t.onsuccess=n=>{let o=n.target.result;e({set:function(i,c){return new Promise((a,y)=>{let g=o.transaction("keyPairs","readwrite",{durability:"strict"}),u=g.objectStore("keyPairs");g.oncomplete=()=>{a()},g.onerror=y,u.put(i,c)})},get:function(i){return new Promise((c,a)=>{let y=o.transaction("keyPairs","readonly"),u=y.objectStore("keyPairs").get(i);u.onsuccess=()=>{c(u.result)},u.onerror=a,y.onerror=a})},clear:function(){return new Promise((i,c)=>{let a=o.transaction("keyPairs","readwrite"),g=a.objectStore("keyPairs").clear();g.onsuccess=()=>{i()},g.onerror=c,a.onerror=c})}})}})}var et=new TextEncoder,tt=new TextDecoder;function se(e){return typeof e=="string"?et.encode(e):tt.decode(e)}function He(e){if(typeof e.modulusLength!="number"||e.modulusLength<2048)throw new ye(`${e.name} modulusLength must be at least 2048 bits`)}function rt(e){switch(e.algorithm.name){case"ECDSA":return{name:e.algorithm.name,hash:"SHA-256"};case"RSA-PSS":return He(e.algorithm),{name:e.algorithm.name,saltLength:32};case"RSASSA-PKCS1-v1_5":return He(e.algorithm),{name:e.algorithm.name};case"Ed25519":return{name:e.algorithm.name}}throw new L}async function nt(e,r,t){if(t.usages.includes("sign")===!1)throw new TypeError('private CryptoKey instances used for signing assertions must include "sign" in their "usages"');let n=`${Z(se(JSON.stringify(e)))}.${Z(se(JSON.stringify(r)))}`,o=Z(await crypto.subtle.sign(rt(t),t,se(n)));return`${n}.${o}`}var Ie=32768;function ot(e){e instanceof ArrayBuffer&&(e=new Uint8Array(e));let r=[];for(let t=0;t<e.byteLength;t+=Ie)r.push(String.fromCharCode.apply(null,e.subarray(t,t+Ie)));return btoa(r.join("")).replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_")}function Z(e){return ot(e)}function it(){return Z(crypto.getRandomValues(new Uint8Array(32)))}var L=class extends Error{constructor(r){super(r??"operation not supported"),this.name=this.constructor.name,Error.captureStackTrace?.(this,this.constructor)}},ye=class extends Error{constructor(r){super(r),this.name=this.constructor.name,Error.captureStackTrace?.(this,this.constructor)}};function st(e){switch(e.algorithm.hash.name){case"SHA-256":return"PS256";default:throw new L("unsupported RsaHashedKeyAlgorithm hash name")}}function at(e){switch(e.algorithm.hash.name){case"SHA-256":return"RS256";default:throw new L("unsupported RsaHashedKeyAlgorithm hash name")}}function ct(e){switch(e.algorithm.namedCurve){case"P-256":return"ES256";default:throw new L("unsupported EcKeyAlgorithm namedCurve")}}function ut(e){switch(e.algorithm.name){case"RSA-PSS":return st(e);case"RSASSA-PKCS1-v1_5":return at(e);case"ECDSA":return ct(e);case"Ed25519":return"EdDSA";default:throw new L("unsupported CryptoKey algorithm name")}}function Ne(e){return e instanceof CryptoKey}function lt(e){return Ne(e)&&e.type==="private"}function ft(e){return Ne(e)&&e.type==="public"}function dt(){return Math.floor(Date.now()/1e3)}async function ae(e,r,t,n,o,i){let c=e?.privateKey,a=e?.publicKey;if(!lt(c))throw new TypeError('"keypair.privateKey" must be a private CryptoKey');if(!ft(a))throw new TypeError('"keypair.publicKey" must be a public CryptoKey');if(a.extractable!==!0)throw new TypeError('"keypair.publicKey.extractable" must be true');if(typeof r!="string")throw new TypeError('"htu" must be a string');if(typeof t!="string")throw new TypeError('"htm" must be a string');if(n!==void 0&&typeof n!="string")throw new TypeError('"nonce" must be a string or undefined');if(o!==void 0&&typeof o!="string")throw new TypeError('"accessToken" must be a string or undefined');if(i!==void 0&&(typeof i!="object"||i===null||Array.isArray(i)))throw new TypeError('"additional" must be an object');return nt({alg:ut(c),typ:"dpop+jwt",jwk:await pt(a)},{...i,iat:dt(),jti:it(),htm:t,nonce:n,htu:r,ath:o?Z(await crypto.subtle.digest("SHA-256",se(o))):void 0},c)}async function pt(e){let{kty:r,e:t,n,x:o,y:i,crv:c}=await crypto.subtle.exportKey("jwk",e);return{kty:r,crv:c,e:t,n,x:o,y:i}}async function Be(e,r){let t;if(typeof e!="string"||e.length===0)throw new TypeError('"alg" must be a non-empty string');switch(e){case"PS256":t={name:"RSA-PSS",hash:"SHA-256",modulusLength:r?.modulusLength??2048,publicExponent:new Uint8Array([1,0,1])};break;case"RS256":t={name:"RSASSA-PKCS1-v1_5",hash:"SHA-256",modulusLength:r?.modulusLength??2048,publicExponent:new Uint8Array([1,0,1])};break;case"ES256":t={name:"ECDSA",namedCurve:"P-256"};break;case"EdDSA":t={name:"Ed25519"};break;default:throw new L}return crypto.subtle.generateKey(t,r?.extractable??!1,["sign","verify"])}function ge(e){return O(e,{site:x(w),authorization_endpoint:x(w),token_endpoint:x(w)}),async(r,t)=>{let n=await Y(),o=await n.get(e.site);if(!o){let a=await Be("ES256");o={domain:e.site,keyPair:a},await n.set(o)}let i=f.url(r.url);if(r.url.startsWith(e.authorization_endpoint)||r.url.startsWith(e.token_endpoint)){let a=await ae(o.keyPair,r.url,r.method);r=r.with({headers:{DPoP:a}})}else if(r.headers.has("Authorization")){let a=localStorage.getItem(i.host+":nonce")||void 0,y=r.headers.get("Authorization").split(" ")[1],g=await ae(o.keyPair,r.url,r.method,a,y);r=r.with({headers:{Authorization:"DPoP "+y,DPoP:g}})}let c=await t(r);return c.headers.get("DPoP-Nonce")&&localStorage.setItem(i.host+":nonce",c.headers.get("DPoP-Nonce")),c}}var Je=Object.assign(oe,he,{mockserver:me,discovery:_e,tokenstore:re,dpopmw:ge,keysstore:Y});globalThis.oauth2=Je;var ce=Je;function be(e){let r;if(typeof localStorage<"u")r={get:t=>JSON.parse(localStorage.getItem("metro/oidc:"+e+":"+t)),set:(t,n)=>localStorage.setItem("metro/oidc:"+e+":"+t,JSON.stringify(n)),has:t=>localStorage.getItem("metro/oidc:"+e+":"+t)!==null};else{let t=new Map;r={get:n=>JSON.parse(t.get("metro/oidc:"+e+":"+n)||null),set:(n,o)=>t.set("metro/oidc:"+e+":"+n,JSON.stringify(o)),has:n=>t.has("metro/oidc:"+e+":"+n)}}return r}function we(e={}){let r={client:f.client(),force_authorization:!1};return e=Object.assign({},r,e),E(e,{client:S(I(f.client().constructor)),client_info:S(),issuer:S(m),oauth2:s({}),openid_configuration:s()}),e.store||(e.store=be(e.issuer)),!e.openid_configuration&&e.store.has("openid_configuration")&&(e.openid_configuration=e.store.get("openid_configuration")),!e.client_info.client_id&&e.store.has("client_info")&&(e.client_info=e.store.get("client_info")),async(t,n)=>{let o;if(!e.force_authorization){try{o=await n(t)}catch(d){if(o.status!=401&&o.status!=403)throw d}if(o.ok||o.status!=401&&o.status!=403)return o}if(e.openid_configuration||(e.openid_configuration=await V({issuer:e.issuer}),e.store.set("openid_configuration",e.openid_configuration)),!e.client_info?.client_id){if(E(e.client_info?.client_name,S()),!e.openid_configuration.registration_endpoint)throw f.metroError("metro.oidcmw: Error: issuer "+e.issuer+" does not support dynamic client registration, but you haven't specified a client_id");e.client_info=await W({registration_endpoint:e.openid_configuration.registration_endpoint,client_info:e.client_info}),e.store.set("client_info",e.client_info)}let i=e.scope||"openid",c=Object.assign({site:e.issuer,client:e.client,force_authorization:!0,oauth2_configuration:{client_id:e.client_info.client_id,client_secret:e.client_info.client_secret,grant_type:"authorization_code",response_type:"code",response_mode:"query",authorization_endpoint:e.openid_configuration.authorization_endpoint,token_endpoint:e.openid_configuration.token_endpoint,scope:i,redirect_uri:e.client_info.redirect_uris[0]}}),a={site:e.issuer,authorization_endpoint:e.openid_configuration.authorization_endpoint,token_endpoint:e.openid_configuration.token_endpoint,dpop_signing_alg_values_supported:e.openid_configuration.dpop_signing_alg_values_supported},y=async(d,l)=>{let h=await l(d);if(h.headers.get("content-type")?.startsWith("application/json")){let Ve=h.clone();try{let G=await Ve.json();G&&G.id_token&&e.store.set("id_token",G.id_token)}catch{}}return h},g=e.client.with(e.issuer).with(y).with(ce.dpopmw(a));return c.client=g,o=await g.with(ce(c)).fetch(t),o}}function Me(){return ce.isRedirected()}function Fe(e){return e.store.get("id_token")}var ht=Object.assign(we,{discover:V,register:W,isRedirected:Me,idToken:Fe});globalThis.oidc=ht;})();
//# sourceMappingURL=browser.min.js.map
