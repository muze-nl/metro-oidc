(()=>{var be=Object.defineProperty;var Se=(e,o)=>{for(var t in o)be(e,t,{get:o[t],enumerable:!0})};var M={};Se(M,{Client:()=>j,client:()=>L,deepClone:()=>H,formdata:()=>ie,metroError:()=>g,request:()=>E,response:()=>U,trace:()=>xe,url:()=>v});var O="https://metro.muze.nl/details/";Symbol.metroProxy||(Symbol.metroProxy=Symbol("isProxy"));Symbol.metroSource||(Symbol.metroSource=Symbol("source"));var j=class e{clientOptions={url:typeof window<"u"?window.location:"https://localhost",verbs:["get","post","put","delete","patch","head","options","query"]};static tracers={};constructor(...o){for(let t of o)if(typeof t=="string"||t instanceof String)this.clientOptions.url=""+t;else if(t instanceof Function)this.#e([t]);else if(t&&typeof t=="object")for(let n in t)n=="middlewares"?this.#e(t[n]):typeof t[n]=="function"?this.clientOptions[n]=t[n](this.clientOptions[n],this.clientOptions):this.clientOptions[n]=t[n];for(let t of this.clientOptions.verbs)this[t]=async function(...n){return this.fetch(E(this.clientOptions,...n,{method:t.toUpperCase()}))}}#e(o){typeof o=="function"&&(o=[o]);let t=o.findIndex(n=>typeof n!="function");if(t>=0)throw g("metro.client: middlewares must be a function or an array of functions "+O+"client/invalid-middlewares/",o[t]);Array.isArray(this.clientOptions.middlewares)||(this.clientOptions.middlewares=[]),this.clientOptions.middlewares=this.clientOptions.middlewares.concat(o)}fetch(o,t){if(o=E(o,t),!o.url)throw g("metro.client."+o.method.toLowerCase()+": Missing url parameter "+O+"client/fetch-missing-url/",o);if(t||(t={}),typeof t!="object"||t instanceof String)throw g("metro.client.fetch: Invalid options parameter "+O+"client/fetch-invalid-options/",t);let r=[async function(a){a[Symbol.metroProxy]&&(a=a[Symbol.metroSource]);let m=await fetch(a);return U(m)}].concat(this.clientOptions?.middlewares?.slice()||[]);t=Object.assign({},this.clientOptions,t);let i;for(let c of r)i=function(a,m){return async function(y){let u,f=Object.values(e.tracers);for(let l of f)l.request&&l.request.call(l,y,m);u=await m(y,a);for(let l of f)l.response&&l.response.call(l,u,m);return u}}(i,c);return i(o)}with(...o){return new e(H(this.clientOptions),...o)}};function L(...e){return new j(...H(e))}function ke(e,o){let t=o||{};!t.url&&o.url&&(t.url=o.url);for(let n of["method","headers","body","mode","credentials","cache","redirect","referrer","referrerPolicy","integrity","keepalive","signal","priority","url"]){let r=e[n];if(!(typeof r>"u"||r==null))if(r?.[Symbol.metroProxy]&&(r=r[Symbol.metroSource]),typeof r=="function")t[n]=r(t[n],t);else if(n=="url")t.url=v(t.url,r);else if(n=="headers"){t.headers=new Headers(o.headers),r instanceof Headers||(r=new Headers(e.headers));for(let[i,c]of r.entries())t.headers.set(i,c)}else t[n]=r}return e instanceof Request&&e.data&&(t.body=e.data),t}function E(...e){let o={url:typeof window<"u"?window.location:"https://localhost/",duplex:"half"};for(let r of e)typeof r=="string"||r instanceof URL||r instanceof URLSearchParams?o.url=v(o.url,r):r&&(r instanceof FormData||r instanceof ReadableStream||r instanceof Blob||r instanceof ArrayBuffer||r instanceof DataView)?o.body=r:r&&typeof r=="object"&&Object.assign(o,ke(r,o));let t=new Request(o.url,o),n=o.body;return n&&typeof n=="object"&&!(n instanceof String)&&!(n instanceof ReadableStream)&&!(n instanceof Blob)&&!(n instanceof ArrayBuffer)&&!(n instanceof DataView)&&!(n instanceof FormData)&&!(n instanceof URLSearchParams)&&(typeof TypedArray>"u"||!(n instanceof TypedArray))&&typeof n.toString=="function"&&(o.body=n.toString({headers:t.headers}),t=new Request(o.url,o)),Object.freeze(t),new Proxy(t,{get(r,i,c){switch(i){case Symbol.metroSource:return r;case Symbol.metroProxy:return!0;case"with":return function(...a){return n&&a.unshift({body:n}),E(r,...a)};case"data":return n}return r[i]instanceof Function?r[i].bind(r):r[i]}})}function ne(e,o){let t=o||{};!t.url&&o.url&&(t.url=o.url);for(let n of["status","statusText","headers","body","url","type","redirected"]){let r=e[n];typeof r>"u"||r==null||(r?.[Symbol.metroProxy]&&(r=r[Symbol.metroSource]),typeof r=="function"?t[n]=r(t[n],t):n=="url"?t.url=new URL(r,t.url||"https://localhost/"):t[n]=r)}return e instanceof Response&&e.data&&(t.body=e.data),t}function U(...e){let o={};for(let r of e)typeof r=="string"?o.body=r:r instanceof Response?Object.assign(o,ne(r,o)):r&&typeof r=="object"&&(r instanceof FormData||r instanceof Blob||r instanceof ArrayBuffer||r instanceof DataView||r instanceof ReadableStream||r instanceof URLSearchParams||r instanceof String||typeof TypedArray<"u"&&r instanceof TypedArray?o.body=r:Object.assign(o,ne(r,o)));let t;o.body&&(t=o.body),[101,204,205,304].includes(o.status)&&(o.body=null);let n=new Response(o.body,o);return Object.freeze(n),new Proxy(n,{get(r,i,c){switch(i){case Symbol.metroProxy:return!0;case Symbol.metroSource:return r;case"with":return function(...a){return U(r,...a)};case"data":return t;case"ok":return r.status>=200&&r.status<400}return typeof r[i]=="function"?r[i].bind(r):r[i]}})}function oe(e,o){typeof o=="function"?o(e.searchParams,e):(o=new URLSearchParams(o),o.forEach((t,n)=>{e.searchParams.append(n,t)}))}function v(...e){let o=["hash","host","hostname","href","password","pathname","port","protocol","username","search","searchParams"],t=new URL("https://localhost/");for(let n of e)if(typeof n=="string"||n instanceof String)t=new URL(n,t);else if(n instanceof URL||typeof Location<"u"&&n instanceof Location)t=new URL(n);else if(n instanceof URLSearchParams)oe(t,n);else if(n&&typeof n=="object")for(let r in n)switch(r){case"search":typeof n.search=="function"?n.search(t.search,t):t.search=new URLSearchParams(n.search);break;case"searchParams":oe(t,n.searchParams);break;default:if(!o.includes(r))throw g("metro.url: unknown url parameter "+O+"url/unknown-param-name/",r);if(typeof n[r]=="function")n[r](t[r],t);else if(typeof n[r]=="string"||n[r]instanceof String||typeof n[r]=="number"||n[r]instanceof Number||typeof n[r]=="boolean"||n[r]instanceof Boolean)t[r]=""+n[r];else if(typeof n[r]=="object"&&n[r].toString)t[r]=n[r].toString();else throw g("metro.url: unsupported value for "+r+" "+O+"url/unsupported-param-value/",e[r]);break}else throw g("metro.url: unsupported option value "+O+"url/unsupported-option-value/",n);return Object.freeze(t),new Proxy(t,{get(n,r,i){let c;switch(r){case Symbol.metroProxy:return!0;case Symbol.metroSource:return n;case"with":return function(...a){return v(n,...a)};case"filename":return n.pathname.split("/").pop();case"folderpath":return n.pathname.substring(0,n.pathname.lastIndexOf("\\")+1);case"authority":return c=n.username??"",c+=n.password?":"+n.password:"",c+=c?"@":"",c+=n.hostname,c+=n.port?":"+n.port:"",c+="/",c=n.protocol+"//"+c,c;break;case"origin":return c=n.protocol+"//"+n.hostname,c+=n.port?":"+n.port:"",c+="/",c;break;case"fragment":return n.hash.substring(1);case"scheme":return n.protocol?n.protocol.substring(0,n.protocol.length-1):""}return n[r]instanceof Function?n[r].bind(n):n[r]}})}function ie(...e){var o=new FormData;for(let t of e)if(t instanceof HTMLFormElement&&(t=new FormData(t)),t instanceof FormData)for(let n of t.entries())o.append(n[0],n[1]);else if(t&&typeof t=="object")for(let n of Object.entries(t))if(Array.isArray(n[1]))for(let r of n[1])o.append(n[0],r);else o.append(n[0],n[1]);else throw new g("metro.formdata: unknown option type "+O+"formdata/unknown-option-value/",t);return Object.freeze(o),new Proxy(o,{get:(t,n,r)=>{switch(n){case Symbol.metroProxy:return!0;case Symbol.metroSource:return t;case"with":return function(...i){return ie(t,...i)}}return t[n]instanceof Function?t[n].bind(t):t[n]}})}var C={error:(e,...o)=>{console.error("\u24C2\uFE0F  ",e,...o)},info:(e,...o)=>{console.info("\u24C2\uFE0F  ",e,...o)},group:e=>{console.group("\u24C2\uFE0F  "+e)},groupEnd:e=>{console.groupEnd("\u24C2\uFE0F  "+e)}};function g(e,...o){return C.error(e,...o),new Error(e,...o)}var xe={add(e,o){j.tracers[e]=o},delete(e){delete j.tracers[e]},clear(){j.tracers={}},group(){let e=0;return{request:(o,t)=>{e++,C.group(e),C.info(o?.url,o,t)},response:(o,t)=>{C.info(o?.body?o.body[Symbol.metroSource]:null,o,t),C.groupEnd(e),e--}}}};function H(e){if(Array.isArray(e))return e.slice().map(H);if(e&&typeof e=="object")if(e.__proto__.constructor==Object||!e.__proto__){let o=Object.assign({},e);return Object.keys(o).forEach(t=>{o[t]=H(e[t])}),o}else return e;return e}function T(e){return e=Object.assign({mimetype:"application/json",reviver:null,replacer:null,space:""},e),async function(t,n){G(t.headers.get("Accept"))||(t=t.with({headers:{Accept:e.mimetype}})),["POST","PUT","PATCH","QUERY"].includes(t.method)&&t.data&&typeof t.data=="object"&&!(t.data instanceof ReadableStream)&&(G(t.headers.get("content-type"))||(t=t.with({headers:{"Content-Type":e.mimetype}})),t=t.with({body:JSON.stringify(t.data,e.replacer,e.space)}));let r=await n(t);if(G(r.headers.get("content-type"))){let c=await r.clone().text();try{let a=JSON.parse(c,e.reviver);return r.with({body:a})}catch{}}return r}}var ve=/^application\/([a-zA-Z0-9\-_]+\+)?json\b/;function G(e){return ve.exec(e)}function z(e){return async function(t,n){let r=await n(t);if(!r.ok)if(e&&typeof e[r.status]=="function")r=e[r.status].apply(r,t);else throw new Error(r.status+": "+r.statusText,{cause:r});return r}}var se=Object.assign({},M,{mw:{jsonmw:T,thrower:z}});globalThis.metro||(globalThis.metro=se);var x=se;globalThis.assertEnabled=!1;function w(e,o){if(globalThis.assertEnabled){let t=S(e,o);if(t)throw console.error("\u{1F170}\uFE0F  Assertions failed because of:",t,"in this source:",e),new Error("Assertions failed",{cause:{problems:t,source:e}})}}function s(e){return function(t,n,r){if(typeof t<"u"&&t!=null&&typeof e<"u")return S(t,e,n,r)}}function p(e){return function(t,n,r){return t==null||typeof t>"u"?_("data is required",t,e||"any value",r):typeof e<"u"?S(t,e,n,r):!1}}function I(e){return function(t,n,r){return t==null||typeof t>"u"?(Ae("data does not contain recommended value",t,e,r),!1):S(t,e,n,r)}}function b(...e){return function(t,n,r){for(let i of e)if(!S(t,i,n,r))return!1;return _("data does not match oneOf patterns",t,e,r)}}function D(...e){return function(t,n,r){if(!Array.isArray(t))return _("data is not an array",t,"anyOf",r);for(let i of t)if(b(...e)(i))return _("data does not match anyOf patterns",i,e,r);return!1}}function ae(...e){return function(t,n,r){let i=[];for(let c of e)i=i.concat(S(t,c,n,r));if(i=i.filter(Boolean),i.length)return _("data does not match all given patterns",t,e,r,i)}}function d(e,o,t){try{e instanceof URL&&(e=e.href);let n=new URL(e);if(n.href!=e&&!(n.href+"/"==e||n.href==e+"/"))return _("data is not a valid url",e,"validURL",t)}catch{return _("data is not a valid url",e,"validURL",t)}}function ce(e,o,t){if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e))return _("data is not a valid email",e,"validEmail",t)}function K(e){return function(t,n,r){if(!(t instanceof e))return _("data is not an instanceof pattern",t,e,r)}}function B(e){return function(t,n,r){if(!S(t,e,n,r))return _("data matches pattern, when required not to",t,e,r)}}function S(e,o,t,n=""){t||(t=e);let r=[];if(o===Boolean)typeof e!="boolean"&&!(e instanceof Boolean)&&r.push(_("data is not a boolean",e,o,n));else if(o===Number)typeof e!="number"&&!(e instanceof Number)&&r.push(_("data is not a number",e,o,n));else if(o===String)typeof e!="string"&&!(e instanceof String)&&r.push(_("data is not a string",e,o,n)),e==""&&r.push(_("data is an empty string, which is not allowed",e,o,n));else if(o instanceof RegExp)if(Array.isArray(e)){let i=e.findIndex((c,a)=>S(c,o,t,n+"["+a+"]"));i>-1&&r.push(_("data["+i+"] does not match pattern",e[i],o,n+"["+i+"]"))}else typeof e>"u"?r.push(_("data is undefined, should match pattern",e,o,n)):o.test(e)||r.push(_("data does not match pattern",e,o,n));else if(o instanceof Function){let i=o(e,t,n);i&&(Array.isArray(i)?r=r.concat(i):r.push(i))}else if(Array.isArray(o)){Array.isArray(e)||r.push(_("data is not an array",e,[],n));for(let i of o)for(let c of e.keys()){let a=S(e[c],i,t,n+"["+c+"]");Array.isArray(a)?r=r.concat(a):a&&r.push(a)}}else if(o&&typeof o=="object")if(Array.isArray(e)){let i=e.findIndex((c,a)=>S(c,o,t,n+"["+a+"]"));i>-1&&r.push(_("data["+i+"] does not match pattern",e[i],o,n+"["+i+"]"))}else if(!e||typeof e!="object")r.push(_("data is not an object, pattern is",e,o,n));else if(e instanceof URLSearchParams&&(e=Object.fromEntries(e)),o instanceof Function){let i=S(e,o,t,n);i&&(r=r.concat(i))}else for(let[i,c]of Object.entries(o)){let a=S(e[i],c,t,n+"."+i);a&&(r=r.concat(a))}else o!=e&&r.push(_("data and pattern are not equal",e,o,n));return r.length?r:!1}function _(e,o,t,n,r){let i={path:n,message:e,found:o,expected:t};return r&&(i.problems=r),i}function Ae(e,o,t,n){console.warn("\u{1F170}\uFE0F  Assert: "+n,e,t,o)}function ue(e){let o,t;if(typeof localStorage<"u")o={get:()=>localStorage.getItem("metro/state:"+e),set:n=>localStorage.setItem("metro/state:"+e,n),has:()=>localStorage.getItem("metro/state:"+e)!==null},t={get:n=>JSON.parse(localStorage.getItem(e+":"+n)),set:(n,r)=>localStorage.setItem(e+":"+n,JSON.stringify(r)),has:n=>localStorage.getItem(e+":"+n)!==null};else{let n=new Map;o={get:()=>n.get("metro/state:"+e),set:r=>n.set("metro/state:"+e,r),has:()=>n.has("metro/state:"+e)},t=new Map}return{state:o,tokens:t}}function X(e){let o={client:L(),force_authorization:!1,site:"default",oauth2_configuration:{authorization_endpoint:"/authorize",token_endpoint:"/token",redirect_uri:globalThis.document?.location.href,grant_type:"authorization_code",code_verifier:Pe(64)},authorize_callback:async u=>(window.location.href!=u.href&&window.location.replace(u.href),!1)};w(e,{});let t=Object.assign({},o.oauth2_configuration,e?.oauth2_configuration);e=Object.assign({},o,e),e.oauth2_configuration=t;let n=ue(e.site);e.tokens||(e.tokens=n.tokens),e.state||(e.state=n.state),w(e,{oauth2_configuration:{client_id:p(/.+/),grant_type:"authorization_code",authorization_endpoint:p(d),token_endpoint:p(d),redirect_uri:p(d)}});for(let u in t)switch(u){case"access_token":case"authorization_code":case"refresh_token":e.tokens.set(u,t[u]);break}return async function(u,f){if(e.force_authorization)return r(u,f);let l;try{if(l=await f(u),l.ok)return l}catch(h){switch(l.status){case 400:case 401:return r(u,f)}throw h}if(!l.ok)switch(l.status){case 400:case 401:return r(u,f)}return l};async function r(u,f){i();let l=e.tokens.get("access_token");if(l)if(Re(l)){try{if(!await a())return U("false")}catch(h){throw h}return r(u,f)}else return u=E(u,{headers:{Authorization:l.type+" "+l.value}}),f(u);else{try{if(!await c())return U("false")}catch(h){throw h}return r(u,f)}}function i(){if(typeof window<"u"&&window?.location){let u=v(window.location),f,l,h;if(u.searchParams.has("code"))h=u.searchParams,u=u.with({search:""}),history.pushState({},"",u.href);else if(u.hash){let A=u.hash.substr(1);h=new URLSearchParams("?"+A),u=u.with({hash:""}),history.pushState({},"",u.href)}if(h){f=h.get("code"),l=h.get("state");let A=e.state.get("metro/state");if(!l||l!==A)return;f&&e.tokens.set("authorization_code",f)}}}async function c(){if(t.grant_type==="authorization_code"&&!e.tokens.has("authorization_code")){let h=await m();if(!e.authorize_callback||typeof e.authorize_callback!="function")throw g("oauth2mw: oauth2 with grant_type:authorization_code requires a callback function in client options.authorize_callback");let A=await e.authorize_callback(h);if(A)e.tokens.set("authorization_code",A);else return!1}let u=y(),f=await e.client.post(u);if(!f.ok){let h=await f.text();throw g("OAuth2mw: fetch access_token: "+f.status+": "+f.statusText,{cause:u})}let l=await f.json();if(e.tokens.set("access_token",{value:l.access_token,expires:le(l.expires_in),type:l.token_type,scope:l.scope}),l.refresh_token){let h={value:l.refresh_token};e.tokens.set("refresh_token",h)}return l}async function a(){let u=y("refresh_token"),f=await e.client.post(u);if(!f.ok)throw g("OAuth2mw: refresh access_token: "+f.status+": "+f.statusText,{cause:u});let l=await f.json();if(e.tokens.set("access_token",{value:l.access_token,expires:le(l.expires_in),type:l.token_type,scope:l.scope}),l.refresh_token){let h={value:l.refresh_token};e.tokens.set("refresh_token",h)}else return!1;return l}async function m(){if(!t.authorization_endpoint)throw g("oauth2mw: Missing options.oauth2_configuration.authorization_endpoint");let u=v(t.authorization_endpoint,{hash:""});w(t,{client_id:/.+/,redirect_uri:/.+/,scope:/.*/});let f={response_type:"code",client_id:t.client_id,redirect_uri:t.redirect_uri,state:t.state||je(40)};return t.response_type&&(f.response_type=t.response_type),t.response_mode&&(f.response_mode=t.response_mode),e.state.set(f.state),t.client_secret&&(f.client_secret=t.client_secret),t.code_verifier&&(f.code_challenge=await Oe(t.code_verifier),f.code_challenge_method="S256"),t.scope&&(f.scope=t.scope),t.prompt&&(f.prompt=t.prompt),v(u,{search:f})}function y(u=null){if(w(t,{client_id:/.+/,redirect_uri:/.+/}),!t.token_endpoint)throw g("oauth2mw: Missing options.endpoints.token url");let f=v(t.token_endpoint,{hash:""}),l={grant_type:u||t.grant_type,client_id:t.client_id};switch(t.code_verifier&&(l.code_verifier=t.code_verifier),t.client_secret&&(l.client_secret=t.client_secret),t.scope&&(l.scope=t.scope),t.grant_type){case"authorization_code":l.redirect_uri=t.redirect_uri,l.code=e.tokens.get("authorization_code");break;case"client_credentials":break;case"refresh_token":l.refresh_token=t.refresh_token;break;default:throw new Error("Unknown grant_type: ".oauth2.grant_type)}return E(f,{method:"POST",body:new URLSearchParams(l)})}}function Re(e){if(!e)return!0;let o=new Date(e.expires);return new Date().getTime()>o.getTime()}function le(e){if(e instanceof Date)return new Date(e.getTime());if(typeof e=="number"){let o=new Date;return o.setSeconds(o.getSeconds()+e),o}throw new TypeError("Unknown expires type "+e)}function Pe(e=64){let o=new Uint8Array(e);return globalThis.crypto.getRandomValues(o),fe(o)}async function Oe(e){let t=new TextEncoder().encode(e),n=await globalThis.crypto.subtle.digest("SHA-256",t);return fe(n)}function fe(e){let o=Array.from(new Uint8Array(e),t=>String.fromCharCode(t)).join("");return btoa(o).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}function je(e){let o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",t="",n=0;for(;n<e;)t+=o.charAt(Math.floor(Math.random()*o.length)),n++;return t}function de(){let e=new URL(document.location.href);if(!e.searchParams.has("code")){if(e.hash){let o=e.hash.substr(1);if(params=new URLSearchParams("?"+o),params.has("code"))return!0}return!1}return!0}function q(){return new Promise((e,o)=>{let t=globalThis.indexedDB.open("metro",1);t.onupgradeneeded=()=>t.result.createObjectStore("keyPairs",{keyPath:"domain"}),t.onerror=n=>{o(n)},t.onsuccess=n=>{let r=n.target.result;e({set:function(i,c){return new Promise((a,m)=>{let y=r.transaction("keyPairs","readwrite",{durability:"strict"}),u=y.objectStore("keyPairs");y.oncomplete=()=>{a()},y.onerror=m,u.put(i,c)})},get:function(i){return new Promise((c,a)=>{let m=r.transaction("keyPairs","readonly"),u=m.objectStore("keyPairs").get(i);u.onsuccess=()=>{c(u.result)},u.onerror=a,m.onerror=a})},clear:function(){return new Promise((i,c)=>{let a=r.transaction("keyPairs","readwrite"),y=a.objectStore("keyPairs").clear();y.onsuccess=()=>{i()},y.onerror=c,a.onerror=c})}})}})}var Te=new TextEncoder,ze=new TextDecoder;function $(e){return typeof e=="string"?Te.encode(e):ze.decode(e)}function pe(e){if(typeof e.modulusLength!="number"||e.modulusLength<2048)throw new ee(`${e.name} modulusLength must be at least 2048 bits`)}function Le(e){switch(e.algorithm.name){case"ECDSA":return{name:e.algorithm.name,hash:"SHA-256"};case"RSA-PSS":return pe(e.algorithm),{name:e.algorithm.name,saltLength:32};case"RSASSA-PKCS1-v1_5":return pe(e.algorithm),{name:e.algorithm.name};case"Ed25519":return{name:e.algorithm.name}}throw new R}async function Ue(e,o,t){if(t.usages.includes("sign")===!1)throw new TypeError('private CryptoKey instances used for signing assertions must include "sign" in their "usages"');let n=`${N($(JSON.stringify(e)))}.${N($(JSON.stringify(o)))}`,r=N(await crypto.subtle.sign(Le(t),t,$(n)));return`${n}.${r}`}var he=32768;function De(e){e instanceof ArrayBuffer&&(e=new Uint8Array(e));let o=[];for(let t=0;t<e.byteLength;t+=he)o.push(String.fromCharCode.apply(null,e.subarray(t,t+he)));return btoa(o.join("")).replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_")}function N(e){return De(e)}function Ke(){return N(crypto.getRandomValues(new Uint8Array(32)))}var R=class extends Error{constructor(o){super(o??"operation not supported"),this.name=this.constructor.name,Error.captureStackTrace?.(this,this.constructor)}},ee=class extends Error{constructor(o){super(o),this.name=this.constructor.name,Error.captureStackTrace?.(this,this.constructor)}};function Ce(e){switch(e.algorithm.hash.name){case"SHA-256":return"PS256";default:throw new R("unsupported RsaHashedKeyAlgorithm hash name")}}function He(e){switch(e.algorithm.hash.name){case"SHA-256":return"RS256";default:throw new R("unsupported RsaHashedKeyAlgorithm hash name")}}function Me(e){switch(e.algorithm.namedCurve){case"P-256":return"ES256";default:throw new R("unsupported EcKeyAlgorithm namedCurve")}}function Ie(e){switch(e.algorithm.name){case"RSA-PSS":return Ce(e);case"RSASSA-PKCS1-v1_5":return He(e);case"ECDSA":return Me(e);case"Ed25519":return"EdDSA";default:throw new R("unsupported CryptoKey algorithm name")}}function me(e){return e instanceof CryptoKey}function Be(e){return me(e)&&e.type==="private"}function Ne(e){return me(e)&&e.type==="public"}function Je(){return Math.floor(Date.now()/1e3)}async function Z(e,o,t,n,r,i){let c=e?.privateKey,a=e?.publicKey;if(!Be(c))throw new TypeError('"keypair.privateKey" must be a private CryptoKey');if(!Ne(a))throw new TypeError('"keypair.publicKey" must be a public CryptoKey');if(a.extractable!==!0)throw new TypeError('"keypair.publicKey.extractable" must be true');if(typeof o!="string")throw new TypeError('"htu" must be a string');if(typeof t!="string")throw new TypeError('"htm" must be a string');if(n!==void 0&&typeof n!="string")throw new TypeError('"nonce" must be a string or undefined');if(r!==void 0&&typeof r!="string")throw new TypeError('"accessToken" must be a string or undefined');if(i!==void 0&&(typeof i!="object"||i===null||Array.isArray(i)))throw new TypeError('"additional" must be an object');return Ue({alg:Ie(c),typ:"dpop+jwt",jwk:await Fe(a)},{...i,iat:Je(),jti:Ke(),htm:t,nonce:n,htu:o,ath:r?N(await crypto.subtle.digest("SHA-256",$(r))):void 0},c)}async function Fe(e){let{kty:o,e:t,n,x:r,y:i,crv:c}=await crypto.subtle.exportKey("jwk",e);return{kty:o,crv:c,e:t,n,x:r,y:i}}async function _e(e,o){let t;if(typeof e!="string"||e.length===0)throw new TypeError('"alg" must be a non-empty string');switch(e){case"PS256":t={name:"RSA-PSS",hash:"SHA-256",modulusLength:o?.modulusLength??2048,publicExponent:new Uint8Array([1,0,1])};break;case"RS256":t={name:"RSASSA-PKCS1-v1_5",hash:"SHA-256",modulusLength:o?.modulusLength??2048,publicExponent:new Uint8Array([1,0,1])};break;case"ES256":t={name:"ECDSA",namedCurve:"P-256"};break;case"EdDSA":t={name:"Ed25519"};break;default:throw new R}return crypto.subtle.generateKey(t,o?.extractable??!1,["sign","verify"])}function te(e){return w(e,{site:p(d),authorization_endpoint:p(d),token_endpoint:p(d),dpop_signing_alg_values_supported:s([])}),async(o,t)=>{let n=await q(),r=await n.get(e.site);if(!r){let a=await _e("ES256");r={domain:e.site,keyPair:a},await n.set(r)}let i=x.url(o.url);if(o.url.startsWith(e.authorization_endpoint)){let a=o.body;a instanceof URLSearchParams||a instanceof FormData?a.set("dpop_jkt",r.keyPair.publicKey):a.dpop_jkt=r.keyPair.publicKey}else if(o.url.startsWith(e.token_endpoint)){let a=await Z(r.keyPair,o.url,o.method);o=o.with({headers:{DPoP:a}})}else if(o.headers.has("Authorization")){let a=localStorage.getItem(i.host+":nonce")||void 0,m=o.headers.get("Authorization").split(" ")[1],y=await Z(r.keyPair,o.url,o.method,a,m);o=o.with({headers:{Authorization:"DPoP "+m,DPoP:y}})}let c=await t(o);return c.headers.get("DPoP-Nonce")&&localStorage.setItem(i.host+":nonce",c.headers.get("DPoP-Nonce")),c}}var J=(...e)=>(o,t)=>e.filter(n=>t.hasOwnKey(n)).length>0?!1:_("root data must have all of",t,e),P=(...e)=>o=>Array.isArray(o)&&e.filter(t=>!o.includes(t)).length==0?!1:_("data must be an array which includes",o,e);var k=["HS256","HS384","HS512","RS256","RS384","RS512","ES256","ES384","ES512"],Q=["client_secret_post","client_secret_basic","client_secret_jwt","private_key_jwt"];async function F(e={}){w(e,{client:s(K(x.client().constructor)),issuer:p(d)});let o={client:x.client().with(z()).with(T()),requireDynamicRegistration:!1};e=Object.assign({},o,e);let t=!1;function n(m){return t}let r={issuer:p(ae(e.issuer,n)),authorization_endpoint:p(d),token_endpoint:p(d),userinfo_endpoint:I(d),jwks_uri:p(d),registration_endpoint:e.requireDynamicRegistration?p(d):I(d),scopes_supported:I(P("openid")),response_types_supported:e.requireDynamicRegistration?p(P("code","id_token","id_token token")):p([]),response_modes_supported:s([]),grant_types_supported:e.requireDynamicRegistration?s(P("authorization_code")):s([]),acr_values_supported:s([]),subject_types_supported:p([]),id_token_signing_alg_values_supported:p(P("RS256")),id_token_encryption_alg_values_supported:s([]),id_token_encryption_enc_values_supported:s([]),userinfo_signing_alg_values_supported:s([]),userinfo_encryption_alg_values_supported:s([]),userinfo_encryption_enc_values_supported:s([]),request_object_signing_alg_values_supported:s(P("RS256")),request_object_encryption_alg_values_supported:s([]),request_object_encryption_enc_values_supported:s([]),token_endpoint_auth_methods_supported:s(D(...Q)),token_endpoint_auth_signing_alg_values_supported:s(P("RS256"),B(P("none"))),display_values_supported:s(D("page","popup","touch","wap")),claim_types_supported:s(D("normal","aggregated","distributed")),claims_supported:I([]),service_documentation:s(d),claims_locales_supported:s([]),ui_locales_supported:s([]),claims_parameter_supported:s(Boolean),request_parameter_supported:s(Boolean),request_uri_parameter_supported:s(Boolean),op_policy_uri:s(d),op_tos_uri:s(d)},i=x.url(e.issuer,".well-known/openid-configuration"),a=(await e.client.get(i)).data;return w(a,r),w(a.issuer,e.issuer),a}async function W(e){let o={redirect_uris:p([d]),response_types:s([]),grant_types:s(D("authorization_code","refresh_token")),application_type:s(b("native","web")),contacts:s([ce]),client_name:s(String),logo_uri:s(d),client_uri:s(d),policy_uri:s(d),tos_uri:s(d),jwks_uri:s(d,B(J("jwks"))),jwks:s(d,B(J("jwks_uri"))),sector_identifier_uri:s(d),subject_type:s(String),id_token_signed_response_alg:s(b(...k)),id_token_encrypted_response_alg:s(b(...k)),id_token_encrypted_response_enc:s(b(...k),J("id_token_encrypted_response_alg")),userinfo_signed_response_alg:s(b(...k)),userinfo_encrypted_response_alg:s(b(...k)),userinfo_encrypted_response_enc:s(b(...k),J("userinfo_encrypted_response_alg")),request_object_signing_alg:s(b(...k)),request_object_encryption_alg:s(b(...k)),request_object_encryption_enc:s(b(...k)),token_endpoint_auth_method:s(b(...Q)),token_endpoint_auth_signing_alg:s(b(...k)),default_max_age:s(Number),require_auth_time:s(Boolean),default_acr_values:s([String]),initiate_login_uri:s([d]),request_uris:s([d])};w(e,{client:s(K(x.client().constructor)),registration_endpoint:d,client_info:o});let t={client:x.client().with(z()).with(T())};e=Object.assign({},t,e);let n=await e.client.post(e.registration_endpoint,{body:e.client_info}),r=n.data;if(!r.client_id||!r.client_secret)throw x.metroError("metro.oidc: Error: dynamic registration of client failed, no client_id or client_secret returned",n);return e.client_info=Object.assign(e.client_info,r),e.client_info}function Y(e){let o;if(typeof localStorage<"u")o={get:t=>JSON.parse(localStorage.getItem("metro/oidc:"+e+":"+t)),set:(t,n)=>localStorage.setItem("metro/oidc:"+e+":"+t,JSON.stringify(n)),has:t=>localStorage.getItem("metro/oidc:"+e+":"+t)!==null};else{let t=new Map;o={get:n=>JSON.parse(t.get("metro/oidc:"+e+":"+n)||null),set:(n,r)=>t.set("metro/oidc:"+e+":"+n,JSON.stringify(r)),has:n=>t.has("metro/oidc:"+e+":"+n)}}return o}function re(e={}){let o={client:L(),force_authorization:!1,use_dpop:!0,authorize_callback:async t=>(window.location.href!=t.href&&window.location.replace(t.href),!1)};return e=Object.assign({},o,e),w(e,{client:p(K(L().constructor)),client_info:p(),issuer:p(d),oauth2:s({}),openid_configuration:s()}),e.store||(e.store=Y(e.issuer)),!e.openid_configuration&&e.store.has("openid_configuration")&&(e.openid_configuration=e.store.get("openid_configuration")),!e.client_info.client_id&&e.store.has("client_info")&&(e.client_info=e.store.get("client_info")),async(t,n)=>{let r;if(!e.force_authorization){try{r=await n(t)}catch(y){if(r.status!=401&&r.status!=403)throw y}if(r.ok||r.status!=401&&r.status!=403)return r}if(e.openid_configuration||(e.openid_configuration=await F({issuer:e.issuer}),e.store.set("openid_configuration",e.openid_configuration)),!e.client_info?.client_id){if(w(e.client_info?.client_name,p()),!e.openid_configuration.registration_endpoint)throw g("metro.oidcmw: Error: issuer "+e.issuer+" does not support dynamic client registration, but you haven't specified a client_id");e.client_info=await W({registration_endpoint:e.openid_configuration.registration_endpoint,client_info:e.client_info}),e.store.set("client_info",e.client_info)}let i=e.scope||"openid",c=Object.assign({site:e.issuer,client:e.client,force_authorization:!0,authorize_callback:e.authorize_callback,oauth2_configuration:{client_id:e.client_info.client_id,client_secret:e.client_info.client_secret,grant_type:"authorization_code",response_type:"code",response_mode:"query",authorization_endpoint:e.openid_configuration.authorization_endpoint,token_endpoint:e.openid_configuration.token_endpoint,scope:i,redirect_uri:e.client_info.redirect_uris[0]}}),a=async(y,u)=>{let f=await u(y);if(f.headers.get("content-type")?.startsWith("application/json")){let h=f.data?.id_token;if(!h){let A=f.clone();try{let V=await A.json();V&&V.id_token&&(h=V.id_token)}catch{}}h&&e.store.set("id_token",h)}return f},m=e.client.with(e.issuer).with(a);if(e.use_dpop){let y={site:e.issuer,authorization_endpoint:e.openid_configuration.authorization_endpoint,token_endpoint:e.openid_configuration.token_endpoint,dpop_signing_alg_values_supported:e.openid_configuration.dpop_signing_alg_values_supported};m=m.with(te(y)),c.client=m}return m=m.with(X(c)),r=await m.fetch(t),r}}function ye(){return de()}function ge(e){if(!e.store){if(!e.issuer)throw g("Must supply options.issuer or options.store to get the id_token");e.store=Y(e.issuer)}return e.store.get("id_token")}var we={oidcmw:re,discover:F,register:W,isRedirected:ye,idToken:ge};globalThis.metro.oidc||(globalThis.metro.oidc=we);var Kt=we;})();
//# sourceMappingURL=browser.min.js.map
