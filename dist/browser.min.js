(()=>{var Je=Object.defineProperty;var Z=(e,r)=>{for(var t in r)Je(e,t,{get:r[t],enumerable:!0})};var ae={};Z(ae,{client:()=>Me,formdata:()=>ke,metroError:()=>j,request:()=>G,response:()=>se,trace:()=>Ve,url:()=>X});var B="https://metro.muze.nl/details/";Symbol.metroProxy||(Symbol.metroProxy=Symbol("isProxy"));Symbol.metroSource||(Symbol.metroSource=Symbol("source"));var K=class e{#e={url:typeof window<"u"?window.location:"https://localhost"};#t=["get","post","put","delete","patch","head","options","query"];static tracers={};constructor(...r){for(let t of r)if(typeof t=="string"||t instanceof String)this.#e.url=""+t;else if(t instanceof e)Object.assign(this.#e,t.#e);else if(t instanceof Function)this.#r([t]);else if(t&&typeof t=="object")for(let n in t)n=="middlewares"?this.#r(t[n]):typeof t[n]=="function"?this.#e[n]=t[n](this.#e[n],this.#e):this.#e[n]=t[n];this.#e.verbs&&(this.#t=this.#e.verbs,delete this.#e.verbs);for(let t of this.#t)this[t]=async function(...n){return this.fetch(G(this.#e,...n,{method:t.toUpperCase()}))};Object.freeze(this)}#r(r){typeof r=="function"&&(r=[r]);let t=r.findIndex(n=>typeof n!="function");if(t>=0)throw j("metro.client: middlewares must be a function or an array of functions "+B+"client/invalid-middlewares-value/",r[t]);Array.isArray(this.#e.middlewares)||(this.#e.middlewares=[]),this.#e.middlewares=this.#e.middlewares.concat(r)}fetch(r,t){if(r=G(r,t),!r.url)throw j("metro.client."+r.method.toLowerCase()+": Missing url parameter "+B+"client/missing-url-param/",r);if(t||(t={}),typeof t!="object"||Array.isArray(t)||t instanceof String)throw j("metro.client.fetch: Options is not an object");let o=[async function(a){if(a[Symbol.metroProxy])if(a.body&&a.body[Symbol.metroSource]){let b=a.body[Symbol.metroSource];a=new Request(a[Symbol.metroSource],{body:b})}else a=a[Symbol.metroSource];let y=await fetch(a);return se(y)}].concat(this.#e?.middlewares?.slice()||[]);t=Object.assign({},this.#e,t);let i;for(let l of o)i=function(a,y){return async function(b){let c,d=Object.values(e.tracers);for(let u of d)u.request&&u.request.call(u,b,y);c=await y(b,a);for(let u of d)u.response&&u.response.call(u,c,y);return c}}(i,l);return i(r)}with(...r){return new e(this,...r)}};function Me(...e){return new K(...e)}function ie(e,r){let t=r.body;return t||(e===null?t=new ReadableStream:e instanceof ReadableStream?t=e:e instanceof Blob?t=e.stream():t=new ReadableStream({start(n){let o;switch(typeof e){case"object":if(typeof e.toString=="function")o=e.toString();else if(e instanceof FormData)o=new URLSearchParams(e).toString();else if(e instanceof ArrayBuffer||ArrayBuffer.isView(e))o=e;else throw j("Cannot convert body to ReadableStream",e);break;case"string":case"number":case"boolean":o=e;break;default:throw j("Cannot convert body to ReadableStream",e)}n.enqueue(o),n.close()}})),new Proxy(t,{get(n,o,i){switch(o){case Symbol.metroProxy:return!0;case Symbol.metroSource:return e;case"toString":return function(){return""+e}}if(e&&typeof e=="object"&&o in e)return typeof e[o]=="function"?function(...l){return e[o].apply(e,l)}:e[o];if(o in n&&o!="toString")return typeof n[o]=="function"?function(...l){return n[o].apply(n,l)}:n[o]},has(n,o){return e&&typeof e=="object"?o in e:o in n},ownKeys(n){return Reflect.ownKeys(e&&typeof e=="object"?e:n)},getOwnPropertyDescriptor(n,o){return Object.getOwnPropertyDescriptor(e&&typeof e=="object"?e:n,o)}})}function Fe(e,r){let t=r||{};!t.url&&r.url&&(t.url=r.url);for(let n of["method","headers","body","mode","credentials","cache","redirect","referrer","referrerPolicy","integrity","keepalive","signal","priority","url"])if(typeof e[n]=="function")e[n](t[n],t);else if(typeof e[n]<"u")if(n=="url")t.url=X(t.url,e.url);else if(n=="headers"){t.headers=new Headers(r.headers),e.headers instanceof Headers||(e.headers=new Headers(e.headers));for(let[o,i]of e.headers.entries())t.headers.set(o,i)}else t[n]=e[n];return t}function G(...e){let r={url:typeof window<"u"?window.location:"https://localhost/",duplex:"half"};for(let o of e)typeof o=="string"||o instanceof URL||o instanceof URLSearchParams?r.url=X(r.url,o):o&&(o instanceof FormData||o instanceof ReadableStream||o instanceof Blob||o instanceof ArrayBuffer||o instanceof DataView)?r.body=o:o&&typeof o=="object"&&Object.assign(r,Fe(o,r));let t=r.body;t&&typeof t=="object"&&!(t instanceof String)&&!(t instanceof ReadableStream)&&!(t instanceof Blob)&&!(t instanceof ArrayBuffer)&&!(t instanceof DataView)&&!(t instanceof FormData)&&!(t instanceof URLSearchParams)&&(typeof TypedArray>"u"||!(t instanceof TypedArray))&&(r.body=JSON.stringify(t));let n=new Request(r.url,r);return Object.freeze(n),new Proxy(n,{get(o,i,l){switch(i){case Symbol.metroSource:return o;case Symbol.metroProxy:return!0;case"with":return function(...a){return t&&a.unshift({body:t}),G(o,...a)};case"body":if(t||(t=o.body),t)return t[Symbol.metroProxy]?t:ie(t,o);break}return o[i]instanceof Function?o[i].bind(o):o[i]}})}function be(e,r){let t=r||{};!t.url&&r.url&&(t.url=r.url);for(let n of["status","statusText","headers","body","url","type","redirected"])typeof e[n]=="function"?e[n](t[n],t):typeof e[n]<"u"&&(n=="url"?t.url=new URL(e.url,t.url||"https://localhost/"):t[n]=e[n]);return t}function se(...e){let r={};for(let n of e)typeof n=="string"?r.body=n:n instanceof Response?Object.assign(r,be(n,r)):n&&typeof n=="object"&&(n instanceof FormData||n instanceof Blob||n instanceof ArrayBuffer||n instanceof DataView||n instanceof ReadableStream||n instanceof URLSearchParams||n instanceof String||typeof TypedArray<"u"&&n instanceof TypedArray?r.body=n:Object.assign(r,be(n,r)));let t=new Response(r.body,r);return Object.freeze(t),new Proxy(t,{get(n,o,i){switch(o){case Symbol.metroProxy:return!0;case Symbol.metroSource:return n;case"with":return function(...l){return se(n,...l)};case"body":return r.body?r.body[Symbol.metroProxy]?r.body:ie(r.body,n):ie("",n);case"ok":return n.status>=200&&n.status<400;case"headers":return n.headers;default:if(o in r&&o!="toString")return r[o];if(o in n&&o!="toString")return typeof n[o]=="function"?function(...l){return n[o].apply(n,l)}:n[o];break}}})}function Se(e,r){typeof r=="function"?r(e.searchParams,e):(r=new URLSearchParams(r),r.forEach((t,n)=>{e.searchParams.append(n,t)}))}function X(...e){let r=["hash","host","hostname","href","password","pathname","port","protocol","username","search","searchParams"],t=new URL("https://localhost/");for(let n of e)if(typeof n=="string"||n instanceof String)t=new URL(n,t);else if(n instanceof URL||typeof Location<"u"&&n instanceof Location)t=new URL(n);else if(n instanceof URLSearchParams)Se(t,n);else if(n&&typeof n=="object")for(let o in n)if(o=="search")typeof n.search=="function"?n.search(t.search,t):t.search=new URLSearchParams(n.search);else if(o=="searchParams")Se(t,n.searchParams);else{if(!r.includes(o))throw j("metro.url: unknown url parameter "+B+"url/unknown-param-name/",o);if(typeof n[o]=="function")n[o](t[o],t);else if(typeof n[o]=="string"||n[o]instanceof String||typeof n[o]=="number"||n[o]instanceof Number||typeof n[o]=="boolean"||n[o]instanceof Boolean)t[o]=""+n[o];else if(typeof n[o]=="object"&&n[o].toString)t[o]=n[o].toString();else throw j("metro.url: unsupported value for "+o+" "+B+"url/unsupported-param-value/",e[o])}else throw j("metro.url: unsupported option value "+B+"url/unsupported-option-value/",n);return Object.freeze(t),new Proxy(t,{get(n,o,i){switch(o){case Symbol.metroProxy:return!0;case Symbol.metroSource:return n;case"with":return function(...l){return X(n,...l)}}return n[o]instanceof Function?n[o].bind(n):n[o]}})}function ke(...e){var r=new FormData;for(let t of e)if(t instanceof FormData)for(let n of t.entries())r.append(n[0],n[1]);else if(t&&typeof t=="object")for(let n of Object.entries(t))if(Array.isArray(n[1]))for(let o of n[1])r.append(n[0],o);else r.append(n[0],n[1]);else throw new j("metro.formdata: unknown option type, only FormData or Object supported",t);return Object.freeze(r),new Proxy(r,{get:(t,n,o)=>{switch(n){case Symbol.metroProxy:return!0;case Symbol.metroSource:return t;case"with":return function(...i){return ke(t,...i)}}return t[n]instanceof Function?t[n].bind(t):t[n]}})}var N={error:(e,...r)=>{console.error("\u24C2\uFE0F  ",e,...r)},info:(e,...r)=>{console.info("\u24C2\uFE0F  ",e,...r)},group:e=>{console.group("\u24C2\uFE0F  "+e)},groupEnd:e=>{console.groupEnd("\u24C2\uFE0F  "+e)}};function j(e,...r){return N.error(e,...r),new Error(e,...r)}var Ve={add(e,r){K.tracers[e]=r},delete(e){delete K.tracers[e]},clear(){K.tracers={}},group(){let e=0;return{request:(r,t)=>{e++,N.group(e),N.info(r?.url,r,t)},response:(r,t)=>{N.info(r?.body?r.body[Symbol.metroSource]:null,r,t),N.groupEnd(e),e--}}}};function U(e){return e=Object.assign({reviver:null,replacer:null,space:""},e),async(r,t)=>{["POST","PUT","PATCH","QUERY"].includes(r.method)?(r=r.with({headers:{"Content-Type":"application/json",Accept:"application/json"}}),r.body&&typeof r.body[Symbol.metroSource]=="object"&&(r=r.with({body:JSON.stringify(r.body[Symbol.metroSource],e.replacer,e.space)}))):r=r.with({headers:{Accept:"application/json"}});let n=await t(r),o=await n.text(),i=JSON.parse(o,e.reviver);return n.with({body:i})}}function C(e){return async(r,t)=>{let n=await t(r);if(!n.ok)if(e&&typeof e[n.status]=="function")n=e[n.status].apply(n,r);else throw new Error(n.status+": "+n.statusText,{cause:n});return n}}var ve=Object.assign({},ae,{mw:{jsonmw:U,thrower:C}});globalThis.metro=ve;var f=ve;globalThis.assertEnabled=!1;function E(e,r){if(globalThis.assertEnabled){let t=A(e,r);if(t)throw console.error("\u{1F170}\uFE0F  Assertions failed because of:",t,"in this source:",e),new Error("Assertions failed",{cause:{problems:t,source:e}})}}function s(e){return function(t,n,o){if(typeof t<"u"&&t!=null&&typeof e<"u")return A(t,e,n,o)}}function S(e){return function(t,n,o){return t==null||typeof t>"u"?m("data is required",t,e||"any value",o):typeof e<"u"?A(t,e,n,o):!1}}function J(e){return function(t,n,o){return t==null||typeof t>"u"?(console.warn("data does not contain recommended value",t,e,o),!1):A(t,e,n,o)}}function x(...e){return function(t,n,o){for(let i of e)if(!A(t,i,n,o))return!1;return m("data does not match oneOf patterns",t,e,o)}}function H(...e){return function(t,n,o){if(!Array.isArray(t))return m("data is not an array",t,"anyOf",o);for(let i of t)if(x(...e)(i))return m("data does not match anyOf patterns",i,e,o);return!1}}function xe(...e){return function(t,n,o){let i=[];for(let l of e)i=i.concat(A(t,l,n,o));if(i=i.filter(Boolean),i.length)return m("data does not match all given patterns",t,e,o,i)}}function h(e,r,t){try{e instanceof URL&&(e=e.href);let n=new URL(e);if(n.href!=e&&!(n.href+"/"==e||n.href==e+"/"))return m("data is not a valid url",e,"validURL",t)}catch{return m("data is not a valid url",e,"validURL",t)}}function Re(e,r,t){if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e))return m("data is not a valid email",e,"validEmail",t)}function I(e){return function(t,n,o){if(!(t instanceof e))return m("data is not an instanceof pattern",t,e,o)}}function M(e){return function(t,n,o){if(!A(t,e,n,o))return m("data matches pattern, when required not to",t,e,o)}}function A(e,r,t,n=""){t||(t=e);let o=[];if(r===Boolean)typeof e!="boolean"&&!(e instanceof Boolean)&&o.push(m("data is not a boolean",e,r,n));else if(r===Number)typeof e!="number"&&!(e instanceof Number)&&o.push(m("data is not a number",e,r,n));else if(r===String)typeof e!="string"&&!(e instanceof String)&&o.push(m("data is not a string",e,r,n)),e==""&&o.push(m("data is an empty string, which is not allowed",e,r,n));else if(r instanceof RegExp)if(Array.isArray(e)){let i=e.findIndex((l,a)=>A(l,r,t,n+"["+a+"]"));i>-1&&o.push(m("data["+i+"] does not match pattern",e[i],r,n+"["+i+"]"))}else typeof e>"u"?o.push(m("data is undefined, should match pattern",e,r,n)):r.test(e)||o.push(m("data does not match pattern",e,r,n));else if(r instanceof Function){let i=r(e,t,n);i&&(Array.isArray(i)?o=o.concat(i):o.push(i))}else if(Array.isArray(r)){Array.isArray(e)||o.push(m("data is not an array",e,[],n));for(let i of r)for(let l of e.keys()){let a=A(e[l],i,t,n+"["+l+"]");Array.isArray(a)?o=o.concat(a):a&&o.push(a)}}else if(r&&typeof r=="object")if(Array.isArray(e)){let i=e.findIndex((l,a)=>A(l,r,t,n+"["+a+"]"));i>-1&&o.push(m("data["+i+"] does not match pattern",e[i],r,n+"["+i+"]"))}else if(!e||typeof e!="object")o.push(m("data is not an object, pattern is",e,r,n));else if(e instanceof URLSearchParams&&(e=Object.fromEntries(e)),r instanceof Function){let i=A(e,r,t,n);i&&(o=o.concat(i))}else for(let[i,l]of Object.entries(r)){let a=A(e[i],l,t,n+"."+i);a&&(o=o.concat(a))}else r!=e&&o.push(m("data and pattern are not equal",e,r,n));return o.length?o:!1}function m(e,r,t,n,o){let i={message:e,found:r,expected:t,path:n};return o&&(i.problems=o),i}var F=(...e)=>(r,t)=>e.filter(n=>t.hasOwnKey(n)).length>0?!1:m("root data must have all of",t,e),T=(...e)=>r=>Array.isArray(r)&&e.filter(t=>!r.includes(t)).length==0?!1:m("data must be an array which includes",r,e);var P=["HS256","HS384","HS512","RS256","RS384","RS512","ES256","ES384","ES512"],q=["client_secret_post","client_secret_basic","client_secret_jwt","private_key_jwt"];async function V(e={}){E(e,{client:s(I(f.client().constructor)),issuer:S(h)});let r={client:f.client().with(C()).with(U()),requireDynamicRegistration:!1};e=Object.assign({},r,e);let t=!1;function n(y){return t}let o={issuer:S(xe(e.issuer,n)),authorization_endpoint:S(h),token_endpoint:S(h),userinfo_endpoint:J(h),jwks_uri:S(h),registration_endpoint:e.requireDynamicRegistration?S(h):J(h),scopes_supported:J(T("openid")),response_types_supported:e.requireDynamicRegistration?S(T("code","id_token","id_token token")):S([]),response_modes_supported:s([]),grant_types_supported:e.requireDynamicRegistration?s(T("authorization_code")):s([]),acr_values_supported:s([]),subject_types_supported:S([]),id_token_signing_alg_values_supported:S(T("RS256")),id_token_encryption_alg_values_supported:s([]),id_token_encryption_enc_values_supported:s([]),userinfo_signing_alg_values_supported:s([]),userinfo_encryption_alg_values_supported:s([]),userinfo_encryption_enc_values_supported:s([]),request_object_signing_alg_values_supported:s(T("RS256")),request_object_encryption_alg_values_supported:s([]),request_object_encryption_enc_values_supported:s([]),token_endpoint_auth_methods_supported:s(H(...q)),token_endpoint_auth_signing_alg_values_supported:s(T("RS256"),M(T("none"))),display_values_supported:s(H("page","popup","touch","wap")),claim_types_supported:s(H("normal","aggregated","distributed")),claims_supported:J([]),service_documentation:s(h),claims_locales_supported:s([]),ui_locales_supported:s([]),claims_parameter_supported:s(Boolean),request_parameter_supported:s(Boolean),request_uri_parameter_supported:s(Boolean),op_policy_uri:s(h),op_tos_uri:s(h)},i=f.url(e.issuer,".well-known/openid-configuration"),a=(await e.client.get(i)).body[Symbol.metroSource];return E(a,o),E(a.issuer,e.issuer),a}async function W(e){let r={redirect_uris:S([h]),response_types:s([]),grant_types:s(H("authorization_code","refresh_token")),application_type:s(x("native","web")),contacts:s([Re]),client_name:s(String),logo_uri:s(h),client_uri:s(h),policy_uri:s(h),tos_uri:s(h),jwks_uri:s(h,M(F("jwks"))),jwks:s(h,M(F("jwks_uri"))),sector_identifier_uri:s(h),subject_type:s(String),id_token_signed_response_alg:s(x(...P)),id_token_encrypted_response_alg:s(x(...P)),id_token_encrypted_response_enc:s(x(...P),F("id_token_encrypted_response_alg")),userinfo_signed_response_alg:s(x(...P)),userinfo_encrypted_response_alg:s(x(...P)),userinfo_encrypted_response_enc:s(x(...P),F("userinfo_encrypted_response_alg")),request_object_signing_alg:s(x(...P)),request_object_encryption_alg:s(x(...P)),request_object_encryption_enc:s(x(...P)),token_endpoint_auth_method:s(x(...q)),token_endpoint_auth_signing_alg:s(x(...P)),default_max_age:s(Number),require_auth_time:s(Boolean),default_acr_values:s([String]),initiate_login_uri:s([h]),request_uris:s([h])};E(e,{client:s(I(f.client().constructor)),registration_endpoint:h,client_info:r});let t={client:f.client().with(C()).with(U())};e=Object.assign({},t,e);let n=await e.client.post(e.registration_endpoint,{body:e.client_info}),o=n.body;if(!o.client_id||!o.client_secret)throw f.metroError("metro.oidc: Error: dynamic registration of client failed, no client_id or client_secret returned",n);return e.client_info=Object.assign(e.client_info,o),e.client_info}var fe={};Z(fe,{base64url_encode:()=>le,createState:()=>Te,default:()=>te,generateCodeChallenge:()=>Ee,generateCodeVerifier:()=>je,getExpires:()=>ue,isExpired:()=>Oe,isRedirected:()=>$e});globalThis.assertEnabled=!1;var O=(e,r)=>{if(globalThis.assertEnabled){let t=R(e,r);if(t)throw new ce("Assertions failed",t,e)}},g=e=>r=>r==null||typeof r>"u"?!1:R(r,e),v=e=>r=>R(r,e),Ae=e=>r=>r==null||typeof r>"u"?(console.warning("data does not contain recommended value",r,e),!1):R(r,e),$=(...e)=>r=>{for(let t of e)if(!R(r,t))return!1;return k("data does not match oneOf patterns",r,e)},Pe=(...e)=>r=>{if(!Array.isArray(r))return k("data is not an array",r,"anyOf");for(let t of r)if($(...e)(t))return k("data does not match anyOf patterns",t,e);return!1};function w(e){try{if(e instanceof URL&&(e=e.href),new URL(e).href!=e)return k("data is not a valid url",e,"validURL")}catch{return k("data is not a valid url",e,"validURL")}return!1}function R(e,r,t){t||(t=e);let n=[];if(r===Boolean)typeof e!="boolean"&&n.push(k("data is not a boolean",e,r));else if(r===Number)typeof e!="number"&&n.push(k("data is not a number",e,r));else if(r instanceof RegExp)if(Array.isArray(e)){let o=e.findIndex(i=>R(i,r,t));o>-1&&n.push(k("data["+o+"] does not match pattern",e[o],r))}else r.test(e)||n.push(k("data does not match pattern",e,r));else if(r instanceof Function)r(e,t)&&n.push(k("data does not match function",e,r));else if(Array.isArray(r)){Array.isArray(e)||n.push(k("data is not an array",e,[]));for(p of r){let o=R(e,p,t);Array.isArray(o)?n.concat(o):o&&n.push(o)}}else if(r&&typeof r=="object")if(Array.isArray(e)){let o=e.findIndex(i=>R(i,r,t));o>-1&&n.push(k("data["+o+"] does not match pattern",e[o],r))}else if(!e||typeof e!="object")n.push(k("data is not an object, pattern is",e,r));else{e instanceof URLSearchParams&&(e=Object.fromEntries(e));let o=n[n.length-1];for(let[i,l]of Object.entries(r)){let a=R(e[i],l,t);a&&((!o||typeof o=="string")&&(o={},n.push(k(o,e[i],l))),o[i]=a.problems)}}else r!=e&&n.push(k("data and pattern are not equal",e,r));return n.length?n:!1}var ce=class extends Error{constructor(r,t,...n){super(r),this.problems=t,this.details=n}};function k(e,r,t){return{message:e,found:r,expected:t}}function ee(e){let r,t;if(typeof localStorage<"u")r={get:()=>localStorage.getItem("metro/state:"+e),set:n=>localStorage.setItem("metro/state:"+e,n),has:()=>localStorage.getItem("metro/state:"+e)!==null},t={get:n=>JSON.parse(localStorage.getItem(e+":"+n)),set:(n,o)=>localStorage.setItem(e+":"+n,JSON.stringify(o)),has:n=>localStorage.getItem(e+":"+n)!==null};else{let n=new Map;r={get:()=>n.get("metro/state:"+e),set:o=>n.set("metro/state:"+e,o),has:()=>n.has("metro/state:"+e)},t=new Map}return{state:r,tokens:t}}function te(e){let r={client:f.client(),force_authorization:!1,site:"default",oauth2_configuration:{authorization_endpoint:"/authorize",token_endpoint:"/token",redirect_uri:globalThis.document?.location.href,grant_type:"authorization_code",code_verifier:je(64)},callbacks:{authorize:async c=>(window.location.href!=c.href&&window.location.replace(c.href),!1)}};O(e,{});let t=Object.assign({},r.oauth2_configuration,e?.oauth2_configuration);e=Object.assign({},r,e),e.oauth2_configuration=t;let n=ee(e.site);e.tokens||(e.tokens=n.tokens),e.state||(e.state=n.state),O(e,{oauth2_configuration:{client_id:v(/.+/),grant_type:"authorization_code",authorization_endpoint:v(w),token_endpoint:v(w),redirect_uri:v(w)}});for(let c in t)switch(c){case"access_token":case"authorization_code":case"refresh_token":e.tokens.set(c,t[c]);break}return async function(c,d){if(e.force_authorization)return o(c,d);let u;try{if(u=await d(c),u.ok)return u}catch(_){switch(u.status){case 400:case 401:return o(c,d)}throw _}if(!u.ok)switch(u.status){case 400:case 401:return o(c,d)}return u};async function o(c,d){i();let u=e.tokens.get("access_token");if(u)if(Oe(u)){try{if(!await a())return f.response("false")}catch(_){throw _}return o(c,d)}else return c=f.request(c,{headers:{Authorization:u.type+" "+u.value}}),d(c);else{try{if(!await l())return f.response("false")}catch(_){throw _}return o(c,d)}}function i(){if(typeof window<"u"&&window?.location){let c=f.url(window.location),d,u,_;if(c.searchParams.has("code"))_=c.searchParams,c=c.with({search:""}),history.pushState({},"",c.href);else if(c.hash){let D=c.hash.substr(1);_=new URLSearchParams("?"+D),c=c.with({hash:""}),history.pushState({},"",c.href)}if(_){d=_.get("code"),u=_.get("state");let D=e.state.get("metro/state");if(!u||u!==D)return;d&&e.tokens.set("authorization_code",d)}}}async function l(){if(t.grant_type==="authorization_code"&&!e.tokens.has("authorization_code")){let _=y();if(!e.callbacks.authorize||typeof e.callbacks.authorize!="function")throw f.metroError("oauth2mw: oauth2 with grant_type:authorization_code requires a callback function in client options.options.callbacks.authorize");let D=await e.callbacks.authorize(_);if(D)e.tokens.set("authorization_code",D);else return!1}let c=b(),d=await e.client.post(c);if(!d.ok){let _=await d.text();throw f.metroError("OAuth2mw: fetch access_token: "+d.status+": "+d.statusText,{cause:c})}let u=await d.json();if(e.tokens.set("access_token",{value:u.access_token,expires:ue(u.expires_in),type:u.token_type,scope:u.scope}),u.refresh_token){let _={value:u.refresh_token};e.tokens.set("refresh_token",_)}return u}async function a(){let c=b("refresh_token"),d=await e.client.post(c);if(!d.ok)throw f.metroError("OAuth2mw: refresh access_token: "+d.status+": "+d.statusText,{cause:c});let u=await d.json();if(e.tokens.set("access_token",{value:u.access_token,expires:ue(u.expires_in),type:u.token_type,scope:u.scope}),u.refresh_token){let _={value:u.refresh_token};e.tokens.set("refresh_token",_)}else return!1;return u}function y(){if(!t.authorization_endpoint)throw f.metroError("oauth2mw: Missing options.oauth2_configuration.authorization_endpoint");let c=f.url(t.authorization_endpoint,{hash:""});O(t,{client_id:/.+/,redirect_uri:/.+/,scope:/.*/});let d={response_type:"code",client_id:t.client_id,redirect_uri:t.redirect_uri,state:t.state||Te(40)};return e.state.set(d.state),t.client_secret&&(d.client_secret=t.client_secret),t.code_verifier&&(d.code_challenge=Ee(t.code_verifier),d.code_challenge_method="S256"),t.scope&&(d.scope=t.scope),f.url(c,{search:d})}function b(c=null){if(O(t,{client_id:/.+/,redirect_uri:/.+/}),!t.token_endpoint)throw f.metroError("oauth2mw: Missing options.endpoints.token url");let d=f.url(t.token_endpoint,{hash:""}),u={grant_type:c||t.grant_type,client_id:t.client_id};switch(t.code_verifier&&(u.code_verifier=le(t.code_verifier)),t.client_secret&&(u.client_secret=t.client_secret),t.scope&&(u.scope=t.scope),t.grant_type){case"authorization_code":if(u.redirect_uri=t.redirect_uri,u.code=e.tokens.get("authorization_code"),e.dpop){let _=e.tokens.get("keyPair");u.dpop_jkt=_.publicKey}break;case"client_credentials":break;case"refresh_token":u.refresh_token=t.refresh_token;break;default:throw new Error("Unknown grant_type: ".oauth2.grant_type)}return f.request(d,{method:"POST",body:new URLSearchParams(u)})}}function Oe(e){if(!e)return!0;let r=new Date(e.expires);return new Date().getTime()>r.getTime()}function ue(e){if(e instanceof Date)return new Date(e.getTime());if(typeof e=="number"){let r=new Date;return r.setSeconds(r.getSeconds()+e),r}throw new TypeError("Unknown expires type "+e)}function je(e=64){let r=new Uint8Array(e);return globalThis.crypto.getRandomValues(r),r}async function Ee(e){let r=le(e),n=new TextEncoder().encode(r);return await globalThis.crypto.subtle.digest("SHA-256",n)}function le(e){let r=Array.from(new Uint8Array(e),t=>String.fromCharCode(t)).join("");return btoa(r).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}function Te(e){let r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",t="",n=0;for(;n<e;)t+=r.charAt(Math.floor(Math.random()*r.length)),n++;return t}function $e(){let e=new URL(document.location.href);if(!e.searchParams.has("code")){if(e.hash){let r=e.hash.substr(1);if(params=new URLSearchParams("?"+r),params.has("code"))return!0}return!1}return!0}var de={};Z(de,{default:()=>Le});var re={status:200,statusText:"OK",headers:{"Content-Type":"application/json"}},Q=e=>({status:400,statusText:"Bad Request",headers:{"Content-Type":"application/json"},body:JSON.stringify({error:"invalid_request",error_description:e})}),z,ze={};function Le(e={}){return e=Object.assign({},{PKCE:!1,DPoP:!1},e),async(t,n)=>{let o=f.url(t.url);switch(o.pathname){case"/authorize/":if(z=R(o.searchParams,{response_type:"code",client_id:"mockClientId",state:g(/.*/)}))return f.response(Q(z));if(o.searchParams.has("code_challenge")){if(!o.searchParams.has("code_challenge_method"))return f.response(Q("missing code_challenge_method"));ze.code_challenge=o.searchParams.get("code_challenge"),ze.code_challenge_method=o.searchParams.get("code_challenge_method")}return f.response(re,{body:JSON.stringify({code:"mockAuthorizeToken",state:o.searchParams.get("state")})});case"/token/":if(t.body[Symbol.metroSource]instanceof URLSearchParams){let y={};t.body.forEach((b,c)=>y[c]=b),t=t.with({body:y})}if(z=R(t,{method:"POST",body:{grant_type:$("refresh_token","authorization_code")}}))return f.response(Q(z));switch(t.body.grant_type){case"refresh_token":if(z=R(t.body,$({refresh_token:"mockRefreshToken",client_id:"mockClientId",client_secret:"mockClientSecret"},{refresh_token:"mockRefreshToken",client_id:"mockClientId",code_verifier:/.+/})))return f.response(Q(z));break;case"access_token":if(z=R(t.body,$({client_id:"mockClientId",client_secret:"mockClientSecret"},{client_id:"mockClientId",code_challenge:/.*/,code_challenge_method:"S256"})))return f.response(Q(z));break}return f.response(re,{body:JSON.stringify({access_token:"mockAccessToken",token_type:"mockExample",expires_in:3600,refresh_token:"mockRefreshToken",example_parameter:"mockExampleValue"})});case"/protected/":let i=t.headers.get("Authorization"),[l,a]=i?i.split(" "):[];return!a||a!=="mockAccessToken"?f.response({status:401,statusText:"Forbidden",body:"401 Forbidden"}):f.response(re,{body:JSON.stringify({result:"Success"})});case"/public/":return f.response(re,{body:JSON.stringify({result:"Success"})});default:return f.response({status:404,statusText:"not found",body:"404 Not Found "+o})}}}var he={};Z(he,{default:()=>De});var Ue=["HS256","HS384","HS512","RS256","RS384","RS512","ES256","ES384","ES512"],Ce=["client_secret_post","client_secret_base","client_secret_jwt","private_key_jwt"],Qe={issuer:v(w),authorization_endpoint:v(w),token_endpoint:v(w),jwks_uri:g(w),registration_endpoint:g(w),scopes_supported:Ae([]),response_types_supported:v(Pe("code","token")),response_modes_supported:g([]),grant_types_supported:g([]),token_endpoint_auth_methods_supported:g([]),token_endpoint_auth_signing_alg_values_supported:g([]),service_documentation:g(w),ui_locales_supported:g([]),op_policy_uri:g(w),op_tos_uri:g(w),revocation_endpoint:g(w),revocation_endpoint_auth_methods_supported:g(Ce),revocation_endpoint_auth_signing_alg_values_supported:g(Ue),introspection_endpoint:g(w),introspection_endpoint_auth_methods_supported:g(Ce),introspection_endpoint_auth_signing_alg_values_supported:g(Ue),code_challendge_methods_supported:g([])};function De(e={}){let r={client:f.client()};e=Object.assign({},r,e),O(e,{issuer:v(w)});let t=Ye(e.issuer),n=e.client.with(e.issuer)}async function Ye(e,r){let t=r.get(f.url(e,".wellknown/oauth_authorization_server"));if(t.ok){O(t.headers.get("Content-Type"),/application\/json.*/);let n=await t.json();return O(n,Qe),n}throw f.metroError("metro.oidcmw: Error while fetching "+e+".wellknown/oauth_authorization_server",t)}var Ze=new TextEncoder,Ge=new TextDecoder;function ne(e){return typeof e=="string"?Ze.encode(e):Ge.decode(e)}function Ke(e){if(typeof e.modulusLength!="number"||e.modulusLength<2048)throw new pe(`${e.name} modulusLength must be at least 2048 bits`)}function Xe(e){switch(e.algorithm.name){case"ECDSA":return{name:e.algorithm.name,hash:"SHA-256"};case"RSA-PSS":return Ke(e.algorithm),{name:e.algorithm.name,saltLength:32};case"RSASSA-PKCS1-v1_5":return Ke(e.algorithm),{name:e.algorithm.name};case"Ed25519":return{name:e.algorithm.name}}throw new L}async function qe(e,r,t){if(t.usages.includes("sign")===!1)throw new TypeError('private CryptoKey instances used for signing assertions must include "sign" in their "usages"');let n=`${Y(ne(JSON.stringify(e)))}.${Y(ne(JSON.stringify(r)))}`,o=Y(await crypto.subtle.sign(Xe(t),t,ne(n)));return`${n}.${o}`}var He=32768;function et(e){e instanceof ArrayBuffer&&(e=new Uint8Array(e));let r=[];for(let t=0;t<e.byteLength;t+=He)r.push(String.fromCharCode.apply(null,e.subarray(t,t+He)));return btoa(r.join("")).replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_")}function Y(e){return et(e)}function tt(){return Y(crypto.getRandomValues(new Uint8Array(32)))}var L=class extends Error{constructor(r){super(r??"operation not supported"),this.name=this.constructor.name,Error.captureStackTrace?.(this,this.constructor)}},pe=class extends Error{constructor(r){super(r),this.name=this.constructor.name,Error.captureStackTrace?.(this,this.constructor)}};function rt(e){switch(e.algorithm.hash.name){case"SHA-256":return"PS256";default:throw new L("unsupported RsaHashedKeyAlgorithm hash name")}}function nt(e){switch(e.algorithm.hash.name){case"SHA-256":return"RS256";default:throw new L("unsupported RsaHashedKeyAlgorithm hash name")}}function ot(e){switch(e.algorithm.namedCurve){case"P-256":return"ES256";default:throw new L("unsupported EcKeyAlgorithm namedCurve")}}function it(e){switch(e.algorithm.name){case"RSA-PSS":return rt(e);case"RSASSA-PKCS1-v1_5":return nt(e);case"ECDSA":return ot(e);case"Ed25519":return"EdDSA";default:throw new L("unsupported CryptoKey algorithm name")}}function Ie(e){return e instanceof CryptoKey}function st(e){return Ie(e)&&e.type==="private"}function at(e){return Ie(e)&&e.type==="public"}function ct(){return Math.floor(Date.now()/1e3)}async function oe(e,r,t,n,o,i){let l=e?.privateKey,a=e?.publicKey;if(!st(l))throw new TypeError('"keypair.privateKey" must be a private CryptoKey');if(!at(a))throw new TypeError('"keypair.publicKey" must be a public CryptoKey');if(a.extractable!==!0)throw new TypeError('"keypair.publicKey.extractable" must be true');if(typeof r!="string")throw new TypeError('"htu" must be a string');if(typeof t!="string")throw new TypeError('"htm" must be a string');if(n!==void 0&&typeof n!="string")throw new TypeError('"nonce" must be a string or undefined');if(o!==void 0&&typeof o!="string")throw new TypeError('"accessToken" must be a string or undefined');if(i!==void 0&&(typeof i!="object"||i===null||Array.isArray(i)))throw new TypeError('"additional" must be an object');return qe({alg:it(l),typ:"dpop+jwt",jwk:await ut(a)},{...i,iat:ct(),jti:tt(),htm:t,nonce:n,htu:r,ath:o?Y(await crypto.subtle.digest("SHA-256",ne(o))):void 0},l)}async function ut(e){let{kty:r,e:t,n,x:o,y:i,crv:l}=await crypto.subtle.exportKey("jwk",e);return{kty:r,crv:l,e:t,n,x:o,y:i}}async function Ne(e,r){let t;if(typeof e!="string"||e.length===0)throw new TypeError('"alg" must be a non-empty string');switch(e){case"PS256":t={name:"RSA-PSS",hash:"SHA-256",modulusLength:r?.modulusLength??2048,publicExponent:new Uint8Array([1,0,1])};break;case"RS256":t={name:"RSASSA-PKCS1-v1_5",hash:"SHA-256",modulusLength:r?.modulusLength??2048,publicExponent:new Uint8Array([1,0,1])};break;case"ES256":t={name:"ECDSA",namedCurve:"P-256"};break;case"EdDSA":t={name:"Ed25519"};break;default:throw new L}return crypto.subtle.generateKey(t,r?.extractable??!1,["sign","verify"])}function me(){return new Promise((e,r)=>{let t=globalThis.indexedDB.open("metro",1);t.onupgradeneeded=()=>t.result.createObjectStore("keyPairs",{keyPath:"domain"}),t.onerror=n=>{r(n)},t.onsuccess=n=>{let o=n.target.result;e({set:function(i,l){return new Promise((a,y)=>{let b=o.transaction("keyPairs","readwrite"),c=b.objectStore("keyPairs");b.oncomplete=()=>{a()},b.onerror=y,c.put(i,l)})},get:function(i){return new Promise((l,a)=>{let y=o.transaction("keyPairs","readwrite"),c=y.objectStore("keyPairs").get(i);c.onsuccess=()=>{l(c.result)},c.onerror=a,y.onerror=a})}})}})}function _e(e){return O(e,{authorization_endpoint:v(w),token_endpoint:v(w),dpop_signing_alg_values_supported:v([])}),async(r,t)=>{console.log("dpop",r.url);let n=await me(),o=f.url(r.url),i=await n.get(o.host);if(!i){let a=await Ne("ES256");i={domain:o.host,keyPair:a},await n.set(i)}if(o.href.startsWith(e.authorization_endpoint)||o.href.startsWith(e.token_endpoint)){let a=await oe(i.keyPair,r.url,r.method);r=r.with({headers:{DPoP:a}})}else if(r.headers.has("Authorization")){let a=localStorage.getItem(o.host+":nonce")||void 0,y=r.headers.get("Authorization").split(" ")[1],b=await oe(i.keyPair,r.url,r.method,a,y);r=r.with({headers:{Authorization:"DPoP "+y,DPoP:b}})}let l=await t(r);return l.headers.get("DPoP-Nonce")&&localStorage.setItem(o.host+":nonce",l.headers.get("DPoP-Nonce")),l}}var lt=Object.assign(te,fe,{mockserver:de,discovery:he,tokenstore:ee,dpopmw:_e}),ye=lt;function ge(e){let r;if(typeof localStorage<"u")r={get:t=>JSON.parse(localStorage.getItem("metro/oidc:"+e+":"+t)),set:(t,n)=>localStorage.setItem("metro/oidc:"+e+":"+t,JSON.stringify(n)),has:t=>localStorage.getItem("metro/oidc:"+e+":"+t)!==null};else{let t=new Map;r={get:n=>JSON.parse(t.get("metro/oidc:"+e+":"+n)||null),set:(n,o)=>t.set("metro/oidc:"+e+":"+n,JSON.stringify(o)),has:n=>t.has("metro/oidc:"+e+":"+n)}}return r}function we(e={}){let r={client:f.client(),force_authorization:!1};return e=Object.assign({},r,e),E(e,{client:S(I(f.client().constructor)),client_info:S(),issuer:S(h),oauth2:s({}),openid_configuration:s()}),e.store||(e.store=ge(e.issuer)),!e.openid_configuration&&e.store.has("openid_configuration")&&(e.openid_configuration=e.store.get("openid_configuration")),!e.client_info.client_id&&e.store.has("client_info")&&(e.client_info=e.store.get("client_info")),async(t,n)=>{let o;if(!e.force_authorization){try{o=await n(t)}catch(b){if(o.status!=401&&o.status!=403)throw b}if(o.ok||o.status!=401&&o.status!=403)return o}if(e.openid_configuration||(e.openid_configuration=await V({issuer:e.issuer}),e.store.set("openid_configuration",e.openid_configuration)),!e.client_info?.client_id){if(E(e.client_info?.client_name,S()),!e.openid_configuration.registration_endpoint)throw f.metroError("metro.oidcmw: Error: issuer "+e.issuer+" does not support dynamic client registration, but you haven't specified a client_id");e.client_info=await W({registration_endpoint:e.openid_configuration.registration_endpoint,client_info:e.client_info}),e.store.set("client_info",e.client_info)}let i=Object.assign({site:e.issuer,client:e.client,force_authorization:!0,oauth2_configuration:{client_id:e.client_info.client_id,client_secret:e.client_info.client_secret,code_verifier:!1,grant_type:"authorization_code",authorization_endpoint:e.openid_configuration.authorization_endpoint,token_endpoint:e.openid_configuration.token_endpoint,scope:e.openid_configuration.scope||"openid",redirect_uri:e.client_info.redirect_uris[0]}}),l={authorization_endpoint:e.openid_configuration.authorization_endpoint,token_endpoint:e.openid_configuration.token_endpoint,dpop_signing_alg_values_supported:e.openid_configuration.dpop_signing_alg_values_supported},a=e.client.with(e.issuer).with(ye.DPoPmw(l));return i.client=a,o=await a.with(ye(i)).fetch(t),o}}function Be(){return oauth2isRedirected()}var ft={discover:V,register:W,oidcmw:we,isRedirected:Be};globalThis.oidc=ft;})();
//# sourceMappingURL=browser.min.js.map
