(()=>{var Ve=Object.defineProperty;var X=(e,r)=>{for(var t in r)Ve(e,t,{get:r[t],enumerable:!0})};var le={};X(le,{client:()=>We,formdata:()=>Se,metroError:()=>E,request:()=>q,response:()=>ue,trace:()=>Qe,url:()=>ee});var J="https://metro.muze.nl/details/";Symbol.metroProxy||(Symbol.metroProxy=Symbol("isProxy"));Symbol.metroSource||(Symbol.metroSource=Symbol("source"));var K=class e{#e={url:typeof window<"u"?window.location:"https://localhost"};#t=["get","post","put","delete","patch","head","options","query"];static tracers={};constructor(...r){for(let t of r)if(typeof t=="string"||t instanceof String)this.#e.url=""+t;else if(t instanceof e)Object.assign(this.#e,t.#e);else if(t instanceof Function)this.#r([t]);else if(t&&typeof t=="object")for(let o in t)o=="middlewares"?this.#r(t[o]):typeof t[o]=="function"?this.#e[o]=t[o](this.#e[o],this.#e):this.#e[o]=t[o];this.#e.verbs&&(this.#t=this.#e.verbs,delete this.#e.verbs);for(let t of this.#t)this[t]=async function(...o){return this.fetch(q(this.#e,...o,{method:t.toUpperCase()}))};Object.freeze(this)}#r(r){typeof r=="function"&&(r=[r]);let t=r.findIndex(o=>typeof o!="function");if(t>=0)throw E("metro.client: middlewares must be a function or an array of functions "+J+"client/invalid-middlewares-value/",r[t]);Array.isArray(this.#e.middlewares)||(this.#e.middlewares=[]),this.#e.middlewares=this.#e.middlewares.concat(r)}fetch(r,t){if(r=q(r,t),!r.url)throw E("metro.client."+r.method.toLowerCase()+": Missing url parameter "+J+"client/missing-url-param/",r);if(t||(t={}),typeof t!="object"||Array.isArray(t)||t instanceof String)throw E("metro.client.fetch: Options is not an object");let n=[async function(a){a[Symbol.metroProxy]&&(a=a[Symbol.metroSource]);let y=await fetch(a);return ue(y)}].concat(this.#e?.middlewares?.slice()||[]);t=Object.assign({},this.#e,t);let i;for(let l of n)i=function(a,y){return async function(g){let c,d=Object.values(e.tracers);for(let u of d)u.request&&u.request.call(u,g,y);c=await y(g,a);for(let u of d)u.response&&u.response.call(u,c,y);return c}}(i,l);return i(r)}with(...r){return new e(this,...r)}};function We(...e){return new K(...e)}function $e(e,r){let t=r||{};!t.url&&r.url&&(t.url=r.url);for(let o of["method","headers","body","mode","credentials","cache","redirect","referrer","referrerPolicy","integrity","keepalive","signal","priority","url"]){let n=e[o];if(!(typeof n>"u"||n==null))if(n?.[Symbol.metroProxy]&&(n=n[Symbol.metroSource]),typeof n=="function")t[o]=n(t[o],t);else if(o=="url")t.url=ee(t.url,n);else if(o=="headers"){t.headers=new Headers(r.headers),n instanceof Headers||(n=new Headers(e.headers));for(let[i,l]of n.entries())t.headers.set(i,l)}else t[o]=n}return e instanceof Request&&e.data&&(t.body=e.data),t}function q(...e){let r={url:typeof window<"u"?window.location:"https://localhost/",duplex:"half"};for(let n of e)typeof n=="string"||n instanceof URL||n instanceof URLSearchParams?r.url=ee(r.url,n):n&&(n instanceof FormData||n instanceof ReadableStream||n instanceof Blob||n instanceof ArrayBuffer||n instanceof DataView)?r.body=n:n&&typeof n=="object"&&Object.assign(r,$e(n,r));let t=r.body;t&&typeof t=="object"&&!(t instanceof String)&&!(t instanceof ReadableStream)&&!(t instanceof Blob)&&!(t instanceof ArrayBuffer)&&!(t instanceof DataView)&&!(t instanceof FormData)&&!(t instanceof URLSearchParams)&&(typeof TypedArray>"u"||!(t instanceof TypedArray))&&(r.body=JSON.stringify(t));let o=new Request(r.url,r);return Object.freeze(o),new Proxy(o,{get(n,i,l){switch(i){case Symbol.metroSource:return n;case Symbol.metroProxy:return!0;case"with":return function(...a){return t&&a.unshift({body:t}),q(n,...a)};case"body":break;case"data":return t}return n[i]instanceof Function?n[i].bind(n):n[i]}})}function be(e,r){let t=r||{};!t.url&&r.url&&(t.url=r.url);for(let o of["status","statusText","headers","body","url","type","redirected"]){let n=e[o];typeof n>"u"||n==null||(n?.[Symbol.metroProxy]&&(n=n[Symbol.metroSource]),typeof n=="function"?t[o]=n(t[o],t):o=="url"?t.url=new URL(n,t.url||"https://localhost/"):t[o]=n)}return e instanceof Response&&e.data&&(t.body=e.data),t}function ue(...e){let r={};for(let n of e)typeof n=="string"?r.body=n:n instanceof Response?Object.assign(r,be(n,r)):n&&typeof n=="object"&&(n instanceof FormData||n instanceof Blob||n instanceof ArrayBuffer||n instanceof DataView||n instanceof ReadableStream||n instanceof URLSearchParams||n instanceof String||typeof TypedArray<"u"&&n instanceof TypedArray?r.body=n:Object.assign(r,be(n,r)));let t;r.body&&(t=r.body);let o=new Response(r.body,r);return Object.freeze(o),new Proxy(o,{get(n,i,l){switch(i){case Symbol.metroProxy:return!0;case Symbol.metroSource:return n;case"with":return function(...a){return ue(n,...a)};case"data":return t;case"ok":return n.status>=200&&n.status<400}return typeof n[i]=="function"?n[i].bind(n):n[i]}})}function ke(e,r){typeof r=="function"?r(e.searchParams,e):(r=new URLSearchParams(r),r.forEach((t,o)=>{e.searchParams.append(o,t)}))}function ee(...e){let r=["hash","host","hostname","href","password","pathname","port","protocol","username","search","searchParams"],t=new URL("https://localhost/");for(let o of e)if(typeof o=="string"||o instanceof String)t=new URL(o,t);else if(o instanceof URL||typeof Location<"u"&&o instanceof Location)t=new URL(o);else if(o instanceof URLSearchParams)ke(t,o);else if(o&&typeof o=="object")for(let n in o)if(n=="search")typeof o.search=="function"?o.search(t.search,t):t.search=new URLSearchParams(o.search);else if(n=="searchParams")ke(t,o.searchParams);else{if(!r.includes(n))throw E("metro.url: unknown url parameter "+J+"url/unknown-param-name/",n);if(typeof o[n]=="function")o[n](t[n],t);else if(typeof o[n]=="string"||o[n]instanceof String||typeof o[n]=="number"||o[n]instanceof Number||typeof o[n]=="boolean"||o[n]instanceof Boolean)t[n]=""+o[n];else if(typeof o[n]=="object"&&o[n].toString)t[n]=o[n].toString();else throw E("metro.url: unsupported value for "+n+" "+J+"url/unsupported-param-value/",e[n])}else throw E("metro.url: unsupported option value "+J+"url/unsupported-option-value/",o);return Object.freeze(t),new Proxy(t,{get(o,n,i){switch(n){case Symbol.metroProxy:return!0;case Symbol.metroSource:return o;case"with":return function(...l){return ee(o,...l)}}return o[n]instanceof Function?o[n].bind(o):o[n]}})}function Se(...e){var r=new FormData;for(let t of e)if(t instanceof FormData)for(let o of t.entries())r.append(o[0],o[1]);else if(t&&typeof t=="object")for(let o of Object.entries(t))if(Array.isArray(o[1]))for(let n of o[1])r.append(o[0],n);else r.append(o[0],o[1]);else throw new E("metro.formdata: unknown option type, only FormData or Object supported",t);return Object.freeze(r),new Proxy(r,{get:(t,o,n)=>{switch(o){case Symbol.metroProxy:return!0;case Symbol.metroSource:return t;case"with":return function(...i){return Se(t,...i)}}return t[o]instanceof Function?t[o].bind(t):t[o]}})}var N={error:(e,...r)=>{console.error("\u24C2\uFE0F  ",e,...r)},info:(e,...r)=>{console.info("\u24C2\uFE0F  ",e,...r)},group:e=>{console.group("\u24C2\uFE0F  "+e)},groupEnd:e=>{console.groupEnd("\u24C2\uFE0F  "+e)}};function E(e,...r){return N.error(e,...r),new Error(e,...r)}var Qe={add(e,r){K.tracers[e]=r},delete(e){delete K.tracers[e]},clear(){K.tracers={}},group(){let e=0;return{request:(r,t)=>{e++,N.group(e),N.info(r?.url,r,t)},response:(r,t)=>{N.info(r?.body?r.body[Symbol.metroSource]:null,r,t),N.groupEnd(e),e--}}}};function C(e){return e=Object.assign({reviver:null,replacer:null,space:""},e),async(r,t)=>{["POST","PUT","PATCH","QUERY"].includes(r.method)?(r=r.with({headers:{"Content-Type":"application/json",Accept:"application/json"}}),r.data&&typeof r.data=="object"&&!(r.data instanceof ReadableStream)&&(r=r.with({body:JSON.stringify(r.data,e.replacer,e.space)}))):r=r.with({headers:{Accept:"application/json"}});let o=await t(r),n=await o.text(),i=JSON.parse(n,e.reviver);return o.with({body:i})}}function D(e){return async(r,t)=>{let o=await t(r);if(!o.ok)if(e&&typeof e[o.status]=="function")o=e[o.status].apply(o,r);else throw new Error(o.status+": "+o.statusText,{cause:o});return o}}var xe=Object.assign({},le,{mw:{jsonmw:C,thrower:D}});globalThis.metro=xe;var f=xe;globalThis.assertEnabled=!1;function j(e,r){if(globalThis.assertEnabled){let t=R(e,r);if(t)throw console.error("\u{1F170}\uFE0F  Assertions failed because of:",t,"in this source:",e),new Error("Assertions failed",{cause:{problems:t,source:e}})}}function s(e){return function(t,o,n){if(typeof t<"u"&&t!=null&&typeof e<"u")return R(t,e,o,n)}}function k(e){return function(t,o,n){return t==null||typeof t>"u"?_("data is required",t,e||"any value",n):typeof e<"u"?R(t,e,o,n):!1}}function M(e){return function(t,o,n){return t==null||typeof t>"u"?(console.warn("data does not contain recommended value",t,e,n),!1):R(t,e,o,n)}}function v(...e){return function(t,o,n){for(let i of e)if(!R(t,i,o,n))return!1;return _("data does not match oneOf patterns",t,e,n)}}function H(...e){return function(t,o,n){if(!Array.isArray(t))return _("data is not an array",t,"anyOf",n);for(let i of t)if(v(...e)(i))return _("data does not match anyOf patterns",i,e,n);return!1}}function ve(...e){return function(t,o,n){let i=[];for(let l of e)i=i.concat(R(t,l,o,n));if(i=i.filter(Boolean),i.length)return _("data does not match all given patterns",t,e,n,i)}}function m(e,r,t){try{e instanceof URL&&(e=e.href);let o=new URL(e);if(o.href!=e&&!(o.href+"/"==e||o.href==e+"/"))return _("data is not a valid url",e,"validURL",t)}catch{return _("data is not a valid url",e,"validURL",t)}}function Ae(e,r,t){if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e))return _("data is not a valid email",e,"validEmail",t)}function I(e){return function(t,o,n){if(!(t instanceof e))return _("data is not an instanceof pattern",t,e,n)}}function B(e){return function(t,o,n){if(!R(t,e,o,n))return _("data matches pattern, when required not to",t,e,n)}}function R(e,r,t,o=""){t||(t=e);let n=[];if(r===Boolean)typeof e!="boolean"&&!(e instanceof Boolean)&&n.push(_("data is not a boolean",e,r,o));else if(r===Number)typeof e!="number"&&!(e instanceof Number)&&n.push(_("data is not a number",e,r,o));else if(r===String)typeof e!="string"&&!(e instanceof String)&&n.push(_("data is not a string",e,r,o)),e==""&&n.push(_("data is an empty string, which is not allowed",e,r,o));else if(r instanceof RegExp)if(Array.isArray(e)){let i=e.findIndex((l,a)=>R(l,r,t,o+"["+a+"]"));i>-1&&n.push(_("data["+i+"] does not match pattern",e[i],r,o+"["+i+"]"))}else typeof e>"u"?n.push(_("data is undefined, should match pattern",e,r,o)):r.test(e)||n.push(_("data does not match pattern",e,r,o));else if(r instanceof Function){let i=r(e,t,o);i&&(Array.isArray(i)?n=n.concat(i):n.push(i))}else if(Array.isArray(r)){Array.isArray(e)||n.push(_("data is not an array",e,[],o));for(let i of r)for(let l of e.keys()){let a=R(e[l],i,t,o+"["+l+"]");Array.isArray(a)?n=n.concat(a):a&&n.push(a)}}else if(r&&typeof r=="object")if(Array.isArray(e)){let i=e.findIndex((l,a)=>R(l,r,t,o+"["+a+"]"));i>-1&&n.push(_("data["+i+"] does not match pattern",e[i],r,o+"["+i+"]"))}else if(!e||typeof e!="object")n.push(_("data is not an object, pattern is",e,r,o));else if(e instanceof URLSearchParams&&(e=Object.fromEntries(e)),r instanceof Function){let i=R(e,r,t,o);i&&(n=n.concat(i))}else for(let[i,l]of Object.entries(r)){let a=R(e[i],l,t,o+"."+i);a&&(n=n.concat(a))}else r!=e&&n.push(_("data and pattern are not equal",e,r,o));return n.length?n:!1}function _(e,r,t,o,n){let i={message:e,found:r,expected:t,path:o};return n&&(i.problems=n),i}var F=(...e)=>(r,t)=>e.filter(o=>t.hasOwnKey(o)).length>0?!1:_("root data must have all of",t,e),T=(...e)=>r=>Array.isArray(r)&&e.filter(t=>!r.includes(t)).length==0?!1:_("data must be an array which includes",r,e);var O=["HS256","HS384","HS512","RS256","RS384","RS512","ES256","ES384","ES512"],te=["client_secret_post","client_secret_basic","client_secret_jwt","private_key_jwt"];async function V(e={}){j(e,{client:s(I(f.client().constructor)),issuer:k(m)});let r={client:f.client().with(D()).with(C()),requireDynamicRegistration:!1};e=Object.assign({},r,e);let t=!1;function o(y){return t}let n={issuer:k(ve(e.issuer,o)),authorization_endpoint:k(m),token_endpoint:k(m),userinfo_endpoint:M(m),jwks_uri:k(m),registration_endpoint:e.requireDynamicRegistration?k(m):M(m),scopes_supported:M(T("openid")),response_types_supported:e.requireDynamicRegistration?k(T("code","id_token","id_token token")):k([]),response_modes_supported:s([]),grant_types_supported:e.requireDynamicRegistration?s(T("authorization_code")):s([]),acr_values_supported:s([]),subject_types_supported:k([]),id_token_signing_alg_values_supported:k(T("RS256")),id_token_encryption_alg_values_supported:s([]),id_token_encryption_enc_values_supported:s([]),userinfo_signing_alg_values_supported:s([]),userinfo_encryption_alg_values_supported:s([]),userinfo_encryption_enc_values_supported:s([]),request_object_signing_alg_values_supported:s(T("RS256")),request_object_encryption_alg_values_supported:s([]),request_object_encryption_enc_values_supported:s([]),token_endpoint_auth_methods_supported:s(H(...te)),token_endpoint_auth_signing_alg_values_supported:s(T("RS256"),B(T("none"))),display_values_supported:s(H("page","popup","touch","wap")),claim_types_supported:s(H("normal","aggregated","distributed")),claims_supported:M([]),service_documentation:s(m),claims_locales_supported:s([]),ui_locales_supported:s([]),claims_parameter_supported:s(Boolean),request_parameter_supported:s(Boolean),request_uri_parameter_supported:s(Boolean),op_policy_uri:s(m),op_tos_uri:s(m)},i=f.url(e.issuer,".well-known/openid-configuration"),a=(await e.client.get(i)).data;return j(a,n),j(a.issuer,e.issuer),a}async function W(e){let r={redirect_uris:k([m]),response_types:s([]),grant_types:s(H("authorization_code","refresh_token")),application_type:s(v("native","web")),contacts:s([Ae]),client_name:s(String),logo_uri:s(m),client_uri:s(m),policy_uri:s(m),tos_uri:s(m),jwks_uri:s(m,B(F("jwks"))),jwks:s(m,B(F("jwks_uri"))),sector_identifier_uri:s(m),subject_type:s(String),id_token_signed_response_alg:s(v(...O)),id_token_encrypted_response_alg:s(v(...O)),id_token_encrypted_response_enc:s(v(...O),F("id_token_encrypted_response_alg")),userinfo_signed_response_alg:s(v(...O)),userinfo_encrypted_response_alg:s(v(...O)),userinfo_encrypted_response_enc:s(v(...O),F("userinfo_encrypted_response_alg")),request_object_signing_alg:s(v(...O)),request_object_encryption_alg:s(v(...O)),request_object_encryption_enc:s(v(...O)),token_endpoint_auth_method:s(v(...te)),token_endpoint_auth_signing_alg:s(v(...O)),default_max_age:s(Number),require_auth_time:s(Boolean),default_acr_values:s([String]),initiate_login_uri:s([m]),request_uris:s([m])};j(e,{client:s(I(f.client().constructor)),registration_endpoint:m,client_info:r});let t={client:f.client().with(D()).with(C())};e=Object.assign({},t,e);let o=await e.client.post(e.registration_endpoint,{body:e.client_info}),n=o.data;if(!n.client_id||!n.client_secret)throw f.metroError("metro.oidc: Error: dynamic registration of client failed, no client_id or client_secret returned",o);return e.client_info=Object.assign(e.client_info,n),e.client_info}var pe={};X(pe,{base64url_encode:()=>ne,createState:()=>Te,default:()=>oe,generateCodeChallenge:()=>Ee,generateCodeVerifier:()=>je,getExpires:()=>de,isExpired:()=>Pe,isRedirected:()=>Ze});globalThis.assertEnabled=!1;var P=(e,r)=>{if(globalThis.assertEnabled){let t=A(e,r);if(t)throw new fe("Assertions failed",t,e)}},w=e=>r=>r==null||typeof r>"u"?!1:A(r,e),x=e=>r=>A(r,e),Re=e=>r=>r==null||typeof r>"u"?(console.warning("data does not contain recommended value",r,e),!1):A(r,e),$=(...e)=>r=>{for(let t of e)if(!A(r,t))return!1;return S("data does not match oneOf patterns",r,e)},Oe=(...e)=>r=>{if(!Array.isArray(r))return S("data is not an array",r,"anyOf");for(let t of r)if($(...e)(t))return S("data does not match anyOf patterns",t,e);return!1};function b(e){try{if(e instanceof URL&&(e=e.href),new URL(e).href!=e)return S("data is not a valid url",e,"validURL")}catch{return S("data is not a valid url",e,"validURL")}return!1}function A(e,r,t){t||(t=e);let o=[];if(r===Boolean)typeof e!="boolean"&&o.push(S("data is not a boolean",e,r));else if(r===Number)typeof e!="number"&&o.push(S("data is not a number",e,r));else if(r instanceof RegExp)if(Array.isArray(e)){let n=e.findIndex(i=>A(i,r,t));n>-1&&o.push(S("data["+n+"] does not match pattern",e[n],r))}else r.test(e)||o.push(S("data does not match pattern",e,r));else if(r instanceof Function)r(e,t)&&o.push(S("data does not match function",e,r));else if(Array.isArray(r)){Array.isArray(e)||o.push(S("data is not an array",e,[]));for(p of r){let n=A(e,p,t);Array.isArray(n)?o.concat(n):n&&o.push(n)}}else if(r&&typeof r=="object")if(Array.isArray(e)){let n=e.findIndex(i=>A(i,r,t));n>-1&&o.push(S("data["+n+"] does not match pattern",e[n],r))}else if(!e||typeof e!="object")o.push(S("data is not an object, pattern is",e,r));else{e instanceof URLSearchParams&&(e=Object.fromEntries(e));let n=o[o.length-1];for(let[i,l]of Object.entries(r)){let a=A(e[i],l,t);a&&((!n||typeof n=="string")&&(n={},o.push(S(n,e[i],l))),n[i]=a.problems)}}else r!=e&&o.push(S("data and pattern are not equal",e,r));return o.length?o:!1}var fe=class extends Error{constructor(r,t,...o){super(r),this.problems=t,this.details=o}};function S(e,r,t){return{message:e,found:r,expected:t}}function re(e){let r,t;if(typeof localStorage<"u")r={get:()=>localStorage.getItem("metro/state:"+e),set:o=>localStorage.setItem("metro/state:"+e,o),has:()=>localStorage.getItem("metro/state:"+e)!==null},t={get:o=>JSON.parse(localStorage.getItem(e+":"+o)),set:(o,n)=>localStorage.setItem(e+":"+o,JSON.stringify(n)),has:o=>localStorage.getItem(e+":"+o)!==null};else{let o=new Map;r={get:()=>o.get("metro/state:"+e),set:n=>o.set("metro/state:"+e,n),has:()=>o.has("metro/state:"+e)},t=new Map}return{state:r,tokens:t}}function oe(e){let r={client:f.client(),force_authorization:!1,site:"default",oauth2_configuration:{authorization_endpoint:"/authorize",token_endpoint:"/token",redirect_uri:globalThis.document?.location.href,grant_type:"authorization_code",code_verifier:je(64)},callbacks:{authorize:async c=>(window.location.href!=c.href&&window.location.replace(c.href),!1)}};P(e,{});let t=Object.assign({},r.oauth2_configuration,e?.oauth2_configuration);e=Object.assign({},r,e),e.oauth2_configuration=t;let o=re(e.site);e.tokens||(e.tokens=o.tokens),e.state||(e.state=o.state),P(e,{oauth2_configuration:{client_id:x(/.+/),grant_type:"authorization_code",authorization_endpoint:x(b),token_endpoint:x(b),redirect_uri:x(b)}});for(let c in t)switch(c){case"access_token":case"authorization_code":case"refresh_token":e.tokens.set(c,t[c]);break}return async function(c,d){if(e.force_authorization)return n(c,d);let u;try{if(u=await d(c),u.ok)return u}catch(h){switch(u.status){case 400:case 401:return n(c,d)}throw h}if(!u.ok)switch(u.status){case 400:case 401:return n(c,d)}return u};async function n(c,d){i();let u=e.tokens.get("access_token");if(u)if(Pe(u)){try{if(!await a())return f.response("false")}catch(h){throw h}return n(c,d)}else return c=f.request(c,{headers:{Authorization:u.type+" "+u.value}}),d(c);else{try{if(!await l())return f.response("false")}catch(h){throw h}return n(c,d)}}function i(){if(typeof window<"u"&&window?.location){let c=f.url(window.location),d,u,h;if(c.searchParams.has("code"))h=c.searchParams,c=c.with({search:""}),history.pushState({},"",c.href);else if(c.hash){let U=c.hash.substr(1);h=new URLSearchParams("?"+U),c=c.with({hash:""}),history.pushState({},"",c.href)}if(h){d=h.get("code"),u=h.get("state");let U=e.state.get("metro/state");if(!u||u!==U)return;d&&e.tokens.set("authorization_code",d)}}}async function l(){if(t.grant_type==="authorization_code"&&!e.tokens.has("authorization_code")){let h=await y();if(!e.callbacks.authorize||typeof e.callbacks.authorize!="function")throw f.metroError("oauth2mw: oauth2 with grant_type:authorization_code requires a callback function in client options.options.callbacks.authorize");let U=await e.callbacks.authorize(h);if(U)e.tokens.set("authorization_code",U);else return!1}let c=g(),d=await e.client.post(c);if(!d.ok){let h=await d.text();throw f.metroError("OAuth2mw: fetch access_token: "+d.status+": "+d.statusText,{cause:c})}let u=await d.json();if(e.tokens.set("access_token",{value:u.access_token,expires:de(u.expires_in),type:u.token_type,scope:u.scope}),u.refresh_token){let h={value:u.refresh_token};e.tokens.set("refresh_token",h)}return u}async function a(){let c=g("refresh_token"),d=await e.client.post(c);if(!d.ok)throw f.metroError("OAuth2mw: refresh access_token: "+d.status+": "+d.statusText,{cause:c});let u=await d.json();if(e.tokens.set("access_token",{value:u.access_token,expires:de(u.expires_in),type:u.token_type,scope:u.scope}),u.refresh_token){let h={value:u.refresh_token};e.tokens.set("refresh_token",h)}else return!1;return u}async function y(){if(!t.authorization_endpoint)throw f.metroError("oauth2mw: Missing options.oauth2_configuration.authorization_endpoint");let c=f.url(t.authorization_endpoint,{hash:""});P(t,{client_id:/.+/,redirect_uri:/.+/,scope:/.*/});let d={response_type:"code",client_id:t.client_id,redirect_uri:t.redirect_uri,state:t.state||Te(40)};return t.response_type&&(d.response_type=t.response_type),t.response_mode&&(d.response_mode=t.response_mode),e.state.set(d.state),t.client_secret&&(d.client_secret=t.client_secret),t.code_verifier&&(d.code_challenge=ne(await Ee(t.code_verifier)),d.code_challenge_method="S256"),t.scope&&(d.scope=t.scope),t.prompt&&(d.prompt=t.prompt),f.url(c,{search:d})}function g(c=null){if(P(t,{client_id:/.+/,redirect_uri:/.+/}),!t.token_endpoint)throw f.metroError("oauth2mw: Missing options.endpoints.token url");let d=f.url(t.token_endpoint,{hash:""}),u={grant_type:c||t.grant_type,client_id:t.client_id};switch(t.code_verifier&&(u.code_verifier=ne(t.code_verifier)),t.client_secret&&(u.client_secret=t.client_secret),t.scope&&(u.scope=t.scope),t.grant_type){case"authorization_code":if(u.redirect_uri=t.redirect_uri,u.code=e.tokens.get("authorization_code"),e.dpop){let h=e.tokens.get("keyPair");u.dpop_jkt=h.publicKey}break;case"client_credentials":break;case"refresh_token":u.refresh_token=t.refresh_token;break;default:throw new Error("Unknown grant_type: ".oauth2.grant_type)}return f.request(d,{method:"POST",body:new URLSearchParams(u)})}}function Pe(e){if(!e)return!0;let r=new Date(e.expires);return new Date().getTime()>r.getTime()}function de(e){if(e instanceof Date)return new Date(e.getTime());if(typeof e=="number"){let r=new Date;return r.setSeconds(r.getSeconds()+e),r}throw new TypeError("Unknown expires type "+e)}function je(e=64){let r=new Uint8Array(e);return globalThis.crypto.getRandomValues(r),r}async function Ee(e){let r=ne(e),o=new TextEncoder().encode(r);return await globalThis.crypto.subtle.digest("SHA-256",o)}function ne(e){let r=Array.from(new Uint8Array(e),t=>String.fromCharCode(t)).join("");return btoa(r).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}function Te(e){let r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",t="",o=0;for(;o<e;)t+=r.charAt(Math.floor(Math.random()*r.length)),o++;return t}function Ze(){let e=new URL(document.location.href);if(!e.searchParams.has("code")){if(e.hash){let r=e.hash.substr(1);if(params=new URLSearchParams("?"+r),params.has("code"))return!0}return!1}return!0}var he={};X(he,{default:()=>Le});var ie={status:200,statusText:"OK",headers:{"Content-Type":"application/json"}},Q=e=>({status:400,statusText:"Bad Request",headers:{"Content-Type":"application/json"},body:JSON.stringify({error:"invalid_request",error_description:e})}),z,ze={};function Le(e={}){return e=Object.assign({},{PKCE:!1,DPoP:!1},e),async(t,o)=>{let n=f.url(t.url);switch(n.pathname){case"/authorize/":if(z=A(n.searchParams,{response_type:"code",client_id:"mockClientId",state:w(/.*/)}))return f.response(Q(z));if(n.searchParams.has("code_challenge")){if(!n.searchParams.has("code_challenge_method"))return f.response(Q("missing code_challenge_method"));ze.code_challenge=n.searchParams.get("code_challenge"),ze.code_challenge_method=n.searchParams.get("code_challenge_method")}return f.response(ie,{body:JSON.stringify({code:"mockAuthorizeToken",state:n.searchParams.get("state")})});case"/token/":if(t.data instanceof URLSearchParams){let y={};t.data.forEach((g,c)=>y[c]=g),t=t.with({body:y})}if(z=A(t,{method:"POST",data:{grant_type:$("refresh_token","authorization_code")}}))return f.response(Q(z));switch(t.data.grant_type){case"refresh_token":if(z=A(t.data,$({refresh_token:"mockRefreshToken",client_id:"mockClientId",client_secret:"mockClientSecret"},{refresh_token:"mockRefreshToken",client_id:"mockClientId",code_verifier:/.+/})))return f.response(Q(z));break;case"access_token":if(z=A(t.data,$({client_id:"mockClientId",client_secret:"mockClientSecret"},{client_id:"mockClientId",code_challenge:/.*/,code_challenge_method:"S256"})))return f.response(Q(z));break}return f.response(ie,{body:JSON.stringify({access_token:"mockAccessToken",token_type:"mockExample",expires_in:3600,refresh_token:"mockRefreshToken",example_parameter:"mockExampleValue"})});case"/protected/":let i=t.headers.get("Authorization"),[l,a]=i?i.split(" "):[];return!a||a!=="mockAccessToken"?f.response({status:401,statusText:"Forbidden",body:"401 Forbidden"}):f.response(ie,{body:JSON.stringify({result:"Success"})});case"/public/":return f.response(ie,{body:JSON.stringify({result:"Success"})});default:return f.response({status:404,statusText:"not found",body:"404 Not Found "+n})}}}var me={};X(me,{default:()=>De});var Ue=["HS256","HS384","HS512","RS256","RS384","RS512","ES256","ES384","ES512"],Ce=["client_secret_post","client_secret_base","client_secret_jwt","private_key_jwt"],Ge={issuer:x(b),authorization_endpoint:x(b),token_endpoint:x(b),jwks_uri:w(b),registration_endpoint:w(b),scopes_supported:Re([]),response_types_supported:x(Oe("code","token")),response_modes_supported:w([]),grant_types_supported:w([]),token_endpoint_auth_methods_supported:w([]),token_endpoint_auth_signing_alg_values_supported:w([]),service_documentation:w(b),ui_locales_supported:w([]),op_policy_uri:w(b),op_tos_uri:w(b),revocation_endpoint:w(b),revocation_endpoint_auth_methods_supported:w(Ce),revocation_endpoint_auth_signing_alg_values_supported:w(Ue),introspection_endpoint:w(b),introspection_endpoint_auth_methods_supported:w(Ce),introspection_endpoint_auth_signing_alg_values_supported:w(Ue),code_challendge_methods_supported:w([])};function De(e={}){let r={client:f.client()};e=Object.assign({},r,e),P(e,{issuer:x(b)});let t=Xe(e.issuer),o=e.client.with(e.issuer)}async function Xe(e,r){let t=r.get(f.url(e,".wellknown/oauth_authorization_server"));if(t.ok){P(t.headers.get("Content-Type"),/application\/json.*/);let o=await t.json();return P(o,Ge),o}throw f.metroError("metro.oidcmw: Error while fetching "+e+".wellknown/oauth_authorization_server",t)}function Y(){return new Promise((e,r)=>{let t=globalThis.indexedDB.open("metro",1);t.onupgradeneeded=()=>t.result.createObjectStore("keyPairs",{keyPath:"domain"}),t.onerror=o=>{r(o)},t.onsuccess=o=>{let n=o.target.result;e({set:function(i,l){return new Promise((a,y)=>{let g=n.transaction("keyPairs","readwrite",{durability:"strict"}),c=g.objectStore("keyPairs");g.oncomplete=()=>{a()},g.onerror=y,c.put(i,l)})},get:function(i){return new Promise((l,a)=>{let y=n.transaction("keyPairs","readonly"),c=y.objectStore("keyPairs").get(i);c.onsuccess=()=>{l(c.result)},c.onerror=a,y.onerror=a})},clear:function(){return new Promise((i,l)=>{let a=n.transaction("keyPairs","readwrite"),g=a.objectStore("keyPairs").clear();g.onsuccess=()=>{i()},g.onerror=l,a.onerror=l})}})}})}var qe=new TextEncoder,et=new TextDecoder;function se(e){return typeof e=="string"?qe.encode(e):et.decode(e)}function Ke(e){if(typeof e.modulusLength!="number"||e.modulusLength<2048)throw new _e(`${e.name} modulusLength must be at least 2048 bits`)}function tt(e){switch(e.algorithm.name){case"ECDSA":return{name:e.algorithm.name,hash:"SHA-256"};case"RSA-PSS":return Ke(e.algorithm),{name:e.algorithm.name,saltLength:32};case"RSASSA-PKCS1-v1_5":return Ke(e.algorithm),{name:e.algorithm.name};case"Ed25519":return{name:e.algorithm.name}}throw new L}async function rt(e,r,t){if(t.usages.includes("sign")===!1)throw new TypeError('private CryptoKey instances used for signing assertions must include "sign" in their "usages"');let o=`${Z(se(JSON.stringify(e)))}.${Z(se(JSON.stringify(r)))}`,n=Z(await crypto.subtle.sign(tt(t),t,se(o)));return`${o}.${n}`}var He=32768;function nt(e){e instanceof ArrayBuffer&&(e=new Uint8Array(e));let r=[];for(let t=0;t<e.byteLength;t+=He)r.push(String.fromCharCode.apply(null,e.subarray(t,t+He)));return btoa(r.join("")).replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_")}function Z(e){return nt(e)}function ot(){return Z(crypto.getRandomValues(new Uint8Array(32)))}var L=class extends Error{constructor(r){super(r??"operation not supported"),this.name=this.constructor.name,Error.captureStackTrace?.(this,this.constructor)}},_e=class extends Error{constructor(r){super(r),this.name=this.constructor.name,Error.captureStackTrace?.(this,this.constructor)}};function it(e){switch(e.algorithm.hash.name){case"SHA-256":return"PS256";default:throw new L("unsupported RsaHashedKeyAlgorithm hash name")}}function st(e){switch(e.algorithm.hash.name){case"SHA-256":return"RS256";default:throw new L("unsupported RsaHashedKeyAlgorithm hash name")}}function at(e){switch(e.algorithm.namedCurve){case"P-256":return"ES256";default:throw new L("unsupported EcKeyAlgorithm namedCurve")}}function ct(e){switch(e.algorithm.name){case"RSA-PSS":return it(e);case"RSASSA-PKCS1-v1_5":return st(e);case"ECDSA":return at(e);case"Ed25519":return"EdDSA";default:throw new L("unsupported CryptoKey algorithm name")}}function Ie(e){return e instanceof CryptoKey}function ut(e){return Ie(e)&&e.type==="private"}function lt(e){return Ie(e)&&e.type==="public"}function ft(){return Math.floor(Date.now()/1e3)}async function ae(e,r,t,o,n,i){let l=e?.privateKey,a=e?.publicKey;if(!ut(l))throw new TypeError('"keypair.privateKey" must be a private CryptoKey');if(!lt(a))throw new TypeError('"keypair.publicKey" must be a public CryptoKey');if(a.extractable!==!0)throw new TypeError('"keypair.publicKey.extractable" must be true');if(typeof r!="string")throw new TypeError('"htu" must be a string');if(typeof t!="string")throw new TypeError('"htm" must be a string');if(o!==void 0&&typeof o!="string")throw new TypeError('"nonce" must be a string or undefined');if(n!==void 0&&typeof n!="string")throw new TypeError('"accessToken" must be a string or undefined');if(i!==void 0&&(typeof i!="object"||i===null||Array.isArray(i)))throw new TypeError('"additional" must be an object');return rt({alg:ct(l),typ:"dpop+jwt",jwk:await dt(a)},{...i,iat:ft(),jti:ot(),htm:t,nonce:o,htu:r,ath:n?Z(await crypto.subtle.digest("SHA-256",se(n))):void 0},l)}async function dt(e){let{kty:r,e:t,n:o,x:n,y:i,crv:l}=await crypto.subtle.exportKey("jwk",e);return{kty:r,crv:l,e:t,n:o,x:n,y:i}}async function Ne(e,r){let t;if(typeof e!="string"||e.length===0)throw new TypeError('"alg" must be a non-empty string');switch(e){case"PS256":t={name:"RSA-PSS",hash:"SHA-256",modulusLength:r?.modulusLength??2048,publicExponent:new Uint8Array([1,0,1])};break;case"RS256":t={name:"RSASSA-PKCS1-v1_5",hash:"SHA-256",modulusLength:r?.modulusLength??2048,publicExponent:new Uint8Array([1,0,1])};break;case"ES256":t={name:"ECDSA",namedCurve:"P-256"};break;case"EdDSA":t={name:"Ed25519"};break;default:throw new L}return crypto.subtle.generateKey(t,r?.extractable??!1,["sign","verify"])}function ye(e){return P(e,{site:x(b),authorization_endpoint:x(b),token_endpoint:x(b)}),async(r,t)=>{let o=await Y(),n=await o.get(e.site);if(!n){let a=await Ne("ES256");n={domain:e.site,keyPair:a},await o.set(n)}let i=f.url(r.url);if(r.url.startsWith(e.authorization_endpoint)||r.url.startsWith(e.token_endpoint)){let a=await ae(n.keyPair,r.url,r.method);r=r.with({headers:{DPoP:a}})}else if(r.headers.has("Authorization")){let a=localStorage.getItem(i.host+":nonce")||void 0,y=r.headers.get("Authorization").split(" ")[1],g=await ae(n.keyPair,r.url,r.method,a,y);r=r.with({headers:{Authorization:"DPoP "+y,DPoP:g}})}let l=await t(r);return l.headers.get("DPoP-Nonce")&&localStorage.setItem(i.host+":nonce",l.headers.get("DPoP-Nonce")),l}}var Je=Object.assign(oe,pe,{mockserver:he,discovery:me,tokenstore:re,dpopmw:ye,keysstore:Y});globalThis.oauth2=Je;var ce=Je;function ge(e){let r;if(typeof localStorage<"u")r={get:t=>JSON.parse(localStorage.getItem("metro/oidc:"+e+":"+t)),set:(t,o)=>localStorage.setItem("metro/oidc:"+e+":"+t,JSON.stringify(o)),has:t=>localStorage.getItem("metro/oidc:"+e+":"+t)!==null};else{let t=new Map;r={get:o=>JSON.parse(t.get("metro/oidc:"+e+":"+o)||null),set:(o,n)=>t.set("metro/oidc:"+e+":"+o,JSON.stringify(n)),has:o=>t.has("metro/oidc:"+e+":"+o)}}return r}function we(e={}){let r={client:f.client(),force_authorization:!1};return e=Object.assign({},r,e),j(e,{client:k(I(f.client().constructor)),client_info:k(),issuer:k(m),oauth2:s({}),openid_configuration:s()}),e.store||(e.store=ge(e.issuer)),!e.openid_configuration&&e.store.has("openid_configuration")&&(e.openid_configuration=e.store.get("openid_configuration")),!e.client_info.client_id&&e.store.has("client_info")&&(e.client_info=e.store.get("client_info")),async(t,o)=>{let n;if(!e.force_authorization){try{n=await o(t)}catch(d){if(n.status!=401&&n.status!=403)throw d}if(n.ok||n.status!=401&&n.status!=403)return n}if(e.openid_configuration||(e.openid_configuration=await V({issuer:e.issuer}),e.store.set("openid_configuration",e.openid_configuration)),!e.client_info?.client_id){if(j(e.client_info?.client_name,k()),!e.openid_configuration.registration_endpoint)throw f.metroError("metro.oidcmw: Error: issuer "+e.issuer+" does not support dynamic client registration, but you haven't specified a client_id");e.client_info=await W({registration_endpoint:e.openid_configuration.registration_endpoint,client_info:e.client_info}),e.store.set("client_info",e.client_info)}let i=e.scope||"openid",l=Object.assign({site:e.issuer,client:e.client,force_authorization:!0,oauth2_configuration:{client_id:e.client_info.client_id,client_secret:e.client_info.client_secret,grant_type:"authorization_code",response_type:"code",response_mode:"query",authorization_endpoint:e.openid_configuration.authorization_endpoint,token_endpoint:e.openid_configuration.token_endpoint,scope:i,redirect_uri:e.client_info.redirect_uris[0]}}),a={site:e.issuer,authorization_endpoint:e.openid_configuration.authorization_endpoint,token_endpoint:e.openid_configuration.token_endpoint,dpop_signing_alg_values_supported:e.openid_configuration.dpop_signing_alg_values_supported},y=async(d,u)=>{let h=await u(d);if(h.headers.get("content-type")?.startsWith("application/json")){let Fe=h.clone();try{let G=await Fe.json();G&&G.id_token&&e.store.set("id_token",G.id_token)}catch{}}return h},g=e.client.with(e.issuer).with(y).with(ce.dpopmw(a));return l.client=g,n=await g.with(ce(l)).fetch(t),n}}function Me(){return ce.isRedirected()}function Be(e){return e.store.get("id_token")}var pt=Object.assign(we,{discover:V,register:W,isRedirected:Me,idToken:Be});globalThis.oidc=pt;})();
//# sourceMappingURL=browser.min.js.map
